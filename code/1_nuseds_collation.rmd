---
title: "1_nuseds_collation"
author: "Bruno S. Carturan, Eric Hertz, Stephanie J. Peacock"
date: "2025-01-24"
output: 
  html_document:
    toc: true                  # Adds a table of contents to the document
    toc_float: true           # Makes the table of contents float on the side as the reader scrolls.
    toc_collapsed: true        # Starts the table of contents in a collapsed state.
    toc_depth: 3               # Specifies the depth of headers (e.g., ##, ###) to include in the table of contents.
    number_sections: true      # 
    theme: journal  # lumen
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

The goal of the script is to merge the two constituent datasets **all_areas_nuseds** (referred to as **NUSEDS**) and **conservation_unit_system_sites** (referred to as **CUSS**) so each time series in **NUSEDS** (i.e., fish counts associated to a unique populations, characterized by a unique `IndexId`/`POP_ID` & `GFE_ID` association) can be attributed to a unique conservation unit (CU) in **CUSS** (characterized by `CU_NAME` and `FULL_CU_IN`). But there are multiple inconsistencies between the two datasets that lead to discard a significant amount of data points in **NUSEDS**, unless fixes are implemented. This script is a attempt to implement such fixes.

The dataset version corresponding to this script is:

Fisheries and Oceans Canada. 2024. NuSEDS - New Salmon Escapement Database System. Pacific Biological Station. Retrieved January 22, 2024, from <https://open.canada.ca/data/en/dataset/c48669a3-045b-400d-b730-48aafe8c5ee6>.

```{r, include = F}

#'******************************************************************************
#' The goal of the script is to import, clean and format NuSEDS data.
#' Script based on Emma Atkinson's previous version (26-Mar-2019).
#' 
#' Files imported:
#' - conservationunits_decoder.csv (from database)
#' - streamlocationids.csv (from database)
#' - all_areas_nuseds_DATE.csv (from DFO)
#' - conservation_unit_system_sites_DATE.csv (from DFO)
#' - nuseds_report_definitions.csv (from DFO)
#' - conservation_unit_report_definitions.csv (from DFO)
#' - DFO_GFE_IDs_list_1.xlsx (from Wu Zhipeng, DFO)
#' - DFO_GFE_IDs_list_2.xlsx (from Wu Zhipeng, DFO)
#' 
#' Files produced: 
#' - 1_all_areas_nuseds_cleaned_DATE.csv
#' - 1_conservation_unit_system_sites_cleaned_DATE.csv
#' - 1_NuSEDS_escapement_data_collated_DATE.csv         # the merged and further corrected all_areas_nuseds and conservation_unit_system_sites
#' - 1_series_inNUSEDS_noInCUSS_DATE.csv                # series removed because no alternative series could be found in conservation_unit_system_sites; to investigate later may be
#' - 1_series_removed_DATE.csv                          # series removed from either datasets and why
#' - 1_series_added_DATE.csv                            # series added to either dataset and why
#' - log_file.csv                                     # the log file containing the name of the orginak NUSEDS and CUSS files imported and the information about 0s being removed or not.

#'******************************************************************************


rm(list = ls())
graphics.off()

# Loading packages & functions
library(tidyr)
library(plyr)
library(dplyr)
library(readxl)
library(parallel)
library(sf)
library(sp)     # to calculate distances from geo-spatial coordinates
library(scales)

wd <- gsub("/code","",getwd())
wd_code <- paste0(wd,"/code")
wd_data_input <- paste0(wd,"/data_input")
wd_data_output <- paste0(wd,"/data_output")

source(paste0(wd_code,"/functions.R"))

options(digits = 9)


#'* !!! DECISIONS TO MAKE !!! *

# Set to true to update the datasets
export_datasets <- F

# Decision in ## Remove the IndexId & GFE_ID time series in NUSEDS with only NAs and/or 0s
# If TRUE, time series only composed of NAs and/or 0s are removed from NUSEDS; 
# If FALSE, time series only composed of NAs are removed from NUSEDS.
# KEEP IT AS FALSE TO REPRODUCE THE SAME DATASETS
remove_timeSeries_zeros_too <- F

# Used just after NUSEDS and CUSS are merged: to decide if we want to replace
# all the remaining 0s by NAs.
replace_zeros_byNAs <- F

# To avoid having to wait too much time when executing the code multiple times.
# Should be set to FALSE by default.
import_file_locally_TEMPORARY <- T

# To prevent different locations (with different GFE_ID) to have exactly the same coordinates
update_coordinates <- T

```

# Import datasets

The **NUSEDS** (all_areas_nuseds) and **CUSS** (conservation_unit_system_sites) datasets are imported and duplicated rows are removed. The columns considered for NuSEDS are related to the population, location, fish counts and year of assessment:

```{r,echo=FALSE}
#'* Import the all_areas_nuseds data ("NUSEDS) *
all_areas_nuseds <- import_mostRecent_file_fun(wd = wd_data_input, 
                                               pattern = "all_areas_nuseds",
                                               pattern_exclude = "noNA")
```

```{r, echo=FALSE}
#'* Import conservation_unit_system_sites ("CUSS") *
# DFO provided files matching streams and Nuseds to full CU index 

#' TODO if not in /data_input: to download at https://zenodo.org/records/14248904
conservation_unit_system_sites <- import_mostRecent_file_fun(wd = wd_data_input, 
                                                             pattern = "conservation_unit_system_sites")

# Add column coordinates_changed in case coordinates are added (if missing) or modified
conservation_unit_system_sites$coordinates_changed <- F
```

```{r, include=FALSE}
#'* Import the definition of the different fields of these two datasets *
fields_def <- nuseds_fields_definitions_fun(wd_references = wd_data_input)
# fields_def$all_areas_nuseds$AREA
# fields_def$cu_system_sites$IS_INDICATOR

#'* Import list for the fields in NUSEDS and CUSS that are associated to unique IndexId and GFE_ID *
#' IndexId is define below as the species acronym + _ + POP_ID
#' Those are used to updated all the columns/fields in NUSEDS and CUSS when adding
#' or updating a population. 
fields_l <- fields_IndexId_GFE_ID_fun(all_areas_nuseds = all_areas_nuseds,
                                      conservation_unit_system_sites = conservation_unit_system_sites)

# fields_l$NUSEDS$IndexId

#'* Create a dataframe with the species names and the different acronymes *
sp_salmon_detail <- c("Chum", "Chinook", "Coho", "Pink even","Pink odd","Sockeye lake","Sockeye river")
sp_salmon <-        c("Chum", "Chinook", "Coho", "Pink","Pink","Sockeye","Sockeye")
sp_salmon_acro <-     c("CM", "CK", "CO", "PKE", "PKO", "SEL", "SER")
sp_salmon_acro_ncc <- c("CM", "CN", "CO", "PKE", "PKO",  "SX",  "SX")  # SpeciesId ; NCC Salmon Database (NCCSDB) Designation 

sp_salmon_names_acro_df <- data.frame(name = sp_salmon,
                                      name_detail = sp_salmon_detail,
                                      acronym = sp_salmon_acro,
                                      acronym_ncc = sp_salmon_acro_ncc)
```

The list of conservation units (CUs) as shown in the Pacific Salmon Explorer ([PSE](https://www.salmonexplorer.ca/)) is imported. The columns `cu_name_pse` and `cu_name_dfo` correspond to `CU_NAME` in **CUSS**, `cu_index` corresponds to `FULL_CU_INDEX`.

```{r, include=FALSE}
#'* Import the PSE list of CUs (conservationunits_decoder) *
#' TODO if not in /data_input: to download at https://zenodo.org/records/14248904
conservationunits_decoder <- read.csv(paste0(wd_data_input,"/conservationunits_decoder.csv"), 
                                      header = T)

colnames(conservationunits_decoder)[colnames(conservationunits_decoder) == "species_abbr"] <- "species_qualified"

# temporary fix to do (until the source file is corrected)
d_fixes <- data.frame(cuid = c(528,756,758,759,760,761,763,1022),
                      cu_index_old = c("SX_528","","","","","","","SER-023"),
                      cu_index_new = c("SEL-16-01","SEL-03-07","SEL-05-01","SEL-06-19",
                                       "SEL-09-04","SEL-09-05","SEL-10-02","SER-23"))

for(r in 1:nrow(d_fixes)){
  cuid <- d_fixes$cuid[r]
  cu_index_new <- d_fixes$cu_index_new[r]
  cond <- conservationunits_decoder$cuid == cuid
  conservationunits_decoder$cu_index[cond] <- cu_index_new
}

d_fixes
```

```{r, echo=FALSE}
head(conservationunits_decoder[,c("region","species_name","species_qualified","cuid","cu_name_pse","cu_name_dfo","cu_index")])
```

The DFO file of the stream locations and coordinates (emailed from Wu Zhipeng, DFO, 09/04/2024) is imported. The columns `NME` and `ID` correspond to `SYSTEM_SITE` and `GFE_ID` in CUSS, respectively.

```{r, echo=FALSE}

#'* Import the stream - GFE_ID data file from DFO *
#' (emailed from Wu Zhipeng, DFO, 09/04/2024)
#' There are different locations in the 2nd first sheets to we combine them into a unique dataframe
#' TODO if not in /data_input: to download at https://zenodo.org/records/14248904
DFO_All_Streams_Segments <- read_xlsx(paste0(wd_data_input,"/DFO_All_Streams_Segments_20240408.xlsx"),
                                      sheet = "All Streams")

DFO_All_Streams_Segments2 <- read_xlsx(paste0(wd_data_input,"/DFO_All_Streams_Segments_20240408.xlsx"),
                                      sheet = "Stream Segments")

columns <- c("NME","ID","X_LONGT","Y_LAT")
DFO_All_Streams_Segments <- rbind(DFO_All_Streams_Segments[,columns],
                                  DFO_All_Streams_Segments2[,columns]
                                  # DFO_All_Streams_Segments3[,columns],
                                  # DFO_All_Streams_Segments4[,columns]
                                  )
DFO_All_Streams_Segments <- unique(DFO_All_Streams_Segments)

rm(DFO_All_Streams_Segments2)
head(DFO_All_Streams_Segments)
```

The DFO hatchery data file (emailed from Brock Ramshaw, DFO, 03/07/2023) is imported because it contains `GFE_ID` (i.e., `STOCK_GFE_ID` and `REL_GFE_ID`) and coordinates that are missing in the above DFO stream location file:

```{r, include=FALSE}
#'* Import DFO's Hatchery dataset * 
# because there are coordinates available there for
# certain GFE_ID that are not in DFO_All_Streams_Segments
#' TODO if not in /data_input: to download at https://zenodo.org/records/14248904
DFO_hatchery <- read_xlsx(paste0(wd_data_input,"/PSF_modified_SEP_releases_2023.xlsx"),
                         sheet = 1)

DFO_hatchery1 <- DFO_hatchery[,c("STOCK_GFE_ID","STOCK_WATERBODY_NAME","STOCK_LATITUDE","STOCK_LONGITUDE")]

cond_NA <- is.na(DFO_hatchery1$STOCK_GFE_ID) | 
  is.na(DFO_hatchery1$STOCK_LATITUDE) |
  is.na(DFO_hatchery1$STOCK_LONGITUDE)
DFO_hatchery1 <- DFO_hatchery1[!cond_NA,]
DFO_hatchery1$STOCK_LATITUDE <- round(DFO_hatchery1$STOCK_LATITUDE,6)
DFO_hatchery1$STOCK_LONGITUDE <- round(DFO_hatchery1$STOCK_LONGITUDE,6)
DFO_hatchery1 <- unique(DFO_hatchery1)
nrow(DFO_hatchery1) # 535

DFO_hatchery2 <- DFO_hatchery[,c("REL_GFE_ID","REL_WATERBODY_NAME","REL_LATITUDE","REL_LONGITUDE")]
DFO_hatchery2 <- DFO_hatchery2[!is.na(DFO_hatchery2$REL_GFE_ID),]
DFO_hatchery2$REL_LATITUDE <- round(DFO_hatchery2$REL_LATITUDE,6)
DFO_hatchery2$REL_LONGITUDE <- round(DFO_hatchery2$REL_LONGITUDE,6)
DFO_hatchery2 <- unique(DFO_hatchery2)
nrow(DFO_hatchery2) # 1423

sum(duplicated(DFO_hatchery1$STOCK_GFE_ID)) # 19
sum(duplicated(DFO_hatchery2$REL_GFE_ID)) # 87

GFE_ID_dupli <- unique(DFO_hatchery1$STOCK_GFE_ID[duplicated(DFO_hatchery1$STOCK_GFE_ID)])
d <- DFO_hatchery1[DFO_hatchery1$STOCK_GFE_ID %in% GFE_ID_dupli,]
d <- d[order(d$STOCK_GFE_ID),]

rm(DFO_hatchery1)
rm(DFO_hatchery2)
rm(d)

#' There are inconsistencies and I do not want to spend too much time fixing them,
#' so I won't merge DFO_hatchery with DFO_All_Streams_Segments.
```

```{r,echo=FALSE}
head(DFO_hatchery[,c("STOCK_GFE_ID","STOCK_WATERBODY_NAME","STOCK_LATITUDE","STOCK_LONGITUDE",
                     "REL_GFE_ID","REL_WATERBODY_NAME","REL_LATITUDE","REL_LONGITUDE")])
```

The regions and CUs shape files as defined in the PSE are imported:

```{r, include=FALSE}

#'* Import the shape files for the Region boundaries *
#' TODO if not in /data_input: to download at https://zenodo.org/records/14248904
#' 
#' Note that se_boundary/se_boundary.shp is used in 0_assign-regions.R. This is a
#' lighter shape file but contains the same regions. The code here works with 
#' se_boundary.shp.

regions_shp <- st_read(paste0(wd_data_input,"/se_boundary_regions/se_boundary_regions.shp")) %>%
  st_transform(crs = 4269)
unique(regions_shp$regionname)

sf_use_s2(FALSE) # so that st_intersects() and st_simplify() can be used

regions_shp_full <- regions_shp
regions_shp <- st_simplify(x = regions_shp, dTolerance = .002) # .001 # to reduce computation time

# plot(st_geometry(regions_shp_full[1,]))
# plot(st_geometry(regions_shp[1,]))


#'* Import the geodatabase for the CU boundaries  *
#' TODO if not in /data_input: to download at https://zenodo.org/records/14248904

CUs_gdb <- st_read(paste0(wd_data_input,"/pse_conservation_units/pse_conservation_units.gdb")) %>%
  st_transform(crs = 4269)
head(CUs_gdb)
unique(CUs_gdb$species)
unique(CUs_gdb$region)

CUs_gdb_full <- CUs_gdb      
CUs_gdb <- st_simplify(x = CUs_gdb_full, dTolerance = .002) # to reduce computation time

# plot(st_geometry(CUs_gdb_full[1,]))
# plot(st_geometry(CUs_gdb[1,]), add = F)
```


```{r, echo=FALSE}
regions_shp
```

```{r, echo=FALSE}
head(CUs_gdb)
```

# Initial modifications

```{r, include=FALSE}

#'* Remove rows for Atlantic, Steelhead, and Kokanee *

row_remove <- all_areas_nuseds$SPECIES %in% c("Steelhead","Atlantic","Kokanee")
nb_rows_NUSEDS <- sum(row_remove)
nb_rows_NUSEDS # 967

nb_POP_ID_NUSEDS <- length(unique(all_areas_nuseds$POP_ID[row_remove]))
nb_POP_ID_NUSEDS # 133

all_areas_nuseds <- all_areas_nuseds[!row_remove,]


row_remove <- !conservation_unit_system_sites$SPECIES_QUALIFIED %in% c("CK","CO","PKE","PKO","CM","SEL","SER")
nb_rows_CUSS <- sum(row_remove)
nb_POP_ID_CUSS <- length(unique(conservation_unit_system_sites$POP_ID[row_remove]))

conservation_unit_system_sites <- conservation_unit_system_sites[!row_remove,]

```

We remove from **NUSEDS** and **CUSS** data related to steelhead, Atlantic salmon and Kokanee salmon, corresponding to `r nb_rows_NUSEDS` rows and `r nb_POP_ID_NUSEDS` populations (`POP_ID`) in **NUSEDS** and `r nb_rows_CUSS` in **CUSS**.

```{r, include=FALSE}

#'* Rename the year column *
colnames(all_areas_nuseds)[colnames(all_areas_nuseds) == "ANALYSIS_YR"] <- "Year"

#'* Add the field SPECIES to CUSS *
conservation_unit_system_sites$SPECIES <- NA
species <- c("Coho","Chinook","Pink","Pink","Chum","Sockeye","Sockeye")
sp_acronym_q <- c("CO","CK","PKE","PKO","CM","SEL","SER")
for(spq in sp_acronym_q){
  # spq <- sp_acronym_q[1]
  condition <- conservation_unit_system_sites$SPECIES_QUALIFIED == spq
  sp_Here <- unique(species[spq == sp_acronym_q])
  conservation_unit_system_sites$SPECIES[condition] <- sp_Here
}
unique(conservation_unit_system_sites$SPECIES)


#'* Create the field "species_acronym_ncc"to NUSEDS *
#' i.e., CN, SX instead of CK and SER or SEL in the SPECIES_QUALIFIED.
#' There is no information about sockeye river vs. lake in NUSEDS, 
#' contrary to in conservation_unit_system_sites. We consequently have to create
#' the field species_acronym_ncc in both dataset to be able to merge them after.
#' (Note that there is information about the rearing locations the fieldsWATERBODY,
#' GAZETTED_NAME, LOCAL_NAME_1, LOCAL_NAME_2, POPULATION).
all_areas_nuseds$species_acronym_ncc <- conservation_unit_system_sites$species_acronym_ncc <- NA
species <- c("Coho","Chinook","Pink","Chum","Sockeye")
species_acronym_ncc <- c("CO","CN","PK","CM","SX")
for(sp in species){
  # sp <- species[3]
  sp_acroHere <- species_acronym_ncc[sp == species]
  condition <- all_areas_nuseds$SPECIES == sp
  all_areas_nuseds$species_acronym_ncc[condition] <- sp_acroHere
  condition <- conservation_unit_system_sites$SPECIES == sp
  conservation_unit_system_sites$species_acronym_ncc[condition] <- sp_acroHere
  
  # For Pink, add E and O for Even and Odd, respectively
  if(sp == "Pink"){
    all_areas_nuseds$species_acronym_ncc[all_areas_nuseds$SPECIES == sp & 
                                           all_areas_nuseds$Year %% 2 == 0] <- "PKE"
    all_areas_nuseds$species_acronym_ncc[all_areas_nuseds$SPECIES == sp & 
                                           all_areas_nuseds$Year %% 2 != 0] <- "PKO"
    
    condition <- conservation_unit_system_sites$SPECIES_QUALIFIED == "PKE"
    conservation_unit_system_sites$species_acronym_ncc[condition] <- "PKE"
    
    condition <- conservation_unit_system_sites$SPECIES_QUALIFIED == "PKO"
    conservation_unit_system_sites$species_acronym_ncc[condition] <- "PKO"
  }
}
unique(all_areas_nuseds$species_acronym_ncc)
unique(conservation_unit_system_sites$species_acronym_ncc)

```

We create the column `IndexId`, which the the combination of the species acronym (i.e., CO, CM, CN, PKO, PKE, SX) and `POP_ID`:

```{r,echo=FALSE}
#' * Add the field IndexId = species_acronym_ncc + POP_ID *
all_areas_nuseds$IndexId <- paste(all_areas_nuseds$species_acronym_ncc,
                                  all_areas_nuseds$POP_ID,sep = "_")

conservation_unit_system_sites$IndexId <- paste(conservation_unit_system_sites$species_acronym_ncc,
                                                conservation_unit_system_sites$POP_ID,sep = "_")

head(unique(conservation_unit_system_sites$IndexId))
```

```{r, include=F}

# The filed Returns is not used but we keep the code just in case.

#'* Determine "Returns" (i.e. number fish) in NUSEDS (NOT USED - TO REMOVED?) *
#' "Return" will be the column that contains the final fish count. Priority of the
#' fields to population Returns:
#'1) NATURAL_ADULT_SPAWNERS, if not available:
#'2) sum of 
#'  - NATURAL_SPAWNERS_TOTAL
#'  - ADULT_BROODSTOCK_REMOVALS (or TOTAL_BROODSTOCK_REMOVALS if not available)
#'  - OTHER_REMOVALS
#'3) TOTAL_RETURN_TO_RIVER

# Add "Return" which will contain the final number of fish
all_areas_nuseds$Returns <- all_areas_nuseds$NATURAL_ADULT_SPAWNERS         # All salmon that have reached maturity, excluding jacks (jacks are salmon that have matured at an early age).
all_areas_nuseds$Source <- "NATURAL_ADULT_SPAWNERS"                        # this field will change below depending on data availability and origin
NATURAL_ADULT_SPAWNERS_any <- !is.na(all_areas_nuseds$NATURAL_ADULT_SPAWNERS)
all_areas_nuseds$Source[!NATURAL_ADULT_SPAWNERS_any] <- NA

#' Define the sum of:
#' - "Spawner" = NATURAL_SPAWNERS_TOTAL +
#' - "Broodstock" = ADULT_BROODSTOCK_REMOVALS (or TOTAL_BROODSTOCK_REMOVALS if not available) + 
#' - "Removals" = OTHER_REMOVALS

# Spawners:
all_areas_nuseds$Spawners <- all_areas_nuseds$NATURAL_SPAWNERS_TOTAL
spawners_any <- !is.na(all_areas_nuseds$Spawners)
all_areas_nuseds$SpawnersSource[!NATURAL_ADULT_SPAWNERS_any & spawners_any] <- "NATURAL_SPAWNERS_TOTAL"

# Broodstock:
all_areas_nuseds$Broodstock <- all_areas_nuseds$ADULT_BROODSTOCK_REMOVALS
ADULT_BROODSTOCK_REMOVALS_any <- !is.na(all_areas_nuseds$ADULT_BROODSTOCK_REMOVALS)
TOTAL_BROODSTOCK_REMOVALS_any <- !is.na(all_areas_nuseds$TOTAL_BROODSTOCK_REMOVALS)
toReplace <- !ADULT_BROODSTOCK_REMOVALS_any & TOTAL_BROODSTOCK_REMOVALS_any
all_areas_nuseds$Broodstock[toReplace] <- all_areas_nuseds$TOTAL_BROODSTOCK_REMOVALS[toReplace]
all_areas_nuseds$BroodstockSource[!NATURAL_ADULT_SPAWNERS_any & ADULT_BROODSTOCK_REMOVALS_any] <- 'ADULT_BROODSTOCK_REMOVALS'
all_areas_nuseds$BroodstockSource[toReplace] <- 'TOTAL_BROODSTOCK_REMOVALS'

# Removals:
all_areas_nuseds$Removals <- all_areas_nuseds$OTHER_REMOVALS
OTHER_REMOVALS_any <- !is.na(all_areas_nuseds$OTHER_REMOVALS)
all_areas_nuseds$RemovalsSource[!NATURAL_ADULT_SPAWNERS_any & OTHER_REMOVALS_any] <- "OTHER_REMOVALS"

# Calculate Returns when !NATURAL_ADULT_SPAWNERS_any as the sum of what other 
# sources of data is available:
all_areas_nuseds$Returns[!NATURAL_ADULT_SPAWNERS_any] <- apply(
  X = all_areas_nuseds[!NATURAL_ADULT_SPAWNERS_any, c("Spawners","Broodstock","Removals")],
  MARGIN = 1, 
  FUN = sum, 
  na.rm = TRUE
)

all_areas_nuseds$Source[!NATURAL_ADULT_SPAWNERS_any] <- apply(
  X = all_areas_nuseds[!NATURAL_ADULT_SPAWNERS_any,c("SpawnersSource","BroodstockSource","RemovalsSource")], 
  MARGIN = 1, 
  FUN = function(x){
    paste(na.omit(x),collapse=" + ")}
)

# Set as NA rather than zero if no info in any column (the na.rm = T above produced)
# 0s when only NAs were available).
allNAs <- apply(
  X = all_areas_nuseds[!NATURAL_ADULT_SPAWNERS_any, c("Spawners","Broodstock","Removals")],
  MARGIN = 1, 
  FUN = function(x){all(is.na(x))}
) 
all_areas_nuseds$Returns[!NATURAL_ADULT_SPAWNERS_any][allNAs] <- NA

# Use TOTAL_RETURN_TO_RIVER if we still don't have a value
returns_any <- !is.na(all_areas_nuseds$Returns)
TOTAL_RETURN_TO_RIVER_any <- !is.na(all_areas_nuseds$TOTAL_RETURN_TO_RIVER)
toReplace <- !returns_any & TOTAL_RETURN_TO_RIVER_any
all_areas_nuseds$Returns[toReplace] <- all_areas_nuseds$TOTAL_RETURN_TO_RIVER[toReplace]
all_areas_nuseds$Source[toReplace] <- "TOTAL_RETURN_TO_RIVER"
```

```{r, include=FALSE, warning=FALSE}
#'* Determine "MAX_ESTIMATE" in NUSEDS *

#' MAX_ESTIMATE is the maximum estimate of all these fields:
var_in_MAX_ESTIMATE <- c("NATURAL_ADULT_SPAWNERS", 
                         "NATURAL_JACK_SPAWNERS", 
                         "NATURAL_SPAWNERS_TOTAL", 
                         "ADULT_BROODSTOCK_REMOVALS", 
                         "JACK_BROODSTOCK_REMOVALS",
                         "TOTAL_BROODSTOCK_REMOVALS",    
                         "OTHER_REMOVALS", 
                         "TOTAL_RETURN_TO_RIVER")

all_areas_nuseds$MAX_ESTIMATE <- apply(all_areas_nuseds[,var_in_MAX_ESTIMATE], 1,
                                       max, na.rm = TRUE)

# Replace infinite values by NA
all_areas_nuseds$MAX_ESTIMATE[is.infinite(all_areas_nuseds$MAX_ESTIMATE)] <- NA
```

We create the column `MAX_ESTIMATE` which is the maximum value of the fish count columns:

```{r,echo=FALSE}
var_in_MAX_ESTIMATE
```

# Fixes on NUSEDS and CUSS

```{r, include=F}
all_areas_nuseds_all <- all_areas_nuseds
nrow(all_areas_nuseds_all) # 415290

conservation_unit_system_sites_all <- conservation_unit_system_sites
nrow(conservation_unit_system_sites_all) # 7145
```

```{r, include=FALSE}
GFE_ID_IndexId_NUSEDS <- unique(all_areas_nuseds_all[,c("IndexId","GFE_ID")])
nrow(GFE_ID_IndexId_NUSEDS) # 11568

GFE_ID_IndexId_CUSS <- unique(conservation_unit_system_sites_all[,c("IndexId","GFE_ID")])
nrow(GFE_ID_IndexId_CUSS) # 7145

GFE_ID_IndexId_NUSEDS_collapse <- apply(GFE_ID_IndexId_NUSEDS,1, paste, collapse = "_")
GFE_ID_IndexId_NUSEDS_collapse <- gsub(" ","",GFE_ID_IndexId_NUSEDS_collapse)

GFE_ID_IndexId_CUSS_collapse <- apply(GFE_ID_IndexId_CUSS,1, paste, collapse = "_")
GFE_ID_IndexId_CUSS_collapse <- gsub(" ","",GFE_ID_IndexId_CUSS_collapse)

sum(!GFE_ID_IndexId_NUSEDS_collapse %in% GFE_ID_IndexId_CUSS_collapse) # 4428
sum(!GFE_ID_IndexId_CUSS_collapse %in% GFE_ID_IndexId_NUSEDS_collapse) # 5
```

The major issue in NuSEDS is the discrepancy between the two datasets. Normally, there should be the same population references (i.e., unique `IndexId`/`POP_ID` & `GFE_ID` combinations). But there are `r nrow(GFE_ID_IndexId_NUSEDS)` unique population references in **NUSEDS** and only `r nrow(GFE_ID_IndexId_CUSS)` in **CUSS**. Additionally, there are `r sum(!GFE_ID_IndexId_NUSEDS_collapse %in% GFE_ID_IndexId_CUSS_collapse)` references in **NUSEDS** that are not in **CUSS** and `r sum(!GFE_ID_IndexId_CUSS_collapse %in% GFE_ID_IndexId_NUSEDS_collapse)` that are in **CUSS** but not in **NUSEDS**. This section consists in solving these discrepancies so that the same population references are present in both datasets.

## Duplicated rows

```{r, echo=FALSE}
cols_NuSEDS <- c("SPECIES","POP_ID","GFE_ID","Year",
                 "NATURAL_ADULT_SPAWNERS","NATURAL_JACK_SPAWNERS",
                 "NATURAL_SPAWNERS_TOTAL","ADULT_BROODSTOCK_REMOVALS",
                 "JACK_BROODSTOCK_REMOVALS","TOTAL_BROODSTOCK_REMOVALS",
                 "OTHER_REMOVALS","TOTAL_RETURN_TO_RIVER")
```

```{r, include=FALSE}
dupli <- duplicated(all_areas_nuseds[,cols_NuSEDS])
```

There are `r sum(dupli)` duplicated rows in **NUSEDS** when considering the following fields:

```{r, echo=FALSE}
cols_NuSEDS
```

```{r, echo=FALSE}
show <- all_areas_nuseds[dupli,c("SPECIES","POP_ID","GFE_ID","Year","MAX_ESTIMATE")] |>
  arrange(POP_ID,Year)

show
```

These duplicated rows in **NUSEDS** are removed.

```{r, include=FALSE}
toRemove_r <- which(dupli)
all_areas_nuseds <- all_areas_nuseds[-toRemove_r,]
```

```{r, include=FALSE}
dupli <- duplicated(conservation_unit_system_sites)
```

For **CUSS**, `r sum(dupli)` duplicated rows are found:

```{r, echo=FALSE}
toRemove_r <- which(dupli)
show <- conservation_unit_system_sites[toRemove_r,]
rownames(show) <- NULL
show
```

These rows (if any) are removed as well.

```{r, include=FALSE}
conservation_unit_system_sites[-toRemove_r,]
```

## Conflictual counts in NUSEDS

```{r, include=FALSE}
# check if there are years for which there are more than one MAX_ESTIMATE value
# for a given population:
show <- unique(all_areas_nuseds[,c("IndexId","GFE_ID","Year","MAX_ESTIMATE")])

show$pop_yr <- paste(show$IndexId,show$GFE_ID,show$Year,sep = "-")

dupli <- duplicated(show$pop_yr)
pop_yr_dupli <- show$pop_yr[which(dupli)]
```

There are `r length(pop_yr_dupli)` instances where multiple `MAX_ESTIMATE` values are available in a same `Year` for a given population:

```{r, echo=FALSE}
cond <- show$pop_yr %in% pop_yr_dupli
show <- show[cond,]
rownames(show) <- NULL

show[,c("IndexId","GFE_ID","Year","MAX_ESTIMATE")]
```

For each of these cases, we keep the observation with the maximum `MAX_ESTIMATE` value and remove the other(s) from **NUSEDS**:

```{r,echo=FALSE}

# print("Rows removed from NUSEDS:")

for(x in pop_yr_dupli){
  # x <- pop_yr_dupli[1]
  val <- strsplit(x = x, split = "-")[[1]]
  IndexId <- val[1]
  GFE_ID <- val[2]
  Year <- val[3]
  
  cond_nuseds <- all_areas_nuseds$IndexId == IndexId &
    all_areas_nuseds$GFE_ID == GFE_ID &
    all_areas_nuseds$Year == Year
  
  # which one to keep
  cond_show <- show$IndexId == IndexId &
    show$GFE_ID == GFE_ID &
    show$Year == Year
  
  cond_keep <- show$MAX_ESTIMATE[cond_show] == max(show$MAX_ESTIMATE[cond_show])
  MAX_ESTIMATE_keep <-  show$MAX_ESTIMATE[cond_keep]
  
  #
  cond_nuseds_remove <- cond_nuseds & 
    all_areas_nuseds$MAX_ESTIMATE != MAX_ESTIMATE_keep &
    !is.na(all_areas_nuseds$MAX_ESTIMATE)
  
  cond_nuseds_keep <- cond_nuseds & 
    all_areas_nuseds$MAX_ESTIMATE == MAX_ESTIMATE_keep &
    !is.na(all_areas_nuseds$MAX_ESTIMATE)
  
  
  to_print_r <- all_areas_nuseds[cond_nuseds_remove,c("IndexId","GFE_ID","Year","MAX_ESTIMATE","ESTIMATE_CLASSIFICATION","ESTIMATE_METHOD")]
  to_print_r$remove <- T
  to_print_k <- all_areas_nuseds[cond_nuseds_keep,c("IndexId","GFE_ID","Year","MAX_ESTIMATE","ESTIMATE_CLASSIFICATION","ESTIMATE_METHOD")]
  to_print_k$remove <- F
  to_print <- rbind(to_print_r,to_print_k)
  rownames(to_print) <- NULL
  print(to_print)
  
  # remove from NUSEDS
  all_areas_nuseds <- all_areas_nuseds[!cond_nuseds_remove,]
}

```

## Remove the IndexId & GFE_ID time series in NUSEDS with only NAs and/or 0s

We remove these time series to reduce the amount of cleaning to do after. There is the option to remove series with (1) only NAs and 0s or (2) only NAs.

Decision made:

```{r,echo=FALSE}
if(remove_timeSeries_zeros_too){
  print("Time series uniqually made of both NAs and 0s are removed.")
}else{
  print("Time series uniqually made of NAs are removed (those also containing 0s are kept).")
}
```

```{r, include=FALSE}
nrow_before <- nrow(all_areas_nuseds)
#' TODO if import_file_locally_TEMPORARY is TRUE and all_areas_nuseds_noNA0s_TEMP.csv
#' or all_areas_nuseds_noNAs_TEMP.csv is not in /data_input: to download at https://zenodo.org/records/14248904
#' 
#' if import_file_locally_TEMPORARY is FALSE --> process takes time

# If all_areas_nuseds without NAs and 0s already produced; to save time
if(import_file_locally_TEMPORARY){
  
  if(remove_timeSeries_zeros_too){
      all_areas_nuseds <- read.csv(paste0(wd_data_input,"/all_areas_nuseds_noNA0s_TEMP.csv"),
                                   header = T)
  }else{
      all_areas_nuseds <- read.csv(paste0(wd_data_input,"/all_areas_nuseds_noNAs_TEMP.csv"),
                                   header = T)
  }
  
}else{
  # Use package parallel To optimize the (take up to 20 minutes otherwise)
  # detectCores()
  # detectCores(logical = FALSE)
  cores_nb <- 10
  
  # Note: Passing remove_timeSeries_zeros_too as an argument in remove_series_nodata_nuseds_parallel_fun(zeros_too = ) does not work
  if(remove_timeSeries_zeros_too){
      all_areas_nuseds <- remove_series_nodata_nuseds_parallel_fun(all_areas_nuseds = all_areas_nuseds,
                                                                   zeros_too = T, # to consider time series with only NAs and/or 0s
                                                                   cores_nb = cores_nb)
      
      write.csv(all_areas_nuseds,paste0(wd_data,"/all_areas_nuseds_noNA0s_TEMP.csv"),
                row.names = F)
        
  }else{
      all_areas_nuseds <- remove_series_nodata_nuseds_parallel_fun(all_areas_nuseds = all_areas_nuseds,
                                                                   zeros_too = F, # only consider time series with only NAs
                                                                   cores_nb = cores_nb)
      
      write.csv(all_areas_nuseds,paste0(wd_data,"/all_areas_nuseds_noNAs_TEMP.csv"),
                row.names = F)
  }
}

nrow(all_areas_nuseds) # 313285 (series with NAs removed) 312331 (series with NAs and/or 0s removed)

nrow_after <- nrow(all_areas_nuseds)
```

This procedure removes `r nrow_before - nrow_after` rows in **NUSEDS**, corresponding to `r round((nrow_before - nrow_after)/nrow_before*100,1)`% of the original dataset.

```{r, include = F}
# Record the series that were removed and why:
IndexId_GFE_ID_all <- unique(all_areas_nuseds_all[,c("IndexId","GFE_ID")])
nrow(IndexId_GFE_ID_all) # 11568 

IndexId_GFE_ID <- unique(all_areas_nuseds[,c("IndexId","GFE_ID")])
nrow(IndexId_GFE_ID) # 7144  

IndexId_GFE_ID_all <- paste(IndexId_GFE_ID_all$IndexId,IndexId_GFE_ID_all$GFE_ID,sep = "&")
IndexId_GFE_ID <- paste(IndexId_GFE_ID$IndexId,IndexId_GFE_ID$GFE_ID,sep = "&")

IndexId_GFE_ID_removed_c <- IndexId_GFE_ID_all[! IndexId_GFE_ID_all %in% IndexId_GFE_ID]
length(IndexId_GFE_ID_removed_c) # 4424  
IndexId_GFE_ID_removed <- data.frame(IndexId = rep(NA,length(IndexId_GFE_ID_removed_c)),
                                     GFE_ID = rep(NA,length(IndexId_GFE_ID_removed_c)))

IndexId_GFE_ID_removed$IndexId <- sapply(X = IndexId_GFE_ID_removed_c, FUN = function(s){
  # s <- IndexId_GFE_ID_removed[1]
  return(strsplit(x = s, split = "&")[[1]][1])
  })

IndexId_GFE_ID_removed$GFE_ID <- sapply(X = IndexId_GFE_ID_removed_c, FUN = function(s){
  # s <- IndexId_GFE_ID_removed[1]
  return(strsplit(x = s, split = "&")[[1]][2])
})


if(remove_timeSeries_zeros_too){
  comment <- "Only NAs and/or 0s for MAX_ESTIMATE"
}else{
  comment <- "Only NAs for MAX_ESTIMATE"
}

removed_all <- IndexId_GFE_ID_removed
removed_all$dataset <- "NUSEDS"
removed_all$comment <- comment

# check
# i <- 3243
# plot_IndexId_GFE_ID_fun(IndexIds = removed_all$IndexId[i],
#                         GFE_IDs = removed_all$GFE_ID[i],
#                         all_areas_nuseds = all_areas_nuseds_all)
nrow(removed_all) # 4424 4484 4491
```

The data removed concerns `r nrow(removed_all)` time series, which are referenced in `removed_all`:

```{r, echo=FALSE}
head(removed_all)
```

Note that we do not remove these series in **CUSS** at this stage because they could be alternative series for the series in **NUSEDS** that do not appear in **CUSS**. It is only once series in **NUSEDS** absent in **CUSS** were found alternative series for, that we remove series in **CUSS** that have only NAs and/or 0s in **NUSEDS**.

## Fix time series in CUSS that are not in NUSEDS

Look for each time series in **CUSS** (i.e., unique `IndexId` & `GFE_ID` association) and:

1)  check if there are `IndexId` associated to multiple locations (i.e., `GFE_ID`); if yes: trouble shoot manually because this should not happen: `IndexId` should be associated to one unique location.

2)  else look if there is a time series with the same `IndexId` & `GFE_ID` in **NUSEDS**; if yes: all good :-)

3)  else: that could be due to the wrong attribution of either (i) the `IndexId` or (ii) the `GFE_ID`. The rest of the code looks for potential alternative series in **NUSEDS** with either a different `IndexId` (but with the same species) or a different `GFE_ID`. Alternative series identified **NOT present in CUSS** are kept, the ones present are not considered.

The procedure returns a simple data frame with the `IndexId` & `GFE_ID` series concerned and associated comment and eventual potential alternative series that have to be checked manually after:

```{r, include=FALSE}
#' TODO if import_file_locally_TEMPORARY is TRUE and trackRecord_noNA0s_TEMP.csv
#' or trackRecord_noNAs_TEMP.csv is not in /data_input: to download at https://zenodo.org/records/14248904
#' 
# If trackRecord_TEMP.csv already produced: to save time
if(import_file_locally_TEMPORARY){
  
  if(remove_timeSeries_zeros_too){
    
    trackRecord <- read.csv(paste0(wd_data_input,"/trackRecord_noNA0s_TEMP.csv"), header = T)
    
  }else{
    
    trackRecord <- read.csv(paste0(wd_data_input,"/trackRecord_noNAs_TEMP.csv"), header = T)
    
  }
  
}else{
  
  if(remove_timeSeries_zeros_too){
      trackRecord <- cuss_nuseds_match_parallel_fun(conservation_unit_system_sites = conservation_unit_system_sites,
                                                all_areas_nuseds = all_areas_nuseds,
                                                cores_nb = cores_nb)
      write.csv(trackRecord,paste0(wd_data,"/trackRecord_noNA0s_TEMP.csv"), row.names = F)
      
  }else{
      trackRecord <- cuss_nuseds_match_parallel_fun(conservation_unit_system_sites = conservation_unit_system_sites,
                                                all_areas_nuseds = all_areas_nuseds,
                                                cores_nb = cores_nb)
      write.csv(trackRecord,paste0(wd_data,"/trackRecord_noNAs_TEMP.csv"), row.names = F)
  }
}

nrow(trackRecord) # 7145

# Number of time series present in CUSS but not in NUSEDS:
cond <- trackRecord$in_nused == "no"
sum(cond) # 247 

head(trackRecord[cond,])

# check the series related to different comments:
unique(trackRecord$comment[cond])
```

```{r, echo=FALSE}
cond <- trackRecord$in_nused == "no"
d <- trackRecord[cond,]
rownames(d) <- NULL
head(d)
```

There are `r sum(cond)` out of `r nrow(trackRecord)` time series in **CUSS** that are not present in **NUSEDS** (i.e., `r round(sum(cond)/nrow(trackRecord)*100,1)`%), and the vast majority of them do not have an alternative series in **NUSEDS**:

```{r}
table(trackRecord$comment[cond])
```

### Alternative series present

The goal here is to go over all the cases where alternative series are available. The title of the figures below shows the **focal series** that is in **CUSS** but not in **NUSEDS**. The series on the top left corner are potential **alternative series** (i.e., they are present in **NUSEDS** but not in **CUSS**).

```{r}
comment <- "Alternative series:"
trackRecord_cuss_alternative <- trackRecord[grepl(comment,trackRecord$comment),]
```

```{r, echo=FALSE}
rownames(trackRecord_cuss_alternative) <- NULL
nrow(trackRecord_cuss_alternative) # 3
trackRecord_cuss_alternative
```

```{r, include=F}
r <- 1
d <- trackRecord_cuss_alternative[r,,drop = F]
series_alternative <- d$comment
series_alternative <- gsub("Alternative series: ","",series_alternative)
series_alternative <- strsplit(series_alternative, split = ", ")[[1]]
series_alternative <- strsplit(series_alternative," & ")

iids <- sapply(X = series_alternative, function(c){c[1]})
gfeids <- sapply(X = series_alternative, function(c){c[2]})

d <- data.frame(IndexId = iids,
                GFE_ID = as.numeric(gfeids))

d

series_alternative <- paste(d$IndexId,"& GFE_ID =",d$GFE_ID)
series_focal <- paste0(trackRecord_cuss_alternative$IndexId[r]," & GFE_ID = ",
                      trackRecord_cuss_alternative$GFE_ID[r])
```

```{r, echo=FALSE}
#' Note: the title of the figure shows the focal series that is in CUSS but not 
#' in NUSEDS. The series on the top left corner are potential alternative series,
#' i.e. they are present in NUSEDS but not in CUSS.
main <- paste0("Alternative series for ",series_focal)
plot_IndexId_GFE_ID_fun(IndexIds = d$IndexId, 
                        GFE_IDs = d$GFE_ID, 
                        all_areas_nuseds = all_areas_nuseds_all, 
                        main = main)
```

The focal **CUSS** time series `r series_focal` corresponds to the `CU_NAME`:

```{r, echo = F}
cond <- conservation_unit_system_sites$IndexId %in% c("CN_46842","CN_46841")
unique(conservation_unit_system_sites$CU_NAME[cond])
```

The two alternative time series are noted as two different runs, according to **NUSEDS**'s `POPULATION`:

```{r,echo=F}
cond <- all_areas_nuseds$IndexId %in% c("CN_46842","CN_46841")
unique(all_areas_nuseds$POPULATION[cond])
```

```{r,include=F}
cond <- conservation_unit_system_sites$GFE_ID == as.numeric(gfeids[2])
Y_LAT_focal <- conservation_unit_system_sites$Y_LAT[cond] |> unique()
X_LONGT_focal <- conservation_unit_system_sites$X_LONGT[cond] |> unique()
SYSTEM_SITE_focal <- conservation_unit_system_sites$SYSTEM_SITE[cond] |> unique()

cond <- conservation_unit_system_sites$GFE_ID == as.numeric(gfeids[1])
Y_LAT <- conservation_unit_system_sites$Y_LAT[cond] |> unique()
X_LONGT <- conservation_unit_system_sites$X_LONGT[cond] |> unique()
SYSTEM_SITE <- conservation_unit_system_sites$SYSTEM_SITE[cond] |> unique()

# c(Y_LAT_focal,X_LONGT_focal)
# c(Y_LAT,X_LONGT)

pt_focal <- SpatialPoints(coords = data.frame(x = X_LONGT_focal, y = Y_LAT_focal), 
                          proj4string = CRS("+proj=longlat +datum=WGS84"))
pt_alternative <- SpatialPoints(coords = data.frame(x = X_LONGT, y = Y_LAT), 
                                proj4string = CRS("+proj=longlat +datum=WGS84"))

dist <- spDists(x = pt_focal,y = pt_alternative, longlat = T) # distance in km

dist <- round(as.numeric(dist),2)

```

Below are the focal and alternative location, and the distance between the two `GFE_ID` is `r dist` km:

```{r,echo=FALSE}
cond <- conservation_unit_system_sites$GFE_ID %in% as.numeric(gfeids)
show <- unique(conservation_unit_system_sites[cond,c("SYSTEM_SITE","GFE_ID","X_LONGT","Y_LAT")])
rownames(show) <- NULL
show
```

```{r, include=FALSE}
# Some checks on ESTIMATE_CLASSIFICATION

cond <- all_areas_nuseds$GFE_ID == as.numeric(gfeids[1]) & all_areas_nuseds$IndexId == iids[1]
unique(all_areas_nuseds$ESTIMATE_CLASSIFICATION[cond])

cond <- all_areas_nuseds$GFE_ID == as.numeric(gfeids[2]) & all_areas_nuseds$IndexId == iids[2]
unique(all_areas_nuseds$ESTIMATE_CLASSIFICATION[cond])

show <- unique(all_areas_nuseds[cond,c("SPECIES","GFE_ID","WATERBODY","ESTIMATE_CLASSIFICATION","Year","MAX_ESTIMATE")])
show <- show[order(show$Year),]
```

```{r, include=F}
#' TODO: replace CN_46842 & GFE_ID = 2463 and CN_46841 & GFE_ID = 285 by 
#' CN_46842 & GFE_ID = 285 in NUSEDS.

removed <- data.frame(IndexId = c("CN_46842","CN_46841"),
                      GFE_ID = c(2463,285))
removed$dataset <- "NUSEDS"
removed$comment <- "Alternative series for CN_46842 & GFE_ID = 285"
removed_all <- rbind(removed_all,removed)

#' CN_46842 & GFE_ID = 2463 --> CN_46842 & GFE_ID = 285
#' --> change of GFE_ID:
all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "CN_46842",
                                                IndexId_alter = "CN_46842",
                                                GFE_ID_focal = 2463,
                                                GFE_ID_alter = 285,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

#' CN_46841 & GFE_ID = 285 --> CN_46842 & GFE_ID = 285
#' --> change IndexId
all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "CN_46841",
                                                IndexId_alter = "CN_46842",
                                                GFE_ID_focal = 285,
                                                GFE_ID_alter = 285,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)
```

**Decision:** It was decided to merge the two time series `r paste(series_alternative, collapse = " and ")` to the series `r series_focal` in **NUSEDS** because there is only one timing for this Middle Fraser River (Spring 5-2) Chinook CU and the two series are complementary.

```{r, include=F}
r <- 2
d <- trackRecord_cuss_alternative[r,,drop = F]
series_alternative <- d$comment
series_alternative <- gsub("Alternative series: ","",series_alternative)
series_alternative <- strsplit(series_alternative, split = ", ")[[1]]
series_alternative <- strsplit(series_alternative," & ")

iids <- sapply(X = series_alternative, function(c){c[1]})
gfeids <- sapply(X = series_alternative, function(c){c[2]})

d <- data.frame(IndexId = iids,
                GFE_ID = gfeids)

series_alternative <- paste(d$IndexId,"& GFE_ID =",d$GFE_ID)
series_focal <- paste0(trackRecord_cuss_alternative$IndexId[r]," & GFE_ID = ",
                      trackRecord_cuss_alternative$GFE_ID[r])
```

```{r, echo=FALSE}
main <- paste0("Alternative series for ",series_focal)
plot_IndexId_GFE_ID_fun(IndexIds = d$IndexId, 
                        GFE_IDs = d$GFE_ID, 
                        all_areas_nuseds = all_areas_nuseds_all, 
                        main = main)
```

**Decision:** we replace `r series_alternative` by `r series_focal` in **NUSEDS**.

```{r,include=F}

removed <- data.frame(IndexId = c("PKE_54793433"),
                      GFE_ID = c(1490))
removed$dataset <- c("NUSEDS")
removed$comment <- c("Changed to PKE_42409 - 1490 because not in CUSS and the latter was not in NUSEDS")

all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(IndexId_focal = "PKE_54793433",
                                                IndexId_alter = "PKE_42409",
                                                GFE_ID_focal = 1490,
                                                GFE_ID_alter = 1490,
                                                edit_NUSEDS = T,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)
# 
removed_all <- rbind(removed_all,removed)
```

```{r,include=FALSE}
r <- 3 # 4
d <- trackRecord_cuss_alternative[r,,drop = F]
series_alternative <- d$comment
series_alternative <- gsub("Alternative series: ","",series_alternative)
series_alternative <- strsplit(series_alternative, split = ", ")[[1]]
series_alternative <- strsplit(series_alternative," & ")

iids <- sapply(X = series_alternative, function(c){c[1]})
gfeids <- sapply(X = series_alternative, function(c){c[2]})

d <- data.frame(IndexId = iids,
                GFE_ID = gfeids)

series_alternative <- paste(d$IndexId,"& GFE_ID =",d$GFE_ID)
series_focal <- paste0(trackRecord_cuss_alternative$IndexId[r]," & GFE_ID = ",
                      trackRecord_cuss_alternative$GFE_ID[r])
```

```{r, echo=FALSE}
main <- paste0("Alternative series for ",series_focal)
plot_IndexId_GFE_ID_fun(IndexIds = d$IndexId, 
                        GFE_IDs = d$GFE_ID, 
                        all_areas_nuseds = all_areas_nuseds, 
                        main = main)
```

The two time series have the same `CU_NAME` in **CUSS**:

```{r,echo=F}
sapply(X = c("SX_7763","SX_47954"),function(iid){
  cond <- conservation_unit_system_sites$IndexId == iid
  return(conservation_unit_system_sites$CU_NAME[cond])
})
```

```{r,echo=F}
#' TODO: replace SX_47954 & 21 by SX_7763 & 21 in NUSEDS.
#' --> change IndexId
removed <- data.frame(IndexId = c("SX_47954"),
                      GFE_ID = 21)
removed$dataset <- "NUSEDS"
removed$comment <- "Alternative series for SX_7763 & GFE_ID = 21"
removed_all <- rbind(removed_all,removed)

all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "SX_47954",
                                                IndexId_alter = "SX_7763",
                                                GFE_ID_focal = 21,
                                                GFE_ID_alter = 21,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)
```

**Decision:** Replace `r paste(series_alternative, collapse = " and ")` by `r series_focal` in **NUSEDS**.

### Alternative series not present in NUSEDS

The goal is to remove these `IndexId` & `GFE_ID` references from **CUSS** and to specify if they were simply not present in the original **NUSEDS** or only contained NAs and/or 0s.

```{r}
comment <- "There is no alternative series in NUSEDS"
trackRecord_cuss_noAlernative <- trackRecord[grepl(comment,trackRecord$comment),]
```

```{r, echo=FALSE}
rownames(trackRecord_cuss_noAlernative) <- NULL
nrow(trackRecord_cuss_noAlernative) # 243
head(trackRecord_cuss_noAlernative[,c("IndexId","GFE_ID","in_cuss","in_nused","comment")])
```

```{r, include=F}
for(r in 1:nrow(trackRecord_cuss_noAlernative)){
  # r <- 1
  iid <- trackRecord_cuss_noAlernative$IndexId[r]
  gfeid <- trackRecord_cuss_noAlernative$GFE_ID[r]
  
  # check if the series already exists in removed_all
  cond <- removed_all$IndexId == iid & removed_all$GFE_ID == gfeid
  if(nrow(removed_all[cond,]) > 0){ # edit removed_all
    removed_all$dataset[cond] <- "both"   # because if the reference of the series is already there is because it was removed from NUSEDS
    print(paste("Series",iid,"-",gfeid,"was in NUSEDS with only NAs and/or 0s"))
    
  }else{ # add row to removed_all
    removed <- data.frame(IndexId = iid,
                          GFE_ID = gfeid,
                          dataset = "CUSS")
    removed$comment <- "Not in NUSEDS and no alternative series"
    removed_all <- rbind(removed_all,removed)
    # print(paste("Series",iid,"-",gfeid,"was not nuseds"))
  }
  
  # remove series from conservation_unit_system_sites
  cond <- conservation_unit_system_sites$IndexId == iid &
    conservation_unit_system_sites$GFE_ID == gfeid
  conservation_unit_system_sites <- conservation_unit_system_sites[!cond,]
}

nrow(conservation_unit_system_sites) # 6902 6890


# all but one of the series are in all_areas_nuseds_all
cond <- removed_all$dataset == "both"
sum(cond) # 242 253 (vs. 254)
```

`r sum(cond)` of the `r nrow(trackRecord_cuss_noAlernative)` `IndexId` & `GFE_ID` references were removed previously from **NUSEDS** because they contained only NAs and/or 0s. Only the following reference was not in **NUSEDS** initially:

```{r, include=FALSE}
# the only series in CUSS not in all_areas_nuseds_all
cond <- grepl("Not in NUSEDS and no alternative series",removed_all$comment)
removed_all[cond,]
# IndexId GFE_ID                        dataset                                           comment
# SX_2167	150	CUSS	Not in NUSEDS and no alternative series

IndexId <- removed_all$IndexId[cond]
GFE_ID <- removed_all$GFE_ID[cond]
```

```{r, echo=F}
cond <- conservation_unit_system_sites_all$IndexId == IndexId & 
  conservation_unit_system_sites_all$GFE_ID == GFE_ID

show <- conservation_unit_system_sites_all[cond,c("GFE_ID","SYSTEM_SITE","SPECIES_QUALIFIED","CU_NAME","FULL_CU_IN")] # "UPPER FRASER"
rownames(show) <- NULL
show
```

### Multiple GFE_IDs for a same IndexId (POP_ID) in CUSS

There should not be any `IndexId` associated to multiple `GFE_ID` (it is a MANY TO ONE relationship).

```{r}
comment <- "In CUSS: there are multiple GFE_IDs for"
trackRecord_cuss_multi_fgeid <- trackRecord[grepl(comment,trackRecord$comment),]
```

This happens for `r length(unique(trackRecord_cuss_multi_fgeid$IndexId))` populations:

```{r, echo=FALSE}
rownames(trackRecord_cuss_multi_fgeid) <- NULL
trackRecord_cuss_multi_fgeid
```

```{r, echo=FALSE}
#' Case with CN_7479:
#'    -  series CN_7479 & GF_ID = 133 is not in all_areas_nuseds_all 
#'    (nor in NUSEDS) as shown by its absence in the figure below.
#'    TODO: remove CN_7479 & GF_ID = 133 from CUSS
iid <- unique(trackRecord_cuss_multi_fgeid$IndexId)[1]
gfeids <- trackRecord_cuss_multi_fgeid$GFE_ID[1:2]

#' Note: series CN_7479 & GF_ID = 133 is not in NUSEDS, which is why it does not 
#' appear in the figure.
par(mar = c(4.5,4.5,.5,.5))
plot_IndexId_GFE_ID_fun(IndexIds = iid,
                        all_areas_nuseds = all_areas_nuseds)
```

The figure above only show the time series present in **NUSEDS**. The other time series is removed from **CUSS**.

```{r, include=FALSE}
cond <- conservation_unit_system_sites$IndexId == "CN_7479" & 
  conservation_unit_system_sites$GFE_ID == 133

conservation_unit_system_sites <- conservation_unit_system_sites[!cond,]
nrow(conservation_unit_system_sites) # 6901 6889

removed <- data.frame(IndexId = "CN_7479",
                      GFE_ID = 133,
                      dataset = "conservation_unit_system_sites")
removed$comment <- "Not in NUSEDS and no alternative series"
removed_all <- rbind(removed_all,removed)
```

```{r, echo=FALSE}
#' Case with SX_45525:
#' - there is no "Nadina channel" in streamlocationids (the red series) and seems
#' that the abundances were summed in the PSE.
#' TODO: create a new row in streamlocationids for the red series.
iid <- unique(trackRecord_cuss_multi_fgeid$IndexId)[2]
gfeids <- trackRecord_cuss_multi_fgeid$GFE_ID[trackRecord_cuss_multi_fgeid$IndexId == iid]
par(mar = c(4.5,4.5,.5,.5))
plot_IndexId_GFE_ID_fun(IndexIds = iid, 
                        all_areas_nuseds = all_areas_nuseds_all)

# add the WATERBODY associated with the GFE_ID:
POP_WB <- lapply(X = c(2444,303), FUN = function(x){
  cond <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID == x
  pop <- unique(all_areas_nuseds$POPULATION[cond])
  wb <-  unique(all_areas_nuseds$WATERBODY[cond])
  out <- data.frame(POPULATION = pop,
                    WATERBODY = wb)
  return(out)
})
POP_WB <- do.call(rbind,POP_WB)
legend("top",c("WATERBODY:",POP_WB$WATERBODY),bty = 'n')
#legend("topright",c("POPULATION:",GFE_IDs),bty = 'n')

cond <- conservation_unit_system_sites$IndexId == iid
CU_NAME <- conservation_unit_system_sites$CU_NAME[cond]
```

```{r, include=FALSE}
# internal checks
# cond <- grepl("[N|n]adina",streamlocationids$sys_nm) & grepl("[S|s]ockeye",streamlocationids$species_name)
# streamlocationids[cond,]

# they have the same CU_NAME (as expected because it is the same IndexId)
sapply(X = c(2444,303),FUN = function(x){
  cond <- conservation_unit_system_sites$IndexId == iid &
    conservation_unit_system_sites$GFE_ID == x
  out <- conservation_unit_system_sites$CU_NAME[cond]
  return(out)
})

# check coordinates --> there are different
sapply(X = c(2444,303),FUN = function(x){
  cond <- conservation_unit_system_sites$IndexId == iid &
    conservation_unit_system_sites$GFE_ID == x
  out <- conservation_unit_system_sites[cond,c("Y_LAT","X_LONGT")]
  return(out)
})

# check pop size for the blue (to see if correspond to values in the PSE)
cond <- all_areas_nuseds$IndexId == "SX_45525" & all_areas_nuseds$GFE_ID == 303
all_areas_nuseds[cond,c("Year","MAX_ESTIMATE")][order(all_areas_nuseds[cond,c("Year")]),]
```

These two time series of this CU (`CU_NAME` = `r CU_NAME`) should have a different `IndexId` (i.e. `POP_ID`). We keep them as is and do not make any change to **NUSEDS** and **CUSS**.

```{r, include=FALSE}

BRUNO IS HERE

#' TODO: check if the time series below appears on the PSE now --> IT IS
# cond <- conservation_unit_system_sites$GFE_ID == 2444
# SYSTEM_SITE <- conservation_unit_system_sites$SYSTEM_SITE[cond]
# toAdd <- data.frame(IndexId = "SX_45525",
#                     GFE_ID = 2444,
#                     # SYSTEM_SITE = SYSTEM_SITE,
#                     dataset = "streamlocationids",
#                     CU_NAME = "NADINA/FRANCOIS-EARLY SUMMER TIMING",
#                     comment = "In both CUSS and NUSEDS but not in the PSE; but series SX_45525 - 303 is.")
# 
# added_all <- toAdd
```

## Fix populations in NUSEDS that are not in CUSS

The goal is to look for each `IndexId` & `GFE_ID` series in **NUSEDS** that are not in **CUSS** and to:

1)  Look if there are alternative series in **NUSEDS** that are also present in **CUSS**

-   if not, add the `IndexId` & `GFE_ID` reference in **CUSS**

-   if yes, see if the alternative series can be merged; if not, add the `IndexId` & `GFE_ID` reference to **CUSS**

2)  Use the PSE's CUs' shape files for those without alternative series.

```{r, include=FALSE}
series_nuseds <- paste(all_areas_nuseds$IndexId,
                       all_areas_nuseds$GFE_ID,sep = "&")
series_nuseds <- unique(series_nuseds)
length(series_nuseds) # 7143 

series_cuss <- paste(conservation_unit_system_sites$IndexId,
                     conservation_unit_system_sites$GFE_ID,sep = "&")
series_cuss <- unique(series_cuss)
length(series_cuss) # 6901 

#' Now all the series in CUSS are in all_areas_nuseds.
series_cuss[! series_cuss %in% series_nuseds]

# Number of series in NUSEDS not in CUSS:
series_Nuseds_noCuss <- series_nuseds[! series_nuseds %in% series_cuss]
series_Nuseds_noCuss <- series_Nuseds_noCuss[order(series_Nuseds_noCuss)]
n <- length(series_Nuseds_noCuss) # 242 
n
```

There are `r n` `IndexId` & `GFE_ID` references in **NUSEDS** that are not present in **CUSS**, for instance:

```{r, include=FALSE}
iids <- sapply(X = series_Nuseds_noCuss,FUN = function(s){
  return(strsplit(s,"&")[[1]][1])
})

gfeids <- sapply(X = series_Nuseds_noCuss,FUN = function(s){
  return(strsplit(s,"&")[[1]][2])
})

trackRecord_nuseds <- data.frame(IndexId = iids,
                                 GFE_ID = gfeids)
trackRecord_nuseds$nb_dataPt <- NA
trackRecord_nuseds$alternative_IndexId <- NA
trackRecord_nuseds$alternative_GFE_ID <- NA
trackRecord_nuseds$alternative_IndexId_track <- NA # to retain the alternative IndexId not retained because series is not in CUSS
trackRecord_nuseds$alternative_GFE_ID_track <- NA # to retain the alternative GFE_ID not retained because series is not in CUSS
# trackRecord_nuseds$only_0s <- NA
rownames(trackRecord_nuseds) <- NULL

for(i in 1:nrow(trackRecord_nuseds)){
  # i <- 35
  #' 2. is there a GFE_ID + species in cuss
  iid <- trackRecord_nuseds$IndexId[i]
  speciesAcro <- strsplit(iid,split = "_")[[1]][1]
  gfeid <- trackRecord_nuseds$GFE_ID[i]
  
  # plot_IndexId_GFE_ID_fun(IndexIds = iid,
  #                         all_areas_nuseds = all_areas_nuseds)
  # legend("topright", paste("Series not in CUSS"), bty = 'n')
  
  # Find the number of data points
  cond <- all_areas_nuseds$IndexId == iid &
    all_areas_nuseds$GFE_ID == gfeid
  nuseds_cut <- all_areas_nuseds[cond,]
  max_esti <- nuseds_cut$MAX_ESTIMATE
  trackRecord_nuseds$nb_dataPt[i] <- sum(!is.na(nuseds_cut$MAX_ESTIMATE))
  # max_esti <- max_esti[!is.na(max_esti)]
  # if(all(max_esti == 0)){
  #   trackRecord_nuseds$only_0s[i] <- T
  # }
  
  #' 1) Look in NUSEDS for alternative series that are in CUSS with the same IndexId
  #' but different GFE_ID.
  cond <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID != gfeid
  nuseds_here <- all_areas_nuseds[cond,]
  
  alternative_GFE_ID <- c()
  alternative_GFE_ID_track <- c()
  
  # there is no alternative series in NUSEDS
  if(nrow(nuseds_here) == 0){
    alternative_GFE_ID <- "none"
    
  }else{
    
    # look if the these alternative series are in CUSS:
    gfeids <- unique(nuseds_here$GFE_ID)
    for(gfeid_i in gfeids){
      # gfeid_i <- gfeids[2]
      cond <- conservation_unit_system_sites$IndexId == iid &
        conservation_unit_system_sites$GFE_ID == gfeid_i
      
      # if the alternative series is in CUSS
      if(any(cond)){
        alternative_GFE_ID <- c(alternative_GFE_ID,
                                conservation_unit_system_sites$GFE_ID[cond])
        
      }else{ # in that case the alternative series has to be in trackRecord_nuseds
        cond <- trackRecord_nuseds$IndexId == iid &
          trackRecord_nuseds$GFE_ID == gfeid_i
        
        alternative_GFE_ID_track <- c(alternative_GFE_ID_track,
                                      trackRecord_nuseds$GFE_ID[cond])
      }
    }
    if(length(alternative_GFE_ID) == 0){
      alternative_GFE_ID <- "none"
    }
  }
  
  #' 2) Look in NUSEDS for alternative series that are in CUSS with the same GFE_ID 
  #' and species but different IndexId
  cond <- all_areas_nuseds$species_acronym_ncc == speciesAcro & 
    all_areas_nuseds$GFE_ID == gfeid &
    all_areas_nuseds$IndexId != iid
  nuseds_here <- all_areas_nuseds[cond,]
  
  alternative_IndexId <- c()
  alternative_IndexId_track <- c()
  
  # there is no alternative series in NUSEDS
  if(nrow(nuseds_here) == 0){
    alternative_IndexId <- "none"
    
  }else{
    # look if the these alternative series are in CUSS:
    iids <- unique(nuseds_here$IndexId)
    for(iid_i in iids){
      # iid_i <- iids[1]
      cond <- conservation_unit_system_sites$IndexId == iid_i &
        conservation_unit_system_sites$GFE_ID == gfeid
      
      # if the alternative series is in CUSS
      if(any(cond)){
        alternative_IndexId <- c(alternative_IndexId,
                                 conservation_unit_system_sites$IndexId[cond])
        
      }else{ # in that case the alternative series has to be in trackRecord_nuseds
        cond <- trackRecord_nuseds$IndexId == iid_i &
          trackRecord_nuseds$GFE_ID == gfeid
        
        alternative_IndexId_track <- c(alternative_IndexId_track,
                                       trackRecord_nuseds$IndexId[cond])
      }
    }
    if(length(alternative_IndexId) == 0){
      alternative_IndexId <- "none"
    }
  }
  trackRecord_nuseds$alternative_GFE_ID[i] <- paste(alternative_GFE_ID,collapse = " ; ")
  trackRecord_nuseds$alternative_GFE_ID_track[i] <- paste(alternative_GFE_ID_track,collapse = " ; ")
  trackRecord_nuseds$alternative_IndexId[i] <- paste(alternative_IndexId,collapse = " ; ")
  trackRecord_nuseds$alternative_IndexId_track[i] <- paste(alternative_IndexId_track,collapse = " ; ")
  # trackRecord_nuseds[i,]
}
#View(trackRecord_nuseds)
head(trackRecord_nuseds)
nrow(trackRecord_nuseds) # 242 188 171
rownames(trackRecord_nuseds) <- NULL
```

```{r, echo=FALSE}
head(trackRecord_nuseds[,c("IndexId","GFE_ID","nb_dataPt","alternative_IndexId","alternative_GFE_ID")])
```

### Alternative IndexId (POP_ID) AND no alternative GFE_ID

The section concerns focal `IndexId` & `GFE_ID` time series in **NUSEDS** that are not in **CUSS** and for which there are alternative series in **CUSS** with the same `IndexId` but a different `GFE_ID`. The goal is to compare the focal vs. the alternative time series and take the following actions:

-   if the time series are 100% complementary: merge them (i.e., edit `IndexId` in **NUSEDS**)

-   if the time series are 100% duplicated: remove the focal series in **NUSEDS**

-   if the series are partially conflictual or if there are multiple potential alternative series: trubble shoot manually

```{r, include=FALSE}
cond <- trackRecord_nuseds$alternative_IndexId != "none" &
  trackRecord_nuseds$alternative_GFE_ID == "none" # & 
  # !cond_3
trackRecord_nuseds_iid <- trackRecord_nuseds[cond,]
```

There are `r nrow(trackRecord_nuseds_iid)` time series concerned:

```{r, echo=FALSE}
show <- trackRecord_nuseds_iid[,c("IndexId","GFE_ID","nb_dataPt","alternative_IndexId")]
row.names(show) <- NULL
show
```

The figures below show for each of these cases the decision made. The figures also show the `POPULATION` of focal and alternative `IndexId`. The `i` at the bottom left of each plot is used after to reference the figures when fixing time series manually. Several cases are set aside to be manually fixed after.

```{r, echo=FALSE, fig.width = 14, fig.height = 8}
removed <- removed_all[F,]

set_aside <- list()
count_set_aside <- 1
for(i in 1:nrow(trackRecord_nuseds_iid)){
  # i <- 1
  iid_focal <- trackRecord_nuseds_iid$IndexId[i]
  iid_alter <- strsplit(trackRecord_nuseds_iid$alternative_IndexId[i]," ; ")[[1]]
  gfeid <- trackRecord_nuseds_iid$GFE_ID[i]
  
  # compare the series
  cond <- all_areas_nuseds$IndexId == iid_focal & 
    all_areas_nuseds$GFE_ID == gfeid
  series_focal <- all_areas_nuseds$MAX_ESTIMATE[cond]
  names(series_focal) <- all_areas_nuseds$Year[cond]
  
  # 
  POPULATION_focal <- unique(all_areas_nuseds$POPULATION[cond])
  POPULATION_alter <- c()
  
  comparison_series <- data.frame(IndexId = iid_alter, 
                                  GFE_ID = gfeid)
  comparison_series$complementary <- NA
  comparison_series$duplicate <- NA
  comparison_series$conflict <- NA
  comparison_series$decision <- NA
  
  for(iid in iid_alter){
    # iid <- iid_alter[1]
    cond <- all_areas_nuseds$IndexId == iid & 
      all_areas_nuseds$GFE_ID == gfeid[1]
    series_comp <- all_areas_nuseds$MAX_ESTIMATE[cond]
    names(series_comp) <- all_areas_nuseds$Year[cond]
    comparison <- compare_series_fun(series_focal,series_comp,percentage = T)
    
    comparison_series$nb_dataPt[which(iid == iid_alter)] <- comparison$nb_dataPt
    comparison_series$complementary[which(iid == iid_alter)] <- comparison$complementary
    comparison_series$duplicate[which(iid == iid_alter)] <- comparison$duplicate
    comparison_series$conflict[which(iid == iid_alter)] <- comparison$conflict
    
    POPULATION_here <- unique(all_areas_nuseds$POPULATION[cond])
    POPULATION_alter <- c(POPULATION_alter,POPULATION_here)
  }
  
  removed_here <- NULL
  #' 1) If the series is 100% duplicated with another: REMOVE
  if(any(comparison_series$duplicate == 100)){
    
    cond <- comparison_series$duplicate == 100
    iid_replacement <- comparison_series$IndexId[cond]
    gfeid_replacement <- comparison_series$GFE_ID[cond]
    
    removed_here <- removed_all[1,]
    removed_here$IndexId <- iid_focal
    removed_here$GFE_ID <- gfeid
    removed_here$dataset <- "all_areas_nuseds"
    comment <- paste("Duplicate of series IndexId =",iid_replacement,"& GFE_ID =",
                     gfeid_replacement)
    removed_here$comment <- comment
    
    main <- "Removed because duplicated"
    
    #' Do the change in NUSEDS: only change the IndexId are related fields (not 
    #' the GFE_ID ones because here GFE_IDs are the same).
    all_areas_nuseds <- remove_rows_fields_fun(dataframe = all_areas_nuseds, 
                                               toRemove = removed_here, 
                                               fields = c("IndexId","GFE_ID"))
    
    #' 2) if a series is 100 % compatible with one and only one alternative: MERGE
    #' If with more than one: set aside.
  }else if(any(comparison_series$complementary == 100)){
    
    if(sum(comparison_series$complementary == 100) == 1){
      cond <- comparison_series$complementary == 100
      iid_merge <- comparison_series$IndexId[cond]
      gfeid_merge <- comparison_series$GFE_ID[cond]
      
      # removed_here <- removed_all[1,]
      # removed_here$IndexId <- iid_focal
      # removed_here$GFE_ID <- gfeid
      # removed_here$dataset <- "all_areas_nuseds"
      # comment <- paste("Merged to series IndexId =",iid_merge,"& GFE_ID =",
      #                  gfeid_merge,"because 100% compatible")
      # removed_here$comment <- comment
      
      main <- paste("To merged to",iid_merge,"-",gfeid_merge)
      
    }else{
      set_aside[[count_set_aside]] <- comparison_series
      names(set_aside)[count_set_aside] <- paste("IndexId =",iid_focal,"& GFE_ID =",
                                                 gfeid)
      count_set_aside <- count_set_aside + 1
      main <-"Set aside all alternative series are 100% compatible"
    }
  }else{
    main <- "Set aside for now"
    set_aside[[count_set_aside]] <- comparison_series
    names(set_aside)[count_set_aside] <- paste("IndexId =",iid_focal,"& GFE_ID =",
                                               gfeid)
    count_set_aside <- count_set_aside + 1
    
  }
  
  #
  plot_IndexId_GFE_ID_fun(IndexIds = c(iid_focal,iid_alter),
                          GFE_IDs = rep(trackRecord_nuseds_iid$GFE_ID[i],
                                        length(iid_alter) + 1),
                          all_areas_nuseds = all_areas_nuseds_all, 
                          main = main)
  # legend("top",c("focal",rep("alterntive",length(POPULATION_alter))),col = NA,lwd = 1,bty = "n")
  # legend("topright",c(POPULATION_focal,POPULATION_alter),pch = NA, bty = "n")
  n1 <- c("focal",rep("alterntive",length(POPULATION_alter)))
  n2 <- c(POPULATION_focal,POPULATION_alter)
  legend("topright",paste(n1,n2, sep = " - "),pch = NA, bty = "n")
  legend("bottomleft",paste("i =",i),bty = "n")
  
  print(comparison_series)
  print("***")
  
  if(!is.null(removed_here)){
    removed <- rbind(removed,removed_here)
  }
}

removed_all <- rbind(removed_all,removed)
```

We now assess the cases set aside.

```{r, include=FALSE}
i <- 1
iid <- trackRecord_nuseds_iid$IndexId[i]
gfeid <- trackRecord_nuseds_iid$GFE_ID[i]
iid_alter <- trackRecord_nuseds_iid$alternative_IndexId[i]

cond_focal <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID == gfeid
cond_alter <- all_areas_nuseds$IndexId == iid_alter & all_areas_nuseds$GFE_ID == gfeid

for(f in fields_l$NUSEDS$IndexId){
  # f <- fields_l$NUSEDS$IndexId[2]
  all_areas_nuseds[cond_focal,f] <- unique(all_areas_nuseds[cond_alter,f])
}

removed_here <- removed_all[1,]
removed_here$IndexId <- iid
removed_here$GFE_ID <- gfeid
removed_here$dataset <- "NUSEDS"
comment <- paste("Merged to alternative series IndexId =",iid_alter,"& GFE_ID =",gfeid,"because there is only one Chum CU in the Fraser")
removed_here$comment <- comment
removed_all <- rbind(removed_all,removed_here)

plot_IndexId_GFE_ID_fun(IndexIds = c(iid,iid_alter),
                        GFE_IDs = c(gfeid,gfeid),
                        all_areas_nuseds = all_areas_nuseds, 
                        main = "")

```

In the case `i =` `r i` above, series `r paste(iid,gfeid,sep = " - ")` is merged to the alternative series despite the potential mismatch in "Run" because there is only one Chum CU in the Fraser. Its IndexId is change from `r iid` to `r iid_alter` in **NUSEDS**.

```{r, include=FALSE}
i <- i + 1
#' Case with CN_3331 (i = 2): UNKNOWN TIMING
#' Temporal fields show contradictions.
#' TODO: remove because they cannot be attributed to either alternative series
iid <- trackRecord_nuseds_iid$IndexId[i] # c("CN_3331") # ,"CN_3334")
gfeid <- trackRecord_nuseds_iid$GFE_ID[i] # [trackRecord_nuseds_iid$IndexId == iid]
cond <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID == gfeid
unique(all_areas_nuseds[cond,c("START_DTT","END_DTT")]) # all year
unique(all_areas_nuseds[cond,c("STREAM_ARRIVAL_DT_FROM","STREAM_ARRIVAL_DT_TO")]) # spring
unique(all_areas_nuseds[cond,c("PEAK_SPAWN_DT_FROM","PEAK_SPAWN_DT_TO")]) # summer/fall
unique(all_areas_nuseds[cond,c("END_SPAWN_DT_FROM","END_SPAWN_DT_TO")])   # fall

# retain the POPULATION for the different IndexId
iida <- trackRecord_nuseds_iid$alternative_IndexId[i]
iida <- strsplit(x = iida, split = " ; ")[[1]]
show <- data.frame(IndexId =  c(iid,iida), 
                   type = c("focal",rep("alternative",length(iida))))

show$POPULATION <- sapply(c(iid,iida), function(iid){
  cond <- all_areas_nuseds$IndexId == iid
  return(unique(all_areas_nuseds$POPULATION[cond]))
  })

toRemove <- data.frame(IndexId = iid, 
                       GFE_ID = gfeid, 
                       dataset = "NUSEDS")
toRemove$comment <- paste("Not merged to alternative series IndexId =",
                          paste(iida,collapse = " or "),"& GFE_ID =",gfeid,"because of unknown run timing")
removed_all <- rbind(removed_all,toRemove)

cond <- all_areas_nuseds$IndexId == iid & 
  all_areas_nuseds$GFE_ID == gfeid

all_areas_nuseds <- all_areas_nuseds[!cond,]
nrow(all_areas_nuseds) # 313266 312302 308231 308232
```

In the case `i =` `r i` above, series `r paste(iid,gfeid,sep = " - ")` was not merged to any of the alternative series because of its unknown run timing (see below). It is consequently removed from **NUSEDS**.

```{r, echo = FALSE}
show
```

```{r, include=FALSE}
i <- i + 1
#' Case with CN_3334 (i = 3): UNKNOWN TIMING
#' Temporal fields show contradictions.
#' TODO: remove because they cannot be attributed to either alternative series
iid <- trackRecord_nuseds_iid$IndexId[i] #c("CN_3334")
gfeid <- trackRecord_nuseds_iid$GFE_ID[i] #[trackRecord_nuseds_iid$IndexId == iid]
cond <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID == gfeid
unique(all_areas_nuseds[cond,c("START_DTT","END_DTT")]) # all year
unique(all_areas_nuseds[cond,c("STREAM_ARRIVAL_DT_FROM","STREAM_ARRIVAL_DT_TO")]) # spring
unique(all_areas_nuseds[cond,c("PEAK_SPAWN_DT_FROM","PEAK_SPAWN_DT_TO")]) # summer/fall
unique(all_areas_nuseds[cond,c("END_SPAWN_DT_FROM","END_SPAWN_DT_TO")])   # fall

# retain the POPULATION for the different IndexId
iida <- trackRecord_nuseds_iid$alternative_IndexId[trackRecord_nuseds_iid$IndexId == iid]
iida <- strsplit(x = iida, split = " ; ")[[1]]
show <- data.frame(IndexId =  c(iid,iida), 
                   type = c("focal",rep("alternative",length(iida))))

show$POPULATION <- sapply(c(iid,iida), function(iid){
  cond <- all_areas_nuseds$IndexId == iid
  return(unique(all_areas_nuseds$POPULATION[cond]))
  })

toRemove <- data.frame(IndexId = iid, 
                       GFE_ID = gfeid, 
                       dataset = "all_areas_nuseds")
toRemove$comment <- paste("Not merged to alternative series IndexId =",
                          paste(iida,collapse = " or "),"& GFE_ID =",gfeid,"because of unknown run timing")
removed_all <- rbind(removed_all,toRemove)

cond <- all_areas_nuseds$IndexId == iid & 
  all_areas_nuseds$GFE_ID == gfeid
all_areas_nuseds <- all_areas_nuseds[!cond,]
nrow(all_areas_nuseds) # 313230 312266 308195
```

In the case `i =` `r i` above, series `r paste(iid,gfeid,sep = " - ")` was initially going to be merged to the alternative series with which is was 100% compatible. But is was decided to remove it from **NUSEDS** because its run timing is unknown:

```{r, echo=FALSE}
show
```

```{r, include = F}
i <- i + 1 # 4
#' Case with CN_39983 (i = 4):
#' It is not in the PSE
#' TODO: add to CUSS. Note that the POP_ID is not in CUSS nor in the PSE (or decoder)
#' There is consequently no CU associated to it.
#' But it is very close to the Nanaimo river for which there is a Chinook summer 
#' (i.e. ) for which the Chemainus river is included as a spawning location
#'  https://salmonwatersheds.slack.com/archives/CJ5RVHVCG/p1709659637606539
trackRecord_nuseds_iid[i,]
iid <- trackRecord_nuseds_iid[i,]$IndexId
gfeid <- trackRecord_nuseds_iid[i,]$GFE_ID

# retain the POPULATION for the different IndexId
iida <- trackRecord_nuseds_iid$alternative_IndexId[trackRecord_nuseds_iid$IndexId == iid]
iida <- strsplit(x = iida, split = " ; ")[[1]]
show <- data.frame(IndexId =  c(iid,iida), 
                   type = c("focal",rep("alternative",length(iida))))

show$POPULATION <- sapply(c(iid,iida), function(iid){
  cond <- all_areas_nuseds$IndexId == iid
  return(unique(all_areas_nuseds$POPULATION[cond]))
  })
```

In the case `i =` `r i` above, series `r paste(iid,gfeid,sep = " - ")` was not merged to the alternative series because of different run timings:

```{r, echo=F}
show
```

It was decided instead to associate the population `r iid` to the CU *East Vancouver Island-Georgia Strait (Summer 4-1)* in the PSE because of the same run timing and the fact that the Chemainus river is connected to this CU. The corresponding `CU_NAME` in **CUSS** is:

```{r, include=F}
# attribute the East Vancouver Island-Georgia Strait (Summer 4-1) CU:
cond <- conservationunits_decoder$cu_name_pse == "East Vancouver Island-Georgia Strait (Summer 4-1)"
cu_decoder_here <- conservationunits_decoder[cond,]

#' find the CU-related information for East Vancouver Island-Georgia Strait 
#' (Summer 4-1) in CUSS:
cond <- conservation_unit_system_sites_all$CU_NAME == toupper(cu_decoder_here$cu_name_dfo) # does not work
sum(cond) # 0

cond <- grepl(toupper("East Vancouver Island-Georgia Strait"),
              conservation_unit_system_sites_all$CU_NAME) & 
  conservation_unit_system_sites_all$SPECIES_QUALIFIED == "CK"
conservation_unit_system_sites_all[cond,]
```

```{r, echo=F}
unique(conservation_unit_system_sites_all$CU_NAME[cond])
```

The reference of the `r paste(iid,gfeid,sep = " - ")` time series is added to **CUSS**. The CU-related fields in **CUSS** are filled with the values corresponding to the above `CU_NAME`. Here below is the row added to **CUSS**:

```{r, echo=F}
# add to CUSS
cuss_new <- CUSS_newRow_fun(IndexId = iid, 
                            GFE_ID = gfeid,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

cu_fields <- c("CU_ACRO","CU_INDEX","CU_LAT","CU_LONGT","CU_NAME","CU_TYPE",
               "FULL_CU_IN","FAZ_ACRO","MAZ_ACRO","JAZ_ACRO")

cu_fields_info <- unique(conservation_unit_system_sites_all[cond,cu_fields])

for(f in colnames(cu_fields_info)){
  cuss_new[,f] <- cu_fields_info[,f]
}
rownames(cuss_new) <- NULL
cuss_new
```

```{r, include = F}
conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId ="CN_39983",
                    GFE_ID = 1204,
                    # SYSTEM_SITE = cuss_new$SYSTEM_SITE,
                    dataset = "CUSS",
                    CU_NAME = NA,
                    comment = "Series not in CUSS; POP_ID not in CUSS but attributed to CU_NAME: EAST VANCOUVER ISLAND-GEORGIA STRAIT_SU_0.3")

# added_all <- rbind(added_all,toAdd)
# 1st time added_all is created
added_all <- toAdd
```

```{r, include=FALSE}
i <- i + 1 # 5 ; CN_7751 - 1208
iid <- trackRecord_nuseds_iid$IndexId[i]
gfeid <- trackRecord_nuseds_iid$GFE_ID[i]
iida <- trackRecord_nuseds_iid$alternative_IndexId[i]
iida <- strsplit(x = iida, split = " ; ")[[1]]

# check which CU the alternative IndixId belong to:
cond <- conservation_unit_system_sites$IndexId %in% iida
CU_NAME <- conservation_unit_system_sites$CU_NAME[cond] |> unique()
```

In the case `i =` `r i` above with the focal series `r paste(iid,gfeid,sep = " - ")`, both alternative series belong to the same fall Chinook CU (`CU_NAME =` `r CU_NAME`). The focal series is consequently deleted from **NUSEDS** because its `POPULATION` indicates it is a summer population, for which there is no CU in the PSE at this location.

```{r, include=FALSE}
cond <- all_areas_nuseds$IndexId == iid & 
  all_areas_nuseds$GFE_ID == gfeid
all_areas_nuseds$MAX_ESTIMATE[cond]
all_areas_nuseds <- all_areas_nuseds[!cond,]

toRemove <- data.frame(IndexId = iid, 
                       GFE_ID = gfeid, 
                       dataset = "all_areas_nuseds")
toRemove$comment <- paste("Not merged to alternative series IndexId =",
                          paste(iida,collapse = " or "),"& GFE_ID =",gfeid,"because of his Summer timing (vs. fall)")
removed_all <- rbind(removed_all,toRemove)
```

```{r, include = FALSE}
#' Case with CN_7809 (i = 6):
#' CN_7809 is Summer run type, while CN_48442 is Run 1 --> not contradictory.
#' But series with CN_7809 is much longer and recent than the CN_48442 one.
#' Looks like the two series are merged in the PSE (look for CU "Okanagan").
#' TODO: change series CN_48442 - 442 in CUSS for CN_7809 - 442.
#' --> change IndexId in CUSS
i <- i + 1 # 6
iid <- trackRecord_nuseds_iid$IndexId[i]
iid_alter <- trackRecord_nuseds_iid$alternative_IndexId[i]
gfeid <- trackRecord_nuseds_iid$GFE_ID[i]
```

In the case `i =` `r i` above, series `r paste(iid,gfeid,sep = " - ")` can be merged to the alternative series `r paste(iid_alter,gfeid,sep = " - ")` with which it is 100% compatible. The run timing indicated in `POPULATION` in **NUSEDS** are not incompatible:

```{r, echo=FALSE}
sapply(c(iid,iid_alter), function(p){
  cond <- all_areas_nuseds$IndexId == p
  return(unique(all_areas_nuseds$POPULATION[cond]))
})
```

However, we decide to merge the alternative time series to the focal one (i.e., change `r paste(iid_alter,gfeid,sep = " - ")` to `r paste(iid,gfeid,sep = " - ")`) instead of the contrary because the latter is longer and more recent. Consequently both **NUSEDS** and **CUSS** are edited.

```{r, echo = FALSE}
# Remove alternative series from CUSS and NUSEDS
toRemove <- data.frame(IndexId = iid_alter, 
                       GFE_ID = gfeid, 
                       dataset = "CUSS")
toRemove$comment <- paste0("Merged to series IndexId = ",iid," - GFE_ID = ",gfeid,", which was added to CUSS")
removed_all <- rbind(removed_all,toRemove)

# Add focal series to CUSS
cond <- conservation_unit_system_sites$GFE_ID == gfeid
SYSTEM_SITE <- conservation_unit_system_sites$SYSTEM_SITE[cond]
cond <- conservation_unit_system_sites$IndexId %in% c(iid,iid_alter)
CU_NAME <- unique(conservation_unit_system_sites$CU_NAME[cond])

toAdd <- data.frame(IndexId = iid,
                    GFE_ID = gfeid,
                    dataset = "CUSS",
                    CU_NAME = CU_NAME,
                    comment = paste0("Series not in CUSS; alternative series ",iid_alter," - ",gfeid," was merged to the series because it is longer and more recent"))
added_all <- rbind(added_all,toAdd)


# edit indexId - related fields in CUSS 
conservation_unit_system_sites <- fields_edit_NUSEDS_CUSS_fun(edit_CUSS = T, 
                                                IndexId_focal = iid_alter,   # yes here the one to change is iid_alter 
                                                IndexId_alter = iid,
                                                GFE_ID_focal = gfeid,
                                                GFE_ID_alter = gfeid,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

# merge series in all_areas_nuseds by changing CN_48442 for CN_7809
all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = iid_alter,   # yes here the one to change is iid_alter 
                                                IndexId_alter = iid,
                                                GFE_ID_focal = gfeid,
                                                GFE_ID_alter = gfeid,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

```

```{r, include=FALSE}
# already removed in the for loop above
i <- i + 1 # 7
iid <- trackRecord_nuseds_iid$IndexId[i] # CO_7776
iid_alter <- trackRecord_nuseds_iid$alternative_IndexId[i] # CO_3136
gfeid <- trackRecord_nuseds_iid$GFE_ID[i] # 2243
```

In the case `i =` `r i` above, the focal series `r paste(iid,gfeid,sep = " - ")` is removed from **NUSEDS** because it is 100% duplicated with the alternative series `r paste(iid_alter,gfeid,sep = " - ")`.

```{r, include=FALSE}
i <- i + 1 # 8
iid <- trackRecord_nuseds_iid$IndexId[i]                   # SX_3438
iid_alter <- trackRecord_nuseds_iid$alternative_IndexId[i] # SX_45085
gfeid <- trackRecord_nuseds_iid$GFE_ID[i]  # 2434

cond <- conservation_unit_system_sites$IndexId == iid_alter & conservation_unit_system_sites$GFE_ID == gfeid
conservation_unit_system_sites[cond,]
# 50.93509	-118.801294

cond <- all_areas_nuseds$IndexId == iid
POPULATION_focal <- all_areas_nuseds$POPULATION[cond] |> unique()
# "Loftus Creek Late Sockeye"

cond <- all_areas_nuseds$IndexId == iid_alter
POPULATION_alter <- all_areas_nuseds$POPULATION[cond] |> unique()
# --> belong to CU_NAME = SHUSWAP COMPLEX-EARLY SUMMER TIMING

# is there cu_name_name = Shuswap_Late in CUSS
cond <- grepl("SHUSWAP",conservation_unit_system_sites$CU_NAME) & conservation_unit_system_sites$SPECIES == "Sockeye"
conservation_unit_system_sites[cond,]$CU_NAME |> unique()
# "SHUSWAP COMPLEX-EARLY SUMMER TIMING" "SHUSWAP COMPLEX-LATE TIMING"  


cuss_new <- CUSS_newRow_fun(IndexId = iid, 
                            GFE_ID = gfeid, 
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)


cond <- conservation_unit_system_sites $CU_NAME == "SHUSWAP COMPLEX-LATE TIMING"
for(f in c("CU_NAME","CU_ACRO","CU_LAT","CU_LONGT","CU_TYPE","CU_INDEX","FULL_CU_IN")){
  cuss_new[,f] <- unique(conservation_unit_system_sites[cond,f])
}

conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId = iid,
                    GFE_ID = gfeid,
                    dataset = "CUSS",
                    CU_NAME = NA,
                    comment = paste0("Series not in CUSS, not merged to altenative series IndexId = ",iid_alter," & GHE_ID = ",gfeid," because different run timing and associated to CU_NAME 'SHUSWAP COMPLEX-LATE TIMING'"))

toAdd$CU_NAME <- cuss_new$CU_NAME

added_all <- rbind(added_all,toAdd)
```

In the case `i =` `r i` above, the focal series `r paste(iid,gfeid,sep = " - ")` has the `POPULATION` = `r POPULATION_focal`, which corresponds to the `CU_NAME` = "SHUSWAP COMPLEX-LATE TIMING" in **CUSS**. We consequently do not merge the two series but add the reference of the focal series in **CUSS** to the SHUSWAP COMPLEX-LATE TIMING CU.

```{r, include=FALSE}
i <- i + 1 # 9
iid <- trackRecord_nuseds_iid$IndexId[i] # SX_46279
iid_alter <- trackRecord_nuseds_iid$alternative_IndexId[i] # SX_46278
gfeid <- trackRecord_nuseds_iid$GFE_ID[i] # 224

cond <- conservation_unit_system_sites$IndexId == iid_alter & conservation_unit_system_sites$GFE_ID == gfeid
conservation_unit_system_sites[cond,]
# 51.3207359	-119.318725
# (P)ADAMS AND MOMICH LAKES-EARLY SUMMER TIMING

cond <- all_areas_nuseds$IndexId == iid
POPULATION_focal <- all_areas_nuseds$POPULATION[cond] |> unique()
# "Cayenne Creek (Clearwater) Late Sockeye"

cond <- all_areas_nuseds$IndexId == iid_alter
POPULATION_alter <- all_areas_nuseds$POPULATION[cond] |> unique()
# "Cayenne Creek (Clearwater) Early Summer Sockeye"

cond <- grepl("MOMICH",conservation_unit_system_sites$CU_NAME) & conservation_unit_system_sites$SPECIES == "Sockeye"
conservation_unit_system_sites[cond,]$CU_NAME |> unique()
# "SHUSWAP COMPLEX-EARLY SUMMER TIMING" "SHUSWAP COMPLEX-LATE TIMING"

# 
toRemove <- data.frame(IndexId = iid, 
                       GFE_ID = gfeid, 
                       dataset = "NUSEDS")
toRemove$comment <- paste("Not in CUSS; not merged to ",iid_alter," - ",gfeid," because of different run timing and almost only 0s")

removed_all <- rbind(removed_all,toRemove)

all_areas_nuseds <- remove_rows_fields_fun(dataframe = all_areas_nuseds,
                                           toRemove = toRemove, 
                                           fields = c("IndexId","GFE_ID"))
```

In the case `i =` `r i` above, the focal series `r paste(iid,gfeid,sep = " - ")` has the `POPULATION` = `r POPULATION_focal`, which does not correspond to any `CU_NAME` in **CUSS**. The data cannot be merged to the alternative series `r paste(iid_alter,gfeid,sep = " - ")` because of different run timing. It is consequently deleted from **NUSEDS**.

```{r, include=FALSE}
i <- i + 1 # 10
iid <- trackRecord_nuseds_iid$IndexId[i]
iid_alter <- trackRecord_nuseds_iid$alternative_IndexId[i]
gfeid <- trackRecord_nuseds_iid$GFE_ID[i]

cond <- conservation_unit_system_sites$IndexId == iid_alter & conservation_unit_system_sites$GFE_ID == gfeid
conservation_unit_system_sites[cond,]
# 50.9613153	-119.241305
# SHUSWAP COMPLEX-LATE TIMING

cond <- all_areas_nuseds$IndexId == iid
POPULATION_focal <- all_areas_nuseds$POPULATION[cond] |> unique()
# "Ross Creek (Salmon Arm) Early Summer Sockeye"

cond <- all_areas_nuseds$IndexId == iid_alter
POPULATION_alter <- all_areas_nuseds$POPULATION[cond] |> unique()
# "Ross Creek (Salmon Arm) Late Sockeye"

# is there cu_name_name = Shuswap_Late in CUSS
cond <- grepl("SHUSWAP",conservation_unit_system_sites$CU_NAME) & conservation_unit_system_sites$SPECIES == "Sockeye"
conservation_unit_system_sites[cond,]$CU_NAME |> unique()
# "SHUSWAP COMPLEX-EARLY SUMMER TIMING" "SHUSWAP COMPLEX-LATE TIMING" 

cuss_new <- CUSS_newRow_fun(IndexId = iid, 
                            GFE_ID = gfeid, 
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)


cond <- conservation_unit_system_sites $CU_NAME == "SHUSWAP COMPLEX-EARLY SUMMER TIMING"
for(f in c("CU_NAME","CU_ACRO","CU_LAT","CU_LONGT","CU_TYPE","CU_INDEX","FULL_CU_IN")){
  cuss_new[,f] <- unique(conservation_unit_system_sites[cond,f])
}

conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId = iid,
                    GFE_ID = gfeid,
                    dataset = "CUSS",
                    CU_NAME = NA,
                    comment = paste0("Series not in CUSS, not merged to altenative series IndexId = ",iid_alter," & GHE_ID = ",gfeid," because different run timing and associated to CU_NAME 'SHUSWAP COMPLEX-EARLY SUMMER TIMING'"))

toAdd$CU_NAME <- cuss_new$CU_NAME

added_all <- rbind(added_all,toAdd)
```

In the case `i =` `r i` above, the focal series `r paste(iid,gfeid,sep = " - ")` has the `POPULATION` = `r POPULATION_focal`, which corresponds to the `CU_NAME` = "SHUSWAP COMPLEX-EARLY SUMMER TIMING" in **CUSS**. We consequently do not merge the two series but add the reference of the focal series in **CUSS** to the SHUSWAP COMPLEX-LATE TIMING CU.


```{r, include=FALSE}
i <- i + 1 # 11
iid <- trackRecord_nuseds_iid$IndexId[i]
iid_alter <- trackRecord_nuseds_iid$alternative_IndexId[i]
gfeid <- trackRecord_nuseds_iid$GFE_ID[i]

cond <- conservation_unit_system_sites$IndexId == iid_alter & conservation_unit_system_sites$GFE_ID == gfeid
conservation_unit_system_sites[cond,]
# 51.0845251	-118.896192
# SHUSWAP COMPLEX-EARLY SUMMER TIMING

cond <- all_areas_nuseds$IndexId == iid
POPULATION_focal <- all_areas_nuseds$POPULATION[cond] |> unique()
# "Four Mile Creek (Salmon Arm) Late Sockeye"

cond <- all_areas_nuseds$IndexId == iid_alter
POPULATION_alter <- all_areas_nuseds$POPULATION[cond] |> unique()
# "Four Mile Creek (Salmon Arm) Early Summer Sockeye"

# is there cu_name_name = Shuswap_Late in CUSS
cond <- grepl("SHUSWAP",conservation_unit_system_sites$CU_NAME) & conservation_unit_system_sites$SPECIES == "Sockeye"
conservation_unit_system_sites[cond,]$CU_NAME |> unique()
# "SHUSWAP COMPLEX-EARLY SUMMER TIMING" "SHUSWAP COMPLEX-LATE TIMING" 

cuss_new <- CUSS_newRow_fun(IndexId = iid, 
                            GFE_ID = gfeid, 
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)


cond <- conservation_unit_system_sites $CU_NAME == "SHUSWAP COMPLEX-LATE TIMING"
for(f in c("CU_NAME","CU_ACRO","CU_LAT","CU_LONGT","CU_TYPE","CU_INDEX","FULL_CU_IN")){
  cuss_new[,f] <- unique(conservation_unit_system_sites[cond,f])
}

conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId = iid,
                    GFE_ID = gfeid,
                    dataset = "CUSS",
                    CU_NAME = NA,
                    comment = paste0("Series not in CUSS, not merged to altenative series IndexId = ",iid_alter," & GHE_ID = ",gfeid," because different run timing and associated to CU_NAME 'SHUSWAP COMPLEX-LATE TIMING'"))

toAdd$CU_NAME <- cuss_new$CU_NAME

added_all <- rbind(added_all,toAdd)
```

In the case `i =` `r i` above, the focal series `r paste(iid,gfeid,sep = " - ")` has the `POPULATION` = `r POPULATION_focal`, which corresponds to the `CU_NAME` = "SHUSWAP COMPLEX-LATE TIMING" in **CUSS**. We consequently do not merge the two series but add the reference of the focal series in **CUSS** to the SHUSWAP COMPLEX-LATE TIMING CU.

```{r, include=FALSE}
i <- i + 1 # 12
iid <- trackRecord_nuseds_iid$IndexId[i]
iid_alter <- trackRecord_nuseds_iid$alternative_IndexId[i]
gfeid <- trackRecord_nuseds_iid$GFE_ID[i]

# It is decided to not merge the focal series to the alternative because POPULATION 
# indicates that they belong to different CU.
cond <- conservation_unit_system_sites$IndexId == iid_alter
CU_NAME_alter <- conservation_unit_system_sites$CU_NAME[cond] |> unique()
CU_NAME_alter
# "FRASER-EARLY SUMMER TIMING"

cond <- conservation_unit_system_sites$IndexId == iid_alter
FULL_CU_IN_alter <- conservation_unit_system_sites$FULL_CU_IN[cond] |> unique()
FULL_CU_IN_alter
# "SEL-06-06"

cond <-  all_areas_nuseds$IndexId == iid_alter
POPULATION_alter <- all_areas_nuseds$POPULATION[cond] |> unique()
POPULATION_alter
# "Ormond Creek (Prince George) Summer Sockeye"

FULL_CU_IN_other <- "SEL-06-07"
cond <- conservation_unit_system_sites$FULL_CU_IN == FULL_CU_IN_other
CU_NAME_other <- conservation_unit_system_sites$CU_NAME[cond] |> unique()
# "FRANCOIS/FRASER-SUMMER TIMING"

cond <-  all_areas_nuseds$IndexId == iid
POPULATION_focal <- all_areas_nuseds$POPULATION[cond] |> unique()
POPULATION_focal
# "Ormond Creek (Prince George) Early Summer Sockeye"
```

In the case `i =` `r i` above, the focal series `r paste(iid,gfeid,sep = " - ")` is merged to the alternative series (`indexId` is changed from `r iid` to `r iid_alter` in **NUSEDS**) because the focal `POPULATION` (= `r POPULATION_focal`) is compatible with the alternative `CU_NAME` (= `r CU_NAME_alter`).

```{r, echo = FALSE}
# Remove alternative series from CUSS and NUSEDS
toRemove <- data.frame(IndexId = iid, 
                       GFE_ID = gfeid, 
                       dataset = "NUSEDS")
toRemove$comment <- paste0("Merged to series IndexId = ",iid_alter," - GFE_ID = ",gfeid," because 100% compatible")
removed_all <- rbind(removed_all,toRemove)

# merge series in all_areas_nuseds by changing CN_48442 for CN_7809
all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T,
                                                IndexId_focal = iid,   # yes here the one to change is iid_alter 
                                                IndexId_alter = iid_alter,
                                                GFE_ID_focal = gfeid,
                                                GFE_ID_alter = gfeid,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

```

Note that could be a mismatch between the alternative `POPULATION` (= `r POPULATION_alter`) and its its own `CU_NAME` (= `r CU_NAME_alter`) (`FULL_CU_IN` = `r FULL_CU_IN_alter`), and could instead be better associated with the CU with `CU_NAME` = `r CU_NAME_other` (`FULL_CU_IN` = `r FULL_CU_IN_other`). We are not making any change in that regard.

### Alternative GFE_ID

The focal time series (i.e., a unique `IndexId` - `GFE_ID` not in **CUSS**) are compared to alternative series with a different `GFE_ID` and potentially a different `IndexId` (but of the same species).

```{r, include=FALSE}
cond <- trackRecord_nuseds$alternative_GFE_ID != "none" # &
  # trackRecord_nuseds$alternative_IndexId == "none" &
  # !cond_3
trackRecord_nuseds_gfeid <- trackRecord_nuseds[cond,]
trackRecord_nuseds_gfeid <- trackRecord_nuseds_gfeid[order(trackRecord_nuseds_gfeid$IndexId),]
trackRecord_nuseds_gfeid
nrow(trackRecord_nuseds_gfeid) # 64
trackRecord_nuseds_gfeid$i <- NA
```

There are `r nrow(trackRecord_nuseds_gfeid)` time series concerned:

```{r, echo=FALSE}
show <- trackRecord_nuseds_gfeid[,c("IndexId","GFE_ID","nb_dataPt","alternative_IndexId","alternative_GFE_ID")]
row.names(show) <- NULL
show
```

Notice in the table above that several time series have the same `IndexId`. Again this is problematic because normally only one `GFE_ID` can be associated to a given `IndexId` (i.e., `POP_ID`). We show here after the focal time series grouped with their alternative series. On top of each figure is shown the `POPULATION` and `WATERBODY` associated with each `IndexId` (i.e., `POP_ID`) and `GFE_ID`, respectively. Belong each figure is shown a summary table providing the number of data points (`nb_dataPt`) and the % of them that are `complementary`, `duplicate` and in `conflict` compared with the alternative series. The decision made in each case are provided after the figures, using the index `i` shown at the bottom left of the plots for reference.

```{r, echo = F, fig.width = 15, fig.height = 12}
#' There several instances where a same IndexId appears multiple time (i.e., with
#' a different GFE_ID) but the same GFE_ID is proposed as an alternative.
#' --> consider those in group.
IndexId_GFE_ID_alternative <- unique(paste(trackRecord_nuseds_gfeid$IndexId,
                                           trackRecord_nuseds_gfeid$alternative_GFE_ID,
                                           sep = "&"))
# length(IndexId_GFE_ID_alternative) # 22

# change order based on GFE_ID_alternative
GFE_ID_alternative <- sapply(X = IndexId_GFE_ID_alternative, 
                             FUN = function(x){strsplit(x = x, split = "&")[[1]][2]})

IndexId_GFE_ID_alternative <- IndexId_GFE_ID_alternative[order(GFE_ID_alternative)]

series_compare <- list() # to show the compatibility between the focal and alternative time series
series_MAX_ESTIMATE <- list() # to access the time series later on
for(i in 1:length(IndexId_GFE_ID_alternative)){
  # i <- 1
  # i <- which(IndexId_GFE_ID_alternative == "CM_47925&14")
  # i <- which(IndexId_GFE_ID_alternative == "CN_3333&23735")
  
  iid <- strsplit(IndexId_GFE_ID_alternative[i],"&")[[1]][1]
  gfeid_alter <- strsplit(IndexId_GFE_ID_alternative[i],"&")[[1]][2]
  
  # cond <- trackRecord_nuseds_gfeid$IndexId == iid
  cond_all <- trackRecord_nuseds_gfeid$IndexId == iid & 
    trackRecord_nuseds_gfeid$alternative_GFE_ID == gfeid_alter
  
  gfeids <- trackRecord_nuseds_gfeid$GFE_ID[cond_all]
  
  trackRecord_nuseds_gfeid$i[cond_all] <- i
  
  # trackRecord_nuseds_gfeid[cond_all,]
  
  # check if there is also potential alternative IndexId
  # trackRecord_nuseds_gfeid_cut <- trackRecord_nuseds_gfeid[cond,]
  
  if(any(trackRecord_nuseds_gfeid$alternative_IndexId[cond_all] != "none")){
    m <- matrix(1:2, ncol = 1)
  }else{
    m <- matrix(1)
  }
  
  #'* Case with same IndexId and the alternative GFE_ID *

  #' Make a dataframe to compare the focal time series witht the alternative one (notice it is "one" and not "ones")
  cond_nuseds <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID == gfeid_alter
  series_alter <- all_areas_nuseds$MAX_ESTIMATE[cond_nuseds]
  names(series_alter) <- all_areas_nuseds$Year[cond_nuseds]
  
  compare <- data.frame(IndexId = rep(iid,length(gfeids)),
                        GFE_ID = gfeids,
                        IndexId_alter = rep(NA,length(gfeids)),
                        GFE_ID_alter = rep(gfeid_alter,length(gfeids)))
  
  compare2 <- sapply(X = gfeids, FUN = function(g){
    cond <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID == g
    series_focal <- all_areas_nuseds$MAX_ESTIMATE[cond]
    names(series_focal) <- all_areas_nuseds$Year[cond]
    out <- compare_series_fun(series_focal = series_focal, 
                              series_compare = series_alter,
                              percentage = T)
    return(out)
  })
  compare2 <- as.data.frame(t(compare2))
  
  compare <- cbind(compare,compare2)
  rownames(compare) <- NULL
  
  # Fill the series_MAX_ESTIMATE and series_compare lists
  series_df <- data.frame(year = as.numeric(names(series_alter)),
                          s = series_alter)
  names(series_df)[names(series_df) == "s"] <- paste(iid,gfeid_alter,sep="-")
  for(g in gfeids){
    cond <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID == g
    series_df_here <- data.frame(year = all_areas_nuseds$Year[cond],
                                 s = all_areas_nuseds$MAX_ESTIMATE[cond])
    names(series_df_here)[names(series_df_here) == "s"] <- paste(iid,g,sep = "-")
    
    series_df <- base::merge(x = series_df, y =  series_df_here, 
                             by = "year", all = T)
  }
  series_df$sum <- rowSums(series_df[colnames(series_df) != "year"], na.rm = T)
  
  series_MAX_ESTIMATE[[i]] <- series_df
  names(series_MAX_ESTIMATE)[i] <- paste0("i=",i)
  
  series_compare[[i]] <- compare
  names(series_compare)[i] <- paste0("i=",i)
  
  # in case these alternative IndexId:
  if(any(trackRecord_nuseds_gfeid$alternative_IndexId[cond_all] != "none")){
    
    # compare:
    cond_iid <- cond_all & trackRecord_nuseds_gfeid$alternative_IndexId != "none"

    compare_iid <- data.frame(IndexId = trackRecord_nuseds_gfeid$IndexId[cond_iid],
                              GFE_ID = trackRecord_nuseds_gfeid$GFE_ID[cond_iid],
                              IndexId_alter = trackRecord_nuseds_gfeid$alternative_IndexId[cond_iid],
                              GFE_ID_alter = rep(NA,sum(cond_iid)))
    
    compare_iid2 <- sapply(X = 1:nrow(trackRecord_nuseds_gfeid[cond_iid,]), 
                           FUN = function(z){
                             # z <- 1
                             cond <- all_areas_nuseds$IndexId == trackRecord_nuseds_gfeid$IndexId[cond_iid][z] &
                               all_areas_nuseds$GFE_ID == trackRecord_nuseds_gfeid$GFE_ID[cond_iid][z] # == gfeid
                             series_focal <- all_areas_nuseds$MAX_ESTIMATE[cond]
                             names(series_focal) <- all_areas_nuseds$Year[cond]
                             
                             cond <- all_areas_nuseds$IndexId == trackRecord_nuseds_gfeid$alternative_IndexId[cond_iid][z] &
                               all_areas_nuseds$GFE_ID == trackRecord_nuseds_gfeid$GFE_ID[iid][z] # == gfeid
                             series_alter <- all_areas_nuseds$MAX_ESTIMATE[cond]
                             names(series_alter) <- all_areas_nuseds$Year[cond]
                             out <- compare_series_fun(series_focal = series_focal, 
                                                       series_compare = series_alter,
                                                       percentage = T)
                             return(out)
                           })
    compare_iid2 <- as.data.frame(t(compare_iid2))
    
    compare_iid <- cbind(compare_iid,compare_iid2)
    rownames(compare_iid) <- NULL
    
    compare <- rbind(compare,compare_iid)
    
    series_compare[[i]] <- compare
    
    # time series:
    for(r in 1:nrow(trackRecord_nuseds_gfeid[cond_iid,])){
      # r <- 1
      
      alternative_IndexId <- strsplit(trackRecord_nuseds_gfeid$alternative_IndexId[cond_iid]," ; ") # in case there are > 1
      alternative_IndexId <- unlist(alternative_IndexId)
      
      cond <- all_areas_nuseds$IndexId %in% alternative_IndexId &
        all_areas_nuseds$GFE_ID == trackRecord_nuseds_gfeid$GFE_ID[cond_iid][r] # gfeid
      
      series_df_here <- data.frame(year = all_areas_nuseds$Year[cond],
                                   s = all_areas_nuseds$MAX_ESTIMATE[cond])
      
      names(series_df_here)[names(series_df_here) == "s"] <- paste(trackRecord_nuseds_gfeid$alternative_IndexId[cond_iid][r],
                                                                   trackRecord_nuseds_gfeid$GFE_ID[cond_iid][r],
                                                                   sep = "-")
      
      series_df <- base::merge(x = series_df, y =  series_df_here, 
                               by = "year", all = T)
      
      series_MAX_ESTIMATE[[i]] <- series_df
    }
  }
  
  ylim <- range(series_df[,!colnames(series_df) %in% c("year","sum")], na.rm = T)
  xlim <- range(series_df$year)
  
  print(paste("*** i =",i,"***"))
  print(compare)
  
  # plot
  layout(m)
  
  if(any(trackRecord_nuseds_gfeid$alternative_IndexId[cond_all] != "none")){ # if two plot on top of each others
    side1 <- 0
    xaxt <- "n"
    xlab <- ""
  }else{
    side1 <- 2.5
    xaxt <- "s"
    xlab <- "Years"
  }
  
  par(mar = c(side1,4.5,3,.5))
  
  WATERBODYs <- sapply(X = c(gfeid_alter,gfeids),FUN = function(g){
    cond <- all_areas_nuseds$GFE_ID == g
    return(unique(all_areas_nuseds$WATERBODY[cond]))
  })
  
  cond <- all_areas_nuseds$IndexId == iid
  POPULATION <- unique(all_areas_nuseds$POPULATION[cond])
  
  plot_IndexId_GFE_ID_fun(IndexIds = rep(iid,length(gfeids) + 1),
                          GFE_IDs = c(gfeid_alter,gfeids),
                          all_areas_nuseds = all_areas_nuseds, 
                          Xlim = xlim, Ylim = ylim, 
                          xlab = xlab, xaxt = xaxt)
  
  mtext("IndexId - GFE_ID", side = 3, line = 1, adj = 0)
  mtext("POPULATION", side = 3, line = 1, adj = .5)
  mtext("WATERBODY", side = 3, line = 1, adj = 1)
  space_here <- "                                           "
  # text_here <- paste(space_here,c("alternative","focal"), sep = "")
  text_here <- paste(space_here,c("alternative",rep("focal",length(gfeids))), sep = "")
  legend("topleft",text_here, col = NA, pch = 16, lwd = 2, bty = "n")
  legend("top",POPULATION,bty = "n")
  legend("topright",WATERBODYs,bty = "n")
  legend("bottomleft",paste("i =",i),bty = "n")
  
  # case with alternative IndexId:
  if(any(trackRecord_nuseds_gfeid$alternative_IndexId[cond_all] != "none")){
    
    par(mar = c(4.5,4.5,.5,.5))
    
    series_iid <- trackRecord_nuseds_gfeid[cond_iid,c("IndexId","GFE_ID")]
    series_iid$focal <- T
    
    alternative <- trackRecord_nuseds_gfeid[cond_iid,c("alternative_IndexId","GFE_ID")]
    alternative$focal <- F
    colnames(alternative) <- c("IndexId","GFE_ID","focal")
    
    if(any(grepl(";",alternative$IndexId))){
      
      alternative_new <- NULL
      for(r in 1:nrow(alternative)){
        
        row_here <- alternative[r,]
        if(grepl(";",row_here$IndexId)){
          
          IndexId_here <- strsplit(row_here$IndexId," ; ")[[1]]
          alternative_new_here <- lapply(IndexId_here, function(iid){
            out <- row_here
            out$IndexId <- iid
            return(out)
          })
          
          alternative_new_here <- do.call(rbind,alternative_new_here)
          
        }else{
          alternative_new_here <- row_here
        }
        
        if(is.null(alternative_new)){
          alternative_new <- alternative_new_here
        }else{
          alternative_new <- rbind(alternative_new,alternative_new_here)
        }
      }
      alternative <- alternative_new
    }
    
    series_iid <- rbind(series_iid,alternative)
    
    plot_IndexId_GFE_ID_fun(IndexIds = series_iid$IndexId,
                            GFE_IDs = series_iid$GFE_ID,
                            all_areas_nuseds = all_areas_nuseds,
                            Xlim = xlim, Ylim = ylim)
    
    POPULATION <- sapply(X = series_iid$IndexId,
                         FUN = function(g){
                           cond <- all_areas_nuseds$IndexId == g
                           return(unique(all_areas_nuseds$POPULATION[cond]))
                         })
    
    text_here <- paste(space_here,
                       c(rep("alternative",sum(cond_iid)),"focal"), sep = "")
    
    text_here <- sapply(series_iid$focal,function(f){
      if(f){
        "focal"
      }else{
        "alternative"
      }
    })
    
    text_here <- paste(space_here,text_here)
    
    WATERBODYs_here <- sapply(series_iid$GFE_ID,function(g){
      cond <- all_areas_nuseds$GFE_ID == g
      out <- unique(all_areas_nuseds$WATERBODY[cond])
      return(out)
    })
    
    POPULATIONs_here <- sapply(series_iid$IndexId,function(i){
      cond <- all_areas_nuseds$IndexId == i
      out <- unique(all_areas_nuseds$POPULATION[cond])
      return(out)
    })
    
    legend("topleft",text_here, col = NA, pch = 16, lwd = 2, bty = "n")
    legend("topright",WATERBODYs_here, bty = "n")
    legend("top",POPULATIONs_here, bty = "n")
    legend("bottomleft",paste("i =",i),bty = "n")
  }
}
```

```{r, include = F}
#' Cases with SOMASS-SPROAT-GC SYSTEM  (i = 1 to 4) ***
#' CM (i = 1) --> merge potentially but check streamID --> only a few make it up the falls --> keep separate 
#' CN (i = 2) --> combine red and green and remove blue --> SUM ALL OF THEM because most individual chinook would pass the falls
#' PK (i = 3) --> ?
#' SX (i = 4) --> top plot: don't mix, bottom: combine series and FLAG TO BRUCE cf. email forwarded


#' CM (i = 1) keep separate because only a few make it up the falls
#' Need to add the time series to CUSS --> new GFE_ID
i <- 1
cond_i <- trackRecord_nuseds_gfeid$i == i
iid <- trackRecord_nuseds_gfeid$IndexId[cond_i] |> unique()
gfeid <- trackRecord_nuseds_gfeid$GFE_ID[cond_i]
gfeid_a <-  trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i] |> unique()
```

In case i = `r i`: series `r paste(iid,gfeid[1],sep = " - ")` is not merged to alternative series `r paste(iid,gfeid_a,sep = " - ")` because these are different streams. Consequently, the reference of the focal series is added to **CUSS**. There other focal two time series `r paste(iid,gfeid[2],sep = " - ")` and `r paste(iid,gfeid[3],sep = " - ")` are removed from **NUSEDS** because they only have \< 4 data points and are anterior to 2020.

Note that `GFE_ID` = `r gfeid_a` is present in the **DFO streams** file (under `ID`) but coordinates are not:

```{r, echo=FALSE}
cuss_new <- CUSS_newRow_fun(IndexId = iid, 
                            GFE_ID = gfeid[1], # 11486
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

# the GFE_ID is not in CUSS so the GIS information has to be found by hand:
# c(cuss_new$Y_LAT,cuss_new$X_LONGT)

# And the GFE_ID is not in the DFO streams  file:
cond <- DFO_All_Streams_Segments$ID == as.numeric(gfeid[1])
DFO_All_Streams_Segments[cond,]
```

However, the `GFE_ID` and coordinates are in the DFO hatchery file so we use these values:

```{r,echo=FALSE}
cond <- DFO_hatchery$STOCK_GFE_ID == as.numeric(gfeid[1]) & !is.na(DFO_hatchery$STOCK_GFE_ID)
show <- unique(DFO_hatchery[cond,c("STOCK_GFE_ID","STOCK_WATERBODY_NAME","STOCK_LATITUDE","STOCK_LONGITUDE")])
show <- as.data.frame(show)
show
```

```{r, include=FALSE}
# add to conservation_unit_system_sites

cuss_new$X_LONGT <- DFO_hatchery$STOCK_LONGITUDE[cond] |> unique()
cuss_new$Y_LAT <- DFO_hatchery$STOCK_LATITUDE[cond] |> unique()
cuss_new$coordinates_changed <- F

conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId = iid,
                    GFE_ID = gfeid,
                    dataset = "CUSS",
                    CU_NAME = NA,
                    comment = paste0("Series not in CUSS, not merged to altenative series IndexId = ",iid," & GHE_ID = ",gfeid_a," because upper location; GFE_ID not in CUSS so coordinates found in hatchery dataset"))

toAdd$CU_NAME <- cuss_new$CU_NAME

added_all <- rbind(added_all,toAdd)


# remove the other two series
removed <- data.frame(IndexId = iid, # "CM_3305",
                      GFE_ID = 11487)
removed$dataset <- "NUSEDS"
removed$comment <- "Series not in CUSS; < 4 data points; not merged to potential series IndexId = CM_3305 & GFE_ID = 11485"
removed_all <- rbind(removed_all,removed)

all_areas_nuseds <- remove_rows_fields_fun(dataframe = all_areas_nuseds, 
                                           toRemove = removed, 
                                           fields = c("IndexId","GFE_ID"))


removed <- data.frame(IndexId = iid, # "CM_3305",
                      GFE_ID = 11488)
removed$dataset <- "NUSEDS"
removed$comment <- "Series not in CUSS; < 4 data points; not merged to potential series IndexId = CM_3305 & GFE_ID = 11485"
removed_all <- rbind(removed_all,removed)

all_areas_nuseds <- remove_rows_fields_fun(dataframe = all_areas_nuseds, 
                                           toRemove = removed, 
                                           fields = c("IndexId","GFE_ID"))

```

```{r, include=FALSE}
#' CN (i = 2) 
#' --> add green to CUSS
#' --> remove blue because points are in conflict with green and there 
#' are only four of them.
# obtain a new CUSS row:
i <- i + 1 # 2
cond_i <- trackRecord_nuseds_gfeid$i == i
iid <- trackRecord_nuseds_gfeid$IndexId[cond_i] |> unique()
gfeid <- trackRecord_nuseds_gfeid$GFE_ID[cond_i] |> unique()

cuss_new <- CUSS_newRow_fun(IndexId = "CN_3306", 
                            GFE_ID = 11486,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

# add to conservation_unit_system_sites
conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId = "CN_3306",
                    GFE_ID = 11486,
                    dataset = "CUSS",
                    CU_NAME = NA,
                    comment = "Series not in CUSS, not merged to altenative series INdexId = CN_3306 & GHE_ID = 11485 because upper location; GFE_ID not in CUSS so coordinates were defined by hand")

toAdd$CU_NAME <- cuss_new$CU_NAME

added_all <- rbind(added_all,toAdd)

#' remove other time series
removed <- data.frame(IndexId = "CN_3306",
                      GFE_ID = 11487)
removed$dataset <- "NUSEDS"
removed$comment <- "Series not in CUSS; < 4 data points; anterior to 2020; not merged to potential series IndexId = CN_3306 & GFE_ID = 11485"
removed_all <- rbind(removed_all,removed)

all_areas_nuseds <- remove_rows_fields_fun(dataframe = all_areas_nuseds, 
                                           toRemove = removed, 
                                           fields = c("IndexId","GFE_ID"))
#
removed <- data.frame(IndexId = "CN_3306",
                      GFE_ID = 11488)
removed$dataset <- "NUSEDS"
removed$comment <- "Series not in CUSS; only 4 data points; ; anterior to 2020; not merged to potential series IndexId = CN_3306 & GFE_ID = 11485"
removed_all <- rbind(removed_all,removed)

all_areas_nuseds <- remove_rows_fields_fun(dataframe = all_areas_nuseds, 
                                           toRemove = removed, 
                                           fields = c("IndexId","GFE_ID"))

```

In case i = `r i`: series `r paste(iid,"11486",sep = " - ")` in green is not merged to alternative series `r paste(iid,"11485",sep = " - ")` in red for the same reason as above; its reference are instead added to **CUSS**. The other focal series `r paste(iid,"11487",sep = " - ")` and `r paste(iid,"11488",sep = " - ")` are deleted because they have \<= 4 data points and are anterior to 2020.

```{r, include=FALSE}
#' CO (i = 3) CO_3303
i <- i + 1 # 3
cond_i <- trackRecord_nuseds_gfeid$i == i
iid <- trackRecord_nuseds_gfeid$IndexId[cond_i] |> unique()
gfeid <- trackRecord_nuseds_gfeid$GFE_ID[cond_i]
gfeid_a <- trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i] |> unique()

#' remove other time series
removed <- data.frame(IndexId = iid,
                      GFE_ID = 11487)
removed$dataset <- "NUSEDS"
removed$comment <- "Series not in CUSS; < 4 data points; anterior to 2020; not merged to potential series IndexId = CO_3303 & GFE_ID = 11485"
removed_all <- rbind(removed_all,removed)

all_areas_nuseds <- remove_rows_fields_fun(dataframe = all_areas_nuseds, 
                                           toRemove = removed, 
                                           fields = c("IndexId","GFE_ID"))
#
removed <- data.frame(IndexId = iid,
                      GFE_ID = 11488)
removed$dataset <- "NUSEDS"
removed$comment <- "Series not in CUSS; only 4 data points; ; anterior to 2020; not merged to potential series IndexId = CO_3303 & GFE_ID = 11485"
removed_all <- rbind(removed_all,removed)

all_areas_nuseds <- remove_rows_fields_fun(dataframe = all_areas_nuseds, 
                                           toRemove = removed, 
                                           fields = c("IndexId","GFE_ID"))
```

In case i = `r i`: focal series `r paste(iid,"11487",sep = " - ")` and `r paste(iid,"11488",sep = " - ")` are removed from **NUSEDS** because their `GFE_ID` correspond to different locations, they have \< 4 data points and they are anterior to 2020.

```{r, include=FALSE}
#' PKE
#' --> add blue to CUSS
i <- i + 1 # 4
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]

cuss_new <- CUSS_newRow_fun(IndexId = "PKE_3304",
                            GFE_ID = 11486,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

# add to conservation_unit_system_sites
conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId = "PKE_3304",
                    GFE_ID = 11486,
                    dataset = "CUSS",
                    CU_NAME = NA,
                    comment = "Series not in CUSS, not merged to altenative series INdexId = PKE_3304 & GHE_ID = 11485 because upper location; GFE_ID not in CUSS so coordinates were define by hand")

toAdd$CU_NAME <- cuss_new$CU_NAME

added_all <- rbind(added_all,toAdd)
```

In case i = `r i`: series `r paste("PKE_3304","11486",sep = " - ")` in blue is not merged to alternative series `r paste("PKE_3304","11485",sep = " - ")` in red for the same reason as above; its reference are instead added to **CUSS**.

```{r, include=FALSE}
#' PKO 
#' --> add blue to CUSS
i <- i + 1 # 5
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]

cuss_new <- CUSS_newRow_fun(IndexId = "PKO_3304",
                            GFE_ID = 11486,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

# add to conservation_unit_system_sites
conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId = "PKO_3304",
                    GFE_ID = 11486,
                    dataset = "CUSS",
                    CU_NAME = NA,
                    comment = "Series not in CUSS, not merged to altenative series INdexId = PKO_3304 & GHE_ID = 11485 because upper location; GFE_ID not in CUSS so coordinates were define by hand")

toAdd$CU_NAME <- cuss_new$CU_NAME

added_all <- rbind(added_all,toAdd)
```

In case i = `r i`: series `r paste("PKO_3304","11486",sep = " - ")` in blue is not merged to alternative series `r paste("PKO_3304","11485",sep = " - ")` in red for the same reason as above; its reference are instead added to **CUSS**.

```{r, include=FALSE}
#' SX (i = 6)
#' In bottom plot:
#' --> merge SX_3302 - 3416 (black) to SX_3310 - 3416 (red) in NUSEDS
#' --> merge SX_3302 - 3444 (blue)  to SX_3325 - 3444 (green) in NUSEDS
i <- i + 1 # 6 
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]
 
all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "SX_3302",
                                                IndexId_alter = "SX_3310",
                                                GFE_ID_focal = 3416,
                                                GFE_ID_alter = 3416,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "SX_3302",
                                                IndexId_alter = "SX_3325",
                                                GFE_ID_focal = 3444,
                                                GFE_ID_alter = 3444,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

removed <- data.frame(IndexId = c("CN_3306","SX_3302"),
                      GFE_ID = c(3416,3444))
removed$dataset <- "NUSEDS"
removed$comment <- c("Series not in CUSS, merged to alternative series IndexId = SX_3310 & GFE_ID = 3416",
                     "Series not in CUSS, merged to alternative series IndexId = SX_3325 & GFE_ID = 3444")
removed_all <- rbind(removed_all,removed)
```

In case i = `r i`: series `r paste("PKO_3302","3416",sep = " - ")` in black (bottom plot) is merged to alternative series `r paste("SX_3310","3416",sep = " - ")` in red and series `r paste("PKO_3302","3444",sep = " - ")` in blue (bottom plot) is merged to alternative series `r paste("SX_3325","3444",sep = " - ")` in green.

```{r, include=FALSE}
# CO_47183
i <- i + 1 # 7 
cond_i <- trackRecord_nuseds_gfeid$i == i
iid <- trackRecord_nuseds_gfeid$IndexId[cond_i]
gfeid <- trackRecord_nuseds_gfeid$GFE_ID[cond_i]
gfeid_a <- trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]

cond <- conservation_unit_system_sites$GFE_ID == 129
unique(conservation_unit_system_sites[cond,c("SYSTEM_SITE","Y_LAT","X_LONGT")])
# PORTAGE CREEK 50.7083513	-122.269389	

cond <- conservation_unit_system_sites$GFE_ID == 2451
unique(conservation_unit_system_sites[cond,c("SYSTEM_SITE","Y_LAT","X_LONGT")])
# SETON CHANNELS - UPPER AND LOWER 50.6725081	-121.942915	

#
all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = iid,
                                                IndexId_alter = iid,
                                                GFE_ID_focal = gfeid,
                                                GFE_ID_alter = gfeid_a,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

plot_IndexId_GFE_ID_fun(IndexIds = c(iid,iid),
                        GFE_IDs = c(gfeid,gfeid_a),
                        all_areas_nuseds = all_areas_nuseds)

#
removed <- data.frame(IndexId = c("CO_47183"),
                      GFE_ID = c(129))
removed$dataset <- "NUSEDS"
removed$comment <- "Series not in CUSS; it is merged to alternative series IndexId = CO_47183 & GFE_ID = 2451 because the two locations are part of the same stream"
removed_all <- rbind(removed_all,removed)
```

In case i = `r i`: series `r paste("CO_47183","2451",sep = " - ")` in blue is merged to alternative series `r paste("CO_47183","129",sep = " - ")` in red because the location of the focal series leads to the location of the alternative series.

```{r, include=FALSE}
#' Cases with ALOUETTE RIVER
#' CM_47925
#' those are probably summed up -> a bit higher in PSE
#' In bottom plot: merge blue to red
#' In top plot: create new series in CUSS for black and blue
i <- i + 1 # 8 
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]

trackRecord_nuseds_gfeid[cond_i,]

#' In bottom plot: merge CM_47925 - 15 to CM_47928 - 15
#' CM_47925 --> CM_47928
removed <- data.frame(IndexId = c("CM_47925"),
                      GFE_ID = c(15))
removed$dataset <- "NUSEDS"
removed$comment <- c("Series not in CUSS, merged to alternative series IndexId = CM_47928 & GFE_ID = 15")
removed_all <- rbind(removed_all,removed)

all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "CM_47925",
                                                IndexId_alter = "CM_47928",
                                                GFE_ID_focal = 15,
                                                GFE_ID_alter = 15,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

#' In bottom plot: merge CM_47925 - 17 to CM_47939 - 17
#' CM_47925 --> CM_47939
removed <- data.frame(IndexId = c("CM_47925"),
                      GFE_ID = c(17))
removed$dataset <- "NUSEDS"
removed$comment <- c("Series not in CUSS, merged to alternative series IndexId = CM_47939 & GFE_ID = 17")
removed_all <- rbind(removed_all,removed)

all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "CM_47925",
                                                IndexId_alter = "CM_47939",
                                                GFE_ID_focal = 17,
                                                GFE_ID_alter = 17,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

```

In case i = `r i`: the focal series `r paste("CM_47925","15",sep = " - ")` in red (bottom plot) is merged to the alternative series `r paste("CM_47928","15",sep = " - ")` in back (bottom plot).

Similarly, the focal series `r paste("CM_47925","17",sep = " - ")` in green (bottom plot) is merged to the alternative series `r paste("CM_47939","17",sep = " - ")` in blue (bottom plot).

The other two focal series `r paste("CM_47925","31516",sep = " - ")` in black (top plot) and `r paste("CM_47925","31740",sep = " - ")` in blue (top plot) are added to **CUSS**. Their `GFE_IDs` are not in **CUSS** and their are in the **DFO streams file**.

```{r, include=FALSE}
#' In top plot: create new series in CUSS for black and blue
#' - black: CM_47925 - 31516 --> GFE_ID not in CUSS, need to find the coordinates
#' - blue:  CM_47925 - 31740 --> GFE_ID not in CUSS, need to find the coordinates
cuss_new <- CUSS_newRow_fun(IndexId = "CM_47925",
                            GFE_ID = 31516,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

# it is not in the original conservation_unit_system_sites_all:
cond <- conservation_unit_system_sites_all$GFE_ID == 31516
sum(cond) 
cuss_new$SYSTEM_SITE # MILLIONAIRE CREEK
cuss_new$Y_LAT
cuss_new$X_LONGT

# The coordinates are in DFO_All_Streams_Segments:
cond <- DFO_All_Streams_Segments$ID == 31516
DFO_All_Streams_Segments[cond,]
cuss_new$Y_LAT <- DFO_All_Streams_Segments$Y_LAT[cond] |> as.numeric()
cuss_new$X_LONGT <- DFO_All_Streams_Segments$X_LONGT[cond] |> as.numeric()
cuss_new$coordinates_changed <- F

# add to conservation_unit_system_sites
conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId = "CM_47925",
                    GFE_ID = 31516,
                    dataset = "CUSS",
                    CU_NAME = cuss_new$CU_NAME,
                    comment = "Series not in CUSS, not merged to altenative series IndexId = CM_47925 & GHE_ID = 14 because different location; GFE_ID not in CUSS but in DFO streams file")

added_all <- rbind(added_all,toAdd)
```

```{r, include=FALSE}
cuss_new <- CUSS_newRow_fun(IndexId = "CM_47925",
                            GFE_ID = 31740,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

# it is not in the original conservation_unit_system_sites_all:
cond <- conservation_unit_system_sites_all$GFE_ID == 31740
sum(cond) 
cuss_new$SYSTEM_SITE # LATIMER CREEK
cuss_new$Y_LAT
cuss_new$X_LONGT

# The coordinates are in DFO_All_Streams_Segments:
cond <- DFO_All_Streams_Segments$ID == 31740
DFO_All_Streams_Segments[cond,]
cuss_new$Y_LAT <- DFO_All_Streams_Segments$Y_LAT[cond] |> as.numeric()
cuss_new$X_LONGT <- DFO_All_Streams_Segments$X_LONGT[cond] |> as.numeric()
cuss_new$coordinates_changed <- F

# add to conservation_unit_system_sites
conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId = "CM_47925",
                    GFE_ID = 31740,
                    dataset = "CUSS",
                    CU_NAME = cuss_new$CU_NAME,
                    comment = "Series not in CUSS, not merged to altenative series IndexId = CM_47925 & GHE_ID = 14 because different location; GFE_ID not in CUSS but in DFO streams files")

added_all <- rbind(added_all,toAdd)
```

```{r, include=FALSE}
#' Cases with SWIFT RIVER / COTTONWOOD RVER (i = 9)
#' Fraser
#' CN_47277
#' --> combined in the PSE same in the PSE: Middle Fraser River Spring 
#' TODO: merge the the blue series to the red
#' --> change GFE_ID 2464 to 142

#' CORRECTION: we do not do the change above but instead create a new row in 
#' conservation_unit_system_sites

#' UPDATE: It was decided to merge CN_47277 - 142 to  CN_47277 - 2464 and to add 
#' CN_47277 - 2464 to CUSS 
#' REASON: will would have to deal with an issue after merging NUSEDS and CUSS otherwise
#' with the series 

i <- i + 1 # 9 
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]

series_MAX_ESTIMATE[i]
```

In case i = `r i`: it is a special situation deserving more attention. There are two different issues related to `CN_47277`: (1) it is associated to two locations (`GFE_IDs`) and (2) in one location (`GFE_ID = 142`), there is another time series with `IndexId = CN_2483`, which belong to the same CU:

```{r,echo=FALSE,  fig.width = 15, fig.height = 12}
layout(matrix(1:2, nrow = 2)) 
par(mar = c(5,5,.5,.5))
plot_IndexId_GFE_ID_fun(IndexIds = rep("CN_47277",2),
                        GFE_IDs = c(142,2464),
                        all_areas_nuseds = all_areas_nuseds, 
                        main = "")
legend("top",paste0(c("PROBLEM:","Same POP_ID in two locations")),bty = "n")

plot_IndexId_GFE_ID_fun(IndexIds = c("CN_47277","CN_2483"),
                        GFE_IDs = c(142,142),
                        all_areas_nuseds = all_areas_nuseds, 
                        main = "")
legend("top",paste0(c("PROBLEM:","Two POP_IDs of same CU in same location")),bty = "n")

cond <- conservation_unit_system_sites$IndexId %in% c("CN_47277","CN_2483")
CU_NAMES <- (conservation_unit_system_sites$CU_NAME[cond])
legend("topright",CU_NAMES,bty = "n")
mtext(text = "CU_NAME",side = 3,adj = 1)
```

```{r,echo=FALSE}
cond <- conservation_unit_system_sites$GFE_ID %in% c(2464,142)
show <- conservation_unit_system_sites[cond,c("SYSTEM_SITE","GFE_ID","X_LONGT","Y_LAT")] |> unique()
rownames(show) <- NULL
```

The `SYSTEM_SITE` for `GFE_ID` = 142 is:

```{r, echo=FALSE}
show
```

The `GFE_ID = 2464` is not in **CUSS** but it is in the **DFO streams file** but does not have coordinates:

```{r,echo=FALSE}
cond <- DFO_All_Streams_Segments$ID == 2464
show <- DFO_All_Streams_Segments[cond,] |> as.data.frame()
rownames(show) <- NULL
show
```

Notice above that the `NME` (= `SYSTEM_SITE`) for `ID` (= `GFE_ID`) `= 2464` matches the `POPULATION` of `CN_47277`, which is not the case for `GFE_ID = 142`:

```{r,echo=FALSE}
cond <- all_areas_nuseds$IndexId %in% c("CN_47277","CN_2483")
show <- unique(all_areas_nuseds[cond,c("IndexId","POPULATION")])
rownames(show) <- NULL
show
```

**DECISION**: we decide to merge the alternative series `CN_47277 - 142` to the focal series `CN_47277 - 2464` in **NUSEDS** and to add `CN_47277 - 2464` to **CUSS** (and to then remove `CN_47277 - 142` from **CUSS**):

```{r, include=FALSE}
# add CN_47277 - 2464 to CUSS
cuss_new <- CUSS_newRow_fun(IndexId = "CN_47277", 
                            GFE_ID = 2464,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

# The coordinates are not in DFO_All_Streams_Segments:
cond <- DFO_All_Streams_Segments$ID == 2464
DFO_All_Streams_Segments[cond,]
 
#' Consequently the coordinate where defined using Google Maps and they correspond 
#' to the mouth of Cottonwood river
cuss_new$X_LONGT <- -122.610584
cuss_new$Y_LAT <- 53.119965
cuss_new$coordinates_changed <- T

conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId ="CN_47277",
                    GFE_ID = 2464,
                    dataset = "CUSS",
                    CU_NAME = cuss_new$CU_NAME,
                    comment = "GFE_ID not in CUSS, series CN_47277 - 142 was merged to it")

added_all <- rbind(added_all,toAdd)


# merge `CN_47277 - 142` to the focal series `CN_47277 - 2464` in **NUSEDS**
cond_CN_47277 <- all_areas_nuseds$IndexId == "CN_47277"
cond_gfe_id_142 <- all_areas_nuseds$GFE_ID == 142
cond_gfe_id_2464 <- all_areas_nuseds$GFE_ID == 2464
for(f in fields_l$NUSEDS$GFE_ID){
  all_areas_nuseds[,f][cond_gfe_id_142 & cond_CN_47277] <- unique(all_areas_nuseds[,f][cond_gfe_id_2464 & cond_CN_47277])
}

plot_IndexId_GFE_ID_fun(IndexIds = c("CN_47277","CN_47277"),
                        GFE_IDs = c(2464,142),
                        all_areas_nuseds = all_areas_nuseds)

# edit removed_all
removed <- data.frame(IndexId = c("CN_47277"),
                      GFE_ID = c(142))
removed$dataset <- "NUSEDS"
removed$comment <- "Merged to series CN_47277 & GFE_ID = 2464 to match POPULATION and SYSTEM_SITE and avoid issue of multiple time series of same CU in same location"
removed_all <- rbind(removed_all,removed)

# finally remove the reference CN_47277 - 142 in CUSS
cond <- conservation_unit_system_sites$IndexId == "CN_47277" &
  conservation_unit_system_sites$GFE_ID == 142

conservation_unit_system_sites <- conservation_unit_system_sites[!cond,]

removed <- data.frame(IndexId = c("CN_47277"),
                      GFE_ID = c(142))
removed$dataset <- "CUSS"
removed$comment <- "Merged to series CN_47277 & GFE_ID = 2464 in NUSEDS (which was added to CUSS) to match POPULATION and SYSTEM_SITE and avoid issue of multiple time series of same CU in same location"
removed_all <- rbind(removed_all,removed)
```

```{r, echo=FALSE}
plot_IndexId_GFE_ID_fun(IndexIds = c("CN_47277","CN_47277"),
                        GFE_IDs = c(2464,142),
                        all_areas_nuseds = all_areas_nuseds)
```

As show above, there is no coordinates for the location with `GFE_ID = 2464`. We consequently defined them manually using Google Maps; they corresponds to the mouth of Cottonwood river:

```{r, echo=FALSE}
rownames(cuss_new) <- NULL
cuss_new[,c("SYSTEM_SITE","GFE_ID","X_LONGT","Y_LAT")]
```

```{r, include=FALSE}
#' Cases with NICOLA RIVER
#' CO_46170
#' TODO: 
#' - merge CO_46170 --> GFE_ID from 2461 to 213 
#' - create a new series in CUSS for the other two because the dam is closer to the 
#' UPPER NICOLA RIVER and should consequently not be merged to lower parts of the 
#' river. The dam is even closer to Clapperton Creek, which the time series is 
#' shown below. But its POP_ID is different so merging is excluded.
i <- i + 1 # 10 
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]

series_MAX_ESTIMATE[i]
```

In case i = `r i`: the focal series `r paste("CO_46170","2461",sep = " - ")` in dark green (top plot) is merged to the alternative series `r paste("CO_46170","213",sep = " - ")` in red.

```{r, echo=FALSE}
# cond <- grepl("CLAPPERTON",all_areas_nuseds$WATERBODY)
# sum(cond)
# unique(all_areas_nuseds$IndexId[cond])
# unique(all_areas_nuseds$GFE_ID[cond])
# plot_IndexId_GFE_ID_fun(IndexIds = c("CO_46170","CO_44965"),
#                         GFE_IDs = c(54282,2370),
#                         all_areas_nuseds = all_areas_nuseds)

#' - merge green to blue --> GFE_ID from 2461 to 213 in NUSEDS
all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "CO_46170",
                                                IndexId_alter = "CO_46170",
                                                GFE_ID_focal = 2461,
                                                GFE_ID_alter = 213,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

removed <- data.frame(IndexId = c("CO_46170"),
                      GFE_ID = c(2461))
removed$dataset <- "NUSEDS"
removed$comment <- "Series not in CUSS, merged to series CO_46170 & GFE_ID = 213"
removed_all <- rbind(removed_all,removed)
```

The other focal series `r paste("CO_46170","54282",sep = " - ")` in black ("DAM"; top plot) is instead added to **CUSS**. Its `GFE_ID` is not in **CUSS**: 

```{r, echo=FALSE}
cond <- conservation_unit_system_sites$ID == 54282
conservation_unit_system_sites[cond,c("SYSTEM_SITE","GFE_ID","Y_LAT","X_LONGT")]
```

It is also not in the **DFO hatchery file**:

```{r, echo=FALSE}
cond <- DFO_hatchery$REL_GFE_ID == 54282 & !is.na( DFO_hatchery$REL_GFE_ID)
DFO_hatchery[cond,c("REL_GFE_ID","REL_LATITUDE","REL_LONGITUDE")]
```

It is in the **DFO streams file** but without coordinates:

```{r, echo=FALSE}
# The coordinates are not in DFO_All_Streams_Segments:
cond <- DFO_All_Streams_Segments$ID == 54282
DFO_All_Streams_Segments[cond,c("NME","ID","Y_LAT","X_LONGT")]
```

We consequently define the coordinates manually using Google Maps:

```{r, echo=FALSE}
#' Create a new series in CUSS for: CO_46170 - 54282
cuss_new <- CUSS_newRow_fun(IndexId = "CO_46170",
                            GFE_ID = 54282,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

X_Y <- c(50.163045,-120.665873) # taken at the Nicola Dam with Google maps
cuss_new$Y_LAT <- X_Y[1]
cuss_new$X_LONGT <- X_Y[2]
cuss_new$coordinates_changed <- T

# add to conservation_unit_system_sites
conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId ="CO_46170",
                    GFE_ID = 54282,
                    dataset = "CUSS",
                    CU_NAME = cuss_new$CU_NAME,
                    comment = "Series not in CUSS and not merged with CO_46170 - 213 because of different location")

added_all <- rbind(added_all,toAdd)

cuss_new[,c("SYSTEM_SITE","GFE_ID","Y_LAT","X_LONGT")]
```

The focal series `r paste("CO_46170","54283",sep = " - ")` is removed because it does not have coordinates, it is unclear what "(DOT)" stands for and there is only two data points.

```{r, echo=FALSE}
removed <- data.frame(IndexId = c("CO_46170"),
                      GFE_ID = c(54283))
removed$dataset <- "NUSEDS"
removed$comment <- c("Series not in CUSS, removed because no coordinates and unknow meaning of 'DOT'; only two data points; not merged to alternative series IndexId = CO_46170 & GFE_ID = 213")
removed_all <- rbind(removed_all,removed)

cond <- all_areas_nuseds$IndexId == "CO_46170" & all_areas_nuseds$GFE_ID == 54283
all_areas_nuseds <- all_areas_nuseds[!cond,]
```


Finally, the focal series `r paste("CO_46170","2453",sep = " - ")` in red (bottom plot) is merged to the alternative series `r paste("CO_44736","2453",sep = " - ")` in blue.

```{r, echo=FALSE}
all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "CO_46170",
                                                IndexId_alter = "CO_44736",
                                                GFE_ID_focal = 2453,
                                                GFE_ID_alter = 2453,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

removed <- data.frame(IndexId = c("CO_46170"),
                      GFE_ID = c(2453))
removed$dataset <- "NUSEDS"
removed$comment <- "Series not in CUSS, merged to series CO_44736 & GFE_ID = 2453"
removed_all <- rbind(removed_all,removed)
```

```{r, include=FALSE}
i <- i + 1 # 11  SX_45141

cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]

cond <- conservation_unit_system_sites$GFE_ID %in% c(2119,2193)
conservation_unit_system_sites[cond,c("SYSTEM_SITE","GFE_ID","Y_LAT","X_LONGT")] |> unique()


cuss_new <- CUSS_newRow_fun(IndexId = "SX_45141",
                            GFE_ID = 2119,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

# add to conservation_unit_system_sites
conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId ="SX_45141",
                    GFE_ID = 2119,
                    dataset = "CUSS",
                    CU_NAME = cuss_new$CU_NAME,
                    comment = "Series not in CUSS and not merged with SX_45141 - 2119 because of different location")

added_all <- rbind(added_all,toAdd)
```

In case i = `r i`: the focal series `r paste("SX_45141","2119",sep = " - ")` in blue is not merged to `r paste("SX_45141","2119",sep = " - ")` because the two location are far apart; it is instead added to **CUSS**.

```{r, include=FALSE}
# CO_46240
i <- i + 1  # 12
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]
series_compare[[i]]
series_MAX_ESTIMATE[i]

cond <- conservation_unit_system_sites$IndexId %in% c("CO_46240","CO_46250")
conservation_unit_system_sites[cond,c("CU_NAME","IndexId")]
CU_NAME <- unique(conservation_unit_system_sites[cond,c("CU_NAME")])
```

In case i = `r i`: the focal series `r paste("CO_46240","221",sep = " - ")` is merged to the alternative series `r paste("CO_46250","221",sep = " - ")` (bottom plot) because the two `POPULATION`s belong to the same `CU_NAME` = `r CU_NAME` and the time series are compatible:

```{r, echo=FALSE}
cond <- all_areas_nuseds$IndexId %in% c("CO_46240") & all_areas_nuseds$GFE_ID == 221
series_focal <- all_areas_nuseds$MAX_ESTIMATE[cond]
names(series_focal) <- all_areas_nuseds$Year[cond]

cond <- all_areas_nuseds$IndexId %in% c("CO_46250") & all_areas_nuseds$GFE_ID == 221
series_compare <- all_areas_nuseds$MAX_ESTIMATE[cond]
names(series_compare) <- all_areas_nuseds$Year[cond]

compare_series_fun(series_focal = series_focal, series_compare = series_compare)
```

```{r, include=FALSE}
removed <- data.frame(IndexId = c("CO_46240"),
                      GFE_ID = c(221))
removed$dataset <- "NUSEDS"
removed$comment <- c("Series not in CUSS, merged to alternative series IndexId = CO_46250 & GFE_ID = 221")
removed_all <- rbind(removed_all,removed)

all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "CO_46240",
                                                IndexId_alter = "CO_46250",
                                                GFE_ID_focal = 221,
                                                GFE_ID_alter = 221,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

plot_IndexId_GFE_ID_fun(IndexIds = c("CO_46240","CO_46250"),
                        GFE_IDs = c(221,221),
                        all_areas_nuseds = all_areas_nuseds, 
                        main = "")

# IMPORTANT
#' do not forget to change StatArea from "29" back to "29J"
#' StatArea was set to "29" for CO_46240 early on in the script
# cond <- all_areas_nuseds$IndexId == "CO_46250"
# unique(all_areas_nuseds$StatArea[cond])
# all_areas_nuseds$StatArea[cond] <-"29J"
```

The `GFE_ID` of the other focal series `r paste("CO_46240","3477",sep = " - ")` is not in **CUSS** but it is in the **DFO streams file** and we can see that its coordinates are very similar to the coordinates of the alternative time series:

```{r, include=FALSE}
cond <- conservation_unit_system_sites$GFE_ID %in% c(220,3477)
conservation_unit_system_sites[cond,c("SYSTEM_SITE","GFE_ID","Y_LAT","X_LONGT")] |> unique()
```

```{r, echo=FALSE}
cond <- DFO_All_Streams_Segments$ID %in% c(220,3477)
DFO_All_Streams_Segments[cond,c("NME","ID","Y_LAT","X_LONGT")]
```

The second focal series `r paste("CO_46240","3477",sep = " - ")` is consequently merged to the alternative series `r paste("CO_46240","220",sep = " - ")` in **NUSEDS**.

```{r, include=FALSE}
removed <- data.frame(IndexId = c("CO_46240"),
                      GFE_ID = c(3477))
removed$dataset <- "NUSEDS"
removed$comment <- c("Series not in CUSS, merged to alternative series IndexId = CO_46240 & GFE_ID = 220 because almost same coordinates")
removed_all <- rbind(removed_all,removed)

all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "CO_46240",
                                                IndexId_alter = "CO_46240",
                                                GFE_ID_focal = 3477,
                                                GFE_ID_alter = 220,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)


plot_IndexId_GFE_ID_fun(IndexIds = c("CO_46240","CO_46240"),
                        GFE_IDs = c(220,3477),
                        all_areas_nuseds = all_areas_nuseds, 
                        main = "")
```

```{r, include=FALSE}
#' CN_3333
i <- i + 1 # 13
cond_i <- trackRecord_nuseds_gfeid$i == i
iid <- trackRecord_nuseds_gfeid$IndexId[cond_i]
gfeid <- trackRecord_nuseds_gfeid$GFE_ID[cond_i]
gfeid_a <- trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]

cond <- conservation_unit_system_sites$GFE_ID %in% c(gfeid,gfeid_a)
conservation_unit_system_sites[cond,c("SYSTEM_SITE","GFE_ID","Y_LAT","X_LONGT")] |> unique()

# add the reference to CUSS
cuss_new <- CUSS_newRow_fun(IndexId = "CN_3333",
                            GFE_ID = 1194,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

# add to conservation_unit_system_sites
conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId ="CN_3333",
                    GFE_ID = 1194,
                    dataset = "CUSS",
                    CU_NAME = cuss_new$CU_NAME,
                    comment = "Series not in CUSS and not merged with CN_3333 - 23735 because of different location")

added_all <- rbind(added_all,toAdd)
```

In case i = `r i`: the focal series `r paste("CN_3333","1194",sep = " - ")` is not merged to the alternative series `r paste("CN_3333","23735",sep = " - ")` (top plot) because the two locations are two far apart; it is added to **CUSS** instead.

```{r, include=FALSE}
#' Cases with STEON RIVER - CN_2178
#' blue is actually a duplicate of the red in lower plot --> remove from nuseds
i <- i + 1 # 14
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]
series_compare[[i]]
series_MAX_ESTIMATE[i]

removed <- data.frame(IndexId = c("CN_2178"),
                      GFE_ID = 129)
removed$dataset <- "NUSEDS"
removed$comment <- "Series not in CUSS, duplicates of series IndexId = CN_47189 & GFE_ID = 129"
removed_all <- rbind(removed_all,removed)

all_areas_nuseds <- remove_rows_fields_fun(dataframe = all_areas_nuseds, 
                                           toRemove = removed, 
                                           fields = c("IndexId","GFE_ID"))
```

In case i = `r i`: the focal series `r paste("CN_2178","129",sep = " - ")` in blue is a duplicate of the atlernative series `r paste("CN_47189","129",sep = " - ")` in red (bottom plot); it is consequently removed from **NUSEDS**.

```{r, include=FALSE}
#' Cases with STEON RIVER / PORTAGE CREEK - CO_44539
#' All are in the Seton River near Lillooets
#' - top plot: DO NOT merge blue to red because there is a conflict in 2013
#'   --> create a new row in CUSS
#' - bottom plot: merge blue to red --> change IndexId from CO_44539 to CO_47183 in NUSEDS
i <- i + 1 # 15
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_IndexId[cond_i]

#' - top plot: create a new row in CUSS for CO_44539 - 2451 (2451 is already in CUSS)
sum(conservation_unit_system_sites_all$GFE_ID == 2451)

cuss_new <- CUSS_newRow_fun(IndexId = "CO_44539",
                            GFE_ID = 2451,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId ="CO_44539",
                    GFE_ID = 2451,
                    dataset = "CUSS",
                    CU_NAME = cuss_new$CU_NAME,
                    comment = "Series not in CUSS and not merged with CO_44539 - 2476 because of one conflictual data point")

added_all <- rbind(added_all,toAdd)

#' - bottom plot: merge blue to red --> change IndexId from CO_44539 to CO_47183 
#' in NUSEDS
# all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
#                                                 IndexId_focal = "CO_44539",
#                                                 IndexId_alter = "CO_47183",
#                                                 GFE_ID_focal = 129,
#                                                 GFE_ID_alter = 129,
#                                                 all_areas_nuseds = all_areas_nuseds,
#                                                 conservation_unit_system_sites = conservation_unit_system_sites)
# 
# 
# 
# unique(all_areas_nuseds$StatArea)
# 
# 
# removed <- data.frame(IndexId = c("CO_44539"),
#                       GFE_ID = c(129))
# removed$dataset <- "NUSEDS"
# removed$comment <- "Series not in CUSS, merged to series CO_47183 & GFE_ID = 129"
# removed_all <- rbind(removed_all,removed)

# DO NOT MERGE BECAUSE IT CREATE ISSUE DUE TO MERGE AT i = 7
# add ref to CUSS instead
cuss_new <- CUSS_newRow_fun(IndexId = "CO_44539",
                            GFE_ID = 129,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

# add to conservation_unit_system_sites
conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)
toAdd <- data.frame(IndexId = "CO_44539",
                    GFE_ID = 129,
                    dataset = "CUSS",
                    CU_NAME = cuss_new$CU_NAME,
                    comment = "Series not in CUSS and not merged with CO_47183 - 129 because would create conflict with other merge done with CO_47183 - 2451")

added_all <- rbind(added_all,toAdd)
```

In case i = `r i`: the focal series `r paste("CO_44539","2451",sep = " - ")` in blue (top plot) is not merged to the alternative series `r paste("CO_44539","2476",sep = " - ")` in red because of a conflicting point; its reference is instead added to **CUSS**. The second focal series `r paste("CO_44539","129",sep = " - ")` in blue (bottom plot) is not merged to the alternative series `r paste("CO_47183","129",sep = " - ")` in red, notably because this would create a conflict with the merge done with series ` CO_47183 - 2451` at step `i = 7`.

```{r, include=FALSE}
# CN_44577
i <- i + 1 # 16
cond_i <- trackRecord_nuseds_gfeid$i == i
iid <- trackRecord_nuseds_gfeid$IndexId[cond_i]
gfeid <- trackRecord_nuseds_gfeid$GFE_ID[cond_i]
gfeid_a <- trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]
iid_a <- trackRecord_nuseds_gfeid$alternative_IndexId[cond_i]

cond <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID == gfeid
POPULATION <- unique(all_areas_nuseds$POPULATION[cond])
WATERBODY <- unique(all_areas_nuseds$WATERBODY[cond])

cond <- conservation_unit_system_sites$GFE_ID %in% c(gfeid,gfeid_a)
conservation_unit_system_sites[cond,c("SYSTEM_SITE","GFE_ID","Y_LAT","X_LONGT")] |> unique()

cond <- conservation_unit_system_sites$GFE_ID %in% c(gfeid)
SYSTEM_SITE <- conservation_unit_system_sites$SYSTEM_SITE[cond] |> unique()
```

In case i = `r i`: there is a clear discrepancy between focal series `r paste("CN_44577","2518",sep = " - ")`'s `POPULATION` = `r POPULATION` and its `SYSTEM_SITE` = `rS SYSTEM_SITE`: these two locations are very far apart. We decide to merge it to the alternative series `r paste("CN_44599","2518",sep = " - ")` (bottom plot) by changing its `IndexId/POP_ID`.

```{r, include=FALSE}
removed <- data.frame(IndexId = iid,
                      GFE_ID = gfeid)
removed$dataset <- "NUSEDS"
removed$comment <- c("Series not in CUSS, merged to alternative series IndexId = CN_44599 & GFE_ID = 2518")
removed_all <- rbind(removed_all,removed)

all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "CN_44577",
                                                IndexId_alter = "CN_44599",
                                                GFE_ID_focal = 2518,
                                                GFE_ID_alter = 2518,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

plot_IndexId_GFE_ID_fun(IndexIds = c(iid,iid_a), 
                        GFE_IDs = c(gfeid,gfeid),
                        all_areas_nuseds = all_areas_nuseds)
```

```{r include=FALSE}
#' Cases with THOMPSON RIVER CO_46582
#' --> add these series to CUSS --> new GFE_IDs
i <- i + 1 # 17
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_IndexId[cond_i]

# All the GFE_IDs of the focal locations do not have coordinates in DFO_All_Streams_Segments:
cond <- DFO_All_Streams_Segments$ID %in% trackRecord_nuseds_gfeid$GFE_ID[cond_i]
DFO_All_Streams_Segments[cond,]

#' so we used Google Maps and the map in p.31 of Arbeider et al. 2020. Interior 
#' Fraser Coho Salmon Recovery Potential Assessment
#' https://waves-vagues.dfo-mpo.gc.ca/library-bibliotheque/40888721.pdf
#' to define these coordinates manually.
DFO_streams_here <- DFO_All_Streams_Segments[cond,] |> as.data.frame()
DFO_streams_here[DFO_streams_here$NME == "BIRCH ISLAND CHANNEL",c("Y_LAT","X_LONGT")] <- c(51.598602,-119.889197) 
DFO_streams_here[DFO_streams_here$NME == "UPPER NORTH THOMPSON RIVER MAINSTEM",c("Y_LAT","X_LONGT")] <- c(52.345236,-119.177796)  
DFO_streams_here[DFO_streams_here$NME == "MIDDLE NORTH THOMPSON RIVER MAINSTEM",c("Y_LAT","X_LONGT")] <- c(51.593091,-119.701668) 
DFO_streams_here[DFO_streams_here$NME == "PIG CHANNEL COMBINED",c("Y_LAT","X_LONGT")] <- c(51.579465,-119.810014) 
DFO_streams_here[DFO_streams_here$NME == "UPPER NORTH THOMPSON RIVER-MILEDGE CONFLUENCE",c("Y_LAT","X_LONGT")] <- c(52.281312,-119.173514)

for(gfeid in trackRecord_nuseds_gfeid$GFE_ID[cond_i]){
  # gfeid <- trackRecord_nuseds_gfeid$GFE_ID[cond_i][1]
  
  cuss_new <- CUSS_newRow_fun(IndexId = "CO_46582",
                              GFE_ID = gfeid,
                              conservation_unit_system_sites = conservation_unit_system_sites,
                              all_areas_nuseds = all_areas_nuseds)
  
  cond <- DFO_streams_here$ID == gfeid
  cuss_new$Y_LAT <- DFO_streams_here$Y_LAT[cond] |> as.numeric()
  cuss_new$X_LONGT <- DFO_streams_here$X_LONGT[cond] |> as.numeric()
  cuss_new$coordinates_changed <- T

  print(cuss_new[,c("GFE_ID","SYSTEM_SITE","X_LONGT","Y_LAT")])
  
  conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                          cuss_new)
  
  toAdd <- data.frame(IndexId ="CO_46582",
                      GFE_ID = gfeid,
                      dataset = "CUSS",
                      CU_NAME = cuss_new$CU_NAME,
                      comment = "Series not in CUSS and not merged with CO_46582 - 256 because of different location")

  added_all <- rbind(added_all,toAdd)
}
```

In case i = `r i`: all `r nrow(DFO_streams_here)` focal series are added to **CUSS**. Their `GFE_ID` are present in the DFO streams but the coordinates are missing for most of them:

```{r,echo=FALSE}
cond <- DFO_All_Streams_Segments$ID %in% trackRecord_nuseds_gfeid$GFE_ID[cond_i]
DFO_All_Streams_Segments[cond,]
```

The coordinates are consequently defined manually using Google Maps and the map in page 31 of [Arbeider et al. 2020. Interior Fraser Coho Salmon Recovery Potential Assessment](https://waves-vagues.dfo-mpo.gc.ca/library-bibliotheque/40888721.pdf):

```{r, echo=FALSE}
colnames(DFO_streams_here) <- c("SYSTEM_SITE","GFE_ID","X_LONGT","Y_LAT")
DFO_streams_here
```

```{r, include=FALSE}
#' Cases with BARRIER RIVER CO_46602
#' TODO:
#' - bottom plot: merge blue to red --> change IndexId in NUSEDS 
#' - top plot: create new series in CUSS for green
i <- i + 1 # 18
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_IndexId[cond_i]

#' - bottom plot: merge blue to red --> change IndexId in NUSEDS 
all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "CO_46602",
                                                IndexId_alter = "CO_46632",
                                                GFE_ID_focal = 2746,
                                                GFE_ID_alter = 2746,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

removed <- data.frame(IndexId = c("CO_46602"),
                      GFE_ID = c(2746))
removed$dataset <- "NUSEDS"
removed$comment <- "Series not in CUSS, merged to series CO_46632 & GFE_ID = 2746"
removed_all <- rbind(removed_all,removed)

#' - top plot: create new series in CUSS for green
cuss_new <- CUSS_newRow_fun(IndexId = "CO_46602",
                            GFE_ID = 212716981,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

# The coordinates are in DFO_All_Streams_Segments:
cond <- DFO_All_Streams_Segments$ID == 212716981
DFO_All_Streams_Segments[cond,]
cuss_new$Y_LAT <- DFO_All_Streams_Segments$Y_LAT[cond] |> as.numeric()
cuss_new$X_LONGT <- DFO_All_Streams_Segments$X_LONGT[cond] |> as.numeric()
cuss_new$coordinates_changed <- F

conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId ="CO_46602",
                    GFE_ID = 212716981,
                    dataset = "CUSS",
                    CU_NAME = cuss_new$CU_NAME,
                    comment = "Series not in CUSS and not merged with CO_46632 - 258 because of different location")

added_all <- rbind(added_all,toAdd)
```

In case i = `r i`: the focal series `r paste("CO_46602","2746",sep = " - ")` in blue (bottom plot) is merged to the alternative series `r paste("CO_46632","2476",sep = " - ")` in red. The other focal series `r paste("CO_46602","212716981",sep = " - ")` in green (top plot) is added to **CUSS**.

```{r,include=FALSE}
#' Cases with FENNELL CREEK / SASKUM CREEK SX_3416
#' TODO: merge for both --> change GFE_ID in NUSEDS
i <- i + 1 # 19
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_IndexId[cond_i]

all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "SX_3416",
                                                IndexId_alter = "SX_3416",
                                                GFE_ID_focal = 2746,
                                                GFE_ID_alter = 261,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

removed <- data.frame(IndexId = c("SX_3416"),
                      GFE_ID = c(2746))
removed$dataset <- "NUSEDS"
removed$comment <- "Series not in CUSS, merged to series SX_3416 & GFE_ID = 261"
removed_all <- rbind(removed_all,removed)
```

In case i = `r i`: the focal series `r paste("SX_3416","2746",sep = " - ")` in blue (bottom plot) is merged to the alternative series `r paste("SX_3416","261",sep = " - ")` in red.

```{r, include=FALSE}
# CO_46632
i <- i + 1 # 20 
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_IndexId[cond_i]

all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = "CO_46632",
                                                IndexId_alter = "CO_46632",
                                                GFE_ID_focal = 261,
                                                GFE_ID_alter = 2746,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

removed <- data.frame(IndexId = c("CO_46632"),
                      GFE_ID = c(261))
removed$dataset <- "NUSEDS"
removed$comment <- "Series not in CUSS, merged to series CO_46632 & GFE_ID = 2746"
removed_all <- rbind(removed_all,removed)
```

```{r, include=FALSE}
# Note that these two locations are very close to each other
cond <- conservation_unit_system_sites$GFE_ID %in% c(261,2746)
conservation_unit_system_sites[cond,c("SYSTEM_SITE","GFE_ID","Y_LAT","X_LONGT")]
```

In case i = `r i`: the focal series `r paste("CO_46632","261",sep = " - ")` in blue (bottom plot) is merged to the alternative series `r paste("CO_46632","2746",sep = " - ")` in red.


```{r, include=FALSE}
#' Cases with BLUE RIVER CN_46801

i <- i + 1 # 21
cond_i <- trackRecord_nuseds_gfeid$i == i
iid <- unique(trackRecord_nuseds_gfeid$IndexId[cond_i])
gfeid <- unique(trackRecord_nuseds_gfeid$GFE_ID[cond_i])
gfeid_a <- unique(trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i])
trackRecord_nuseds_gfeid$alternative_IndexId[cond_i]
series_MAX_ESTIMATE[i]
series_compare[[i]]

cond <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID == gfeid
all_areas_nuseds[cond,c("Year","MAX_ESTIMATE")]

cond2 <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID == gfeid_a
all_areas_nuseds[cond2,c("Year","MAX_ESTIMATE")]

check <- merge(x = all_areas_nuseds[cond,c("Year","MAX_ESTIMATE")], 
               y = all_areas_nuseds[cond2,c("Year","MAX_ESTIMATE")],
               by = "Year", all = T)
check

# remvoe the point
removed <- data.frame(IndexId = c("CN_46801"),
                      GFE_ID = c(33103))
removed$dataset <- "NUSEDS"
removed$comment <- c("Series not in CUSS, not merged to alternative series IndexId = CN_46801 & GFE_ID = 281 because its one data point is conflictual an almost a duplicate")
removed_all <- rbind(removed_all,removed)

all_areas_nuseds <- all_areas_nuseds[!cond,]
```

In case i = `r i`: the focal series `r paste("CN_46801","33103",sep = " - ")` is removed from **NUSEDS** because its value is almost a duplicate of the value in the alternative series for this one year.

```{r, include=FALSE}
#' Cases with BLUE RIVER CO_46795
#' series were added up in the PSE,
#' TODO:
#' - merge blue to red \--\> change GFE_ID
#' - create new series in CUSS for green
i <- i + 1 # 22
cond_i <- trackRecord_nuseds_gfeid$i == i
trackRecord_nuseds_gfeid$IndexId[cond_i]
trackRecord_nuseds_gfeid$GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i]
trackRecord_nuseds_gfeid$alternative_IndexId[cond_i]
series_MAX_ESTIMATE[i]
series_compare[[i]]

#' - merge blue to red \--\> change GFE_ID
all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T,
IndexId_focal = "CO_46795",
IndexId_alter = "CO_46795",
GFE_ID_focal = 33103,
GFE_ID_alter = 281,
all_areas_nuseds = all_areas_nuseds,
conservation_unit_system_sites = conservation_unit_system_sites)

removed <- data.frame(IndexId = c("CO_46795"),
GFE_ID = c(33103))
removed$dataset <- "NUSEDS"
removed$comment <- "Series not in CUSS, merged to series CO_46795 & GFE_ID = 281"
removed_all <- rbind(removed_all,removed)

#' - create new series in CUSS for green
cuss_new <- CUSS_newRow_fun(IndexId = "CO_46795",
                            GFE_ID = 1921661712,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)


# The coordinates are not in DFO_All_Streams_Segments:
cond <- DFO_All_Streams_Segments$ID == 1921661712
DFO_All_Streams_Segments[cond,]

# So it must be defined manually:
cuss_new[1,c("Y_LAT","X_LONGT")] <- c(52.112252,-119.289006)
cuss_new$coordinates_changed <- T

conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId ="CO_46795",
                    GFE_ID = 1921661712,
                    dataset = "CUSS",
                    CU_NAME = cuss_new$CU_NAME,
                    comment = "Series not in CUSS and not merged to CO_46795 & GFE_ID = 281 because of different location")

added_all <- rbind(added_all,toAdd)
```

In case i = `r i`: the focal series `r paste("CO_46795","33103",sep = " - ")` in blue is merged to the alternative series `r paste("CO_46795","281",sep = " - ")` in red. The other focal series `r paste("CO_46795","1921661712",sep = " - ")` in green is added to **CUSS**. Its `GFE_ID` is in the **DFO streams file** but coordinates are not:

```{r, echo=FALSE}
cond <- DFO_All_Streams_Segments$ID %in% trackRecord_nuseds_gfeid$GFE_ID[cond_i]
DFO_All_Streams_Segments[cond,]
```

The coordinates are consequently defined manually using Google Maps:

```{r,echo=FALSE}
rownames(cuss_new) <- NULL
cuss_new[,c("SYSTEM_SITE","GFE_ID","Y_LAT","X_LONGT")]
```

```{r, include=FALSE}
i <- i + 1 # 23
cond_i <- trackRecord_nuseds_gfeid$i == i
iid <- trackRecord_nuseds_gfeid$IndexId[cond_i] |> unique()  # CO_46835
gfeid <- trackRecord_nuseds_gfeid$GFE_ID[cond_i] |> unique() # 2463
gfeid_a <- trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i] |> unique() # 285
trackRecord_nuseds_gfeid$alternative_IndexId[cond_i]

# check the coordinates --> same
cond <- conservation_unit_system_sites$GFE_ID %in% c(gfeid,gfeid_a)
show <- unique(conservation_unit_system_sites[cond,c("SYSTEM_SITE","GFE_ID","Y_LAT","X_LONGT")])
rownames(show) <- NULL
```

In case i = `r i`: the two locations are the same:

```{r, echo=FALSE}
show
```

Because the focal series `r paste("CO_46835","2463",sep = " - ")` is much more recent that the alternative series `r paste("CO_46835","285",sep = " - ")`, it the latter that is modified in **CUSS** (i.e., the `GFE_ID` of the alternative series is changed to the one of the focal series) and in **NUSEDS**.

```{r, echo=FALSE}

# modify CUSS
conservation_unit_system_sites <- fields_edit_NUSEDS_CUSS_fun(edit_CUSS = T, 
                                                IndexId_focal = iid,
                                                IndexId_alter = iid,
                                                GFE_ID_focal = gfeid_a,  # this is correct as we decided to update the alternative one
                                                GFE_ID_alter = gfeid,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)
# modify NUSEDS
all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = iid,
                                                IndexId_alter = iid,
                                                GFE_ID_focal = gfeid_a,  # this is correct as we decided to update the alternative one
                                                GFE_ID_alter = gfeid,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

```

```{r,include=FALSE}
#' Case 1 with CARIBOO RIVER CN_46891
#' CN_46891 - 2467 is 100% duplicated with CN_46891 - 290
#' TODO: remove from NUSEDS
i <- i + 1 # 24
cond_i <- trackRecord_nuseds_gfeid$i == i
iid <- trackRecord_nuseds_gfeid$IndexId[cond_i] |> unique()
gfeid <- trackRecord_nuseds_gfeid$GFE_ID[cond_i] |> unique()
gfeid_a <- trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i] |> unique()
trackRecord_nuseds_gfeid$alternative_IndexId[cond_i]
series_compare[[i]]

# 
cond <- conservation_unit_system_sites$GFE_ID %in% c(gfeid,gfeid_a)
conservation_unit_system_sites[cond,c("SYSTEM_SITE","GFE_ID","Y_LAT","X_LONGT")] |> unique()

cond <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID == 2466
cond2 <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID == gfeid_a
cols <- c("Year","MAX_ESTIMATE","ESTIMATE_CLASSIFICATION")
check <- merge(x = all_areas_nuseds[cond,cols],
               y =  all_areas_nuseds[cond2,cols],
               by = "Year",all = T)
check

# add the time series to CUSS
cuss_new <- CUSS_newRow_fun(IndexId = "CN_46891",
                            GFE_ID = 2466,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

# add to conservation_unit_system_sites
conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId ="CN_46891",
                    GFE_ID = 2466,
                    dataset = "CUSS",
                    CU_NAME = cuss_new$CU_NAME,
                    comment = "Series not in CUSS and not merged with CN_46891 - 290 because of different location")

added_all <- rbind(added_all,toAdd)


# remove the duplicated time series
removed <- data.frame(IndexId = c("CN_46891"),
                      GFE_ID = 2467)
removed$dataset <- "NUSEDS"
removed$comment <- "Duplicates of series IndexId = CN_46891 & GFE_ID = 290"
removed_all <- rbind(removed_all,removed)

all_areas_nuseds <- remove_rows_fields_fun(dataframe = all_areas_nuseds, 
                                           toRemove = removed, 
                                           fields = c("IndexId","GFE_ID"))
```

In case i = `r i`: the focal series `r paste("CN_46891","2467",sep = " - ")` in blue is a duplicate of the alternative series `r paste("CN_46891","290",sep = " - ")` in red; it is consequently removed from **NUSEDS**. The other focal series `r paste("CN_46891","2466",sep = " - ")` is not merge to the alternative series because the two locations are far apart (also we could be counting fish twice here); it is added to **CUSS** instead.


```{r,include=FALSE}
i <- i + 1 # 25 CN_46892

cond_i <- trackRecord_nuseds_gfeid$i == i
iid <- trackRecord_nuseds_gfeid$IndexId[cond_i] |> unique()
gfeid <- trackRecord_nuseds_gfeid$GFE_ID[cond_i] |> unique()
gfeid_a <- trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i] |> unique()
```

In case i = `r i`: the focal series `r paste("CN_46892","2466",sep = " - ")` in blue has three duplicated points with the alternative time series `r paste("CN_46892","290",sep = " - ")` in red, and a conflicting point. However, this conflicting point in the alternative time series is a duplicated point in the third time series `r paste("CN_46891","290",sep = " - ")` in purple in the bottom plot below. We consequently (1) remove the duplicated point in the alternative series (in red) and (2) merge the focal series to the latter.

```{r, echo=FALSE, fig.width = 17, fig.height = 13}
layout(matrix(1:2,nrow = 2))
par(mar=c(4,4,.5,.5))
plot_IndexId_GFE_ID_fun(IndexIds = "CN_46892",all_areas_nuseds = all_areas_nuseds,
                        colPalette = c("deepskyblue3","firebrick"), pchs = 2:1, ltys = 2:1)
legend("top",c(NA,"focal","alternative"),bty = 'n')
legend("bottomleft",paste0("i = ",i),bty = 'n')
plot_IndexId_GFE_ID_fun(GFE_IDs = 290, species_acro = "CN",
                        all_areas_nuseds = all_areas_nuseds,pchs = c(3,1),ltys = c(2,1),
                        colPalette = c("purple","firebrick"))
```

```{r,include=FALSE,fig.width = 17, fig.height = 13}
#' Case 2 with CARIBOO RIVER (i = 16):
#' alternative CN_46892 - 290
#' This is a complicated case that was spotted by looking at the time series:
#' In the figure below:
#' - top plot: the alternative series has 3 points duplicating with the focal series
#' - bottom plot: the same alternative series has a duplicated point with another series
#' TODO: 
#' - remove the 5th point in the alternative series (IndexId = CN_46892 & GFE_ID = 290),
#' - then merge the focal series (CN_46892 - 2466) to it, taking care of the duplicated
#' points (i.e. removing them)

# alternative series:
cond_CN_46892_290 <- all_areas_nuseds$IndexId == "CN_46892" & 
  all_areas_nuseds$GFE_ID == 290
nuseds_CN_46892_290 <- all_areas_nuseds[cond_CN_46892_290,]

# focal series
cond_CN_46892_2466 <- all_areas_nuseds$IndexId == "CN_46892" & 
  all_areas_nuseds$GFE_ID == 2466
nuseds_CN_46892_2466 <- all_areas_nuseds[cond_CN_46892_2466,]

# remove the 5th point in nuseds_CN_46892_290, which is also the highest
r_toremove <- which(nuseds_CN_46892_290$MAX_ESTIMATE == max(nuseds_CN_46892_290$MAX_ESTIMATE, na.rm = T))
nuseds_CN_46892_290 <- nuseds_CN_46892_290[-r_toremove,]

# remove rows in nuseds_CN_46892_2466 with duplicated values in nuseds_CN_46892_290
colSelect <- c("Year","MAX_ESTIMATE")
data <- merge(nuseds_CN_46892_2466[,colSelect],
              nuseds_CN_46892_290[,colSelect],
              by = "Year", all.x = T)
data <- data[!is.na(data$MAX_ESTIMATE.x) &
               !is.na(data$MAX_ESTIMATE.y) &
               data$MAX_ESTIMATE.x == data$MAX_ESTIMATE.y,]

cond <- ! nuseds_CN_46892_2466$MAX_ESTIMATE %in% data$MAX_ESTIMATE.x
nuseds_CN_46892_2466 <- nuseds_CN_46892_2466[cond,]
nuseds_CN_46892_2466[,c("Year","MAX_ESTIMATE")]

# remove rows in nuseds_CN_46892_2466 with NAs for MAX_ESTIMATE in years already 
# present in nuseds_CN_46892_290 (to avoid creating duplicated years)
data <- merge(nuseds_CN_46892_2466[,colSelect],
              nuseds_CN_46892_290[,colSelect],
              by = "Year", all.x = T)
data <- data[!is.na(data$MAX_ESTIMATE.x),]
cond <- nuseds_CN_46892_2466$Year %in% data$Year
nuseds_CN_46892_2466 <- nuseds_CN_46892_2466[cond,]
nuseds_CN_46892_2466[,c("Year","MAX_ESTIMATE")]

# edit nuseds_CN_46892_2466 with new GFE_ID-related fields
for(f in fields_l$NUSEDS$GFE_ID){
  nuseds_CN_46892_2466[,f] <- unique(nuseds_CN_46892_290[,f])
}

#' edit data in all_areas_nuseds
all_areas_nuseds <- all_areas_nuseds[!(cond_CN_46892_290 | cond_CN_46892_2466),]
all_areas_nuseds <- rbind(all_areas_nuseds,
                          nuseds_CN_46892_2466,
                          nuseds_CN_46892_290)

# to check that the operation succeeded:
layout(matrix(1))
plot_IndexId_GFE_ID_fun(IndexIds = "CN_46892",all_areas_nuseds = all_areas_nuseds)

# edit removed_all
removed <- data.frame(IndexId = c("CN_46892"),
                      GFE_ID = c(2466))
removed$dataset <- "NUSEDS"
removed$comment <- "Merged to series CN_46892 & GFE_ID = 290 with which 3 data points were duplicated; one was duplicated with CN_46891 & GFE_ID = 290"
removed_all <- rbind(removed_all,removed)
```


```{r, include=FALSE} 
# CM_47906 EAGLE CREEK 441
i <- i + 1 # 26
cond_i <- trackRecord_nuseds_gfeid$i == i
iid <- trackRecord_nuseds_gfeid$IndexId[cond_i] |> unique()
gfeid <- trackRecord_nuseds_gfeid$GFE_ID[cond_i] |> unique()
gfeid_a <- trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i] |> unique()

cond <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID == gfeid
cond2 <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID == gfeid_a
cols <- c("Year","MAX_ESTIMATE","ESTIMATE_CLASSIFICATION")
check <- merge(x = all_areas_nuseds[cond,cols],
               y =  all_areas_nuseds[cond2,cols],
               by = "Year",all = T)
# View(check)

# add it to CUSS
cuss_new <- CUSS_newRow_fun(IndexId = iid,
                            GFE_ID = gfeid,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

cuss_new

cond <- DFO_All_Streams_Segments$ID == gfeid
DFO_All_Streams_Segments[cond,]
cuss_new$Y_LAT <- DFO_All_Streams_Segments[cond,]$Y_LAT
cuss_new$X_LONGT <- DFO_All_Streams_Segments[cond,]$X_LONGT
cuss_new$coordinates_changed <- F

# add to conservation_unit_system_sites
conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId = iid,
                    GFE_ID = gfeid,
                    dataset = "CUSS",
                    CU_NAME = cuss_new$CU_NAME,
                    comment = "Series not in CUSS and not merged with CM_47906 - 3 because of different location and points are conflictual")

added_all <- rbind(added_all,toAdd)
```

In case i = `r i`: the focal series `r paste("CM_47906","441",sep = " - ")` in blue is not merged to the alternative series because the points are conflictual; it is added to **CUSS** instead. Its `GFE_ID` (- `r gfeid`) is not in **CUSS** but the coordinates were found in the **DFO streams file**:

```{r, echo=FALSE}
DFO_All_Streams_Segments[cond,]
```

```{r, include=FALSE}
# CN_48448
i <- i + 1 # 27
cond_i <- trackRecord_nuseds_gfeid$i == i
iid <- trackRecord_nuseds_gfeid$IndexId[cond_i] |> unique()
gfeid <- trackRecord_nuseds_gfeid$GFE_ID[cond_i] |> unique()
gfeid_a <- trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i] |> unique()

# merge the data point
removed <- data.frame(IndexId = iid,
                      GFE_ID = gfeid)
removed$dataset <- "NUSEDS"
removed$comment <- c("Series not in CUSS, merged to alternative series IndexId = CN_48448 & GFE_ID = 443")
removed_all <- rbind(removed_all,removed)

all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = iid,
                                                IndexId_alter = iid,
                                                GFE_ID_focal = gfeid,
                                                GFE_ID_alter = gfeid_a,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)

```

In case i = `r i`: the focal series `r paste("CN_48448","443",sep = " - ")` in blue is merged to the alternative series.

```{r, include=FALSE}
# CM_46984
i <- i + 1 # 28
cond_i <- trackRecord_nuseds_gfeid$i == i
iid <- trackRecord_nuseds_gfeid$IndexId[cond_i] |> unique()  # CM_46984
gfeid <- trackRecord_nuseds_gfeid$GFE_ID[cond_i] |> unique() # 2529
gfeid_a <- trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i] |> unique()

cond <- conservation_unit_system_sites$GFE_ID %in% c(gfeid,gfeid_a)
conservation_unit_system_sites[cond,c("SYSTEM_SITE","GFE_ID","Y_LAT","X_LONGT")] |> unique()

# cond <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID == gfeid
# cond2 <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID == gfeid_a
# cols <- c("Year","MAX_ESTIMATE","ESTIMATE_CLASSIFICATION")
# check <- merge(x = all_areas_nuseds[cond,cols],
#                y =  all_areas_nuseds[cond2,cols],
#                by = "Year",all = T)
# check

# add to conservation_unit_system_sites

cuss_new <- CUSS_newRow_fun(IndexId = iid,
                            GFE_ID = gfeid,
                            conservation_unit_system_sites = conservation_unit_system_sites,
                            all_areas_nuseds = all_areas_nuseds)

conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                        cuss_new)

toAdd <- data.frame(IndexId = iid,
                    GFE_ID = gfeid,
                    dataset = "CUSS",
                    CU_NAME = cuss_new$CU_NAME,
                    comment = "Series not in CUSS and not merged with CM_46984 - 62 because of different location")

added_all <- rbind(added_all,toAdd)
```

In case i = `r i`: the focal series `r paste("CM_46984","2529",sep = " - ")` is added to **CUSS** instead of being merged to the alternative series because the two series are not compatible and in two different locations.

```{r, include=FALSE}
# CM_46984
i <- i + 1 # 29
cond_i <- trackRecord_nuseds_gfeid$i == i
iid <- trackRecord_nuseds_gfeid$IndexId[cond_i] |> unique()
gfeid <- trackRecord_nuseds_gfeid$GFE_ID[cond_i] |> unique()
gfeid_a <- trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i] |> unique()


removed <- data.frame(IndexId = iid,
                      GFE_ID = gfeid)
removed$dataset <- "NUSEDS"
removed$comment <- c("Series not in CUSS, not merged to alternative series CM_47907 - 7 because its only one data point is conflictual and anterior to 2020")
removed_all <- rbind(removed_all,removed)

cond <- all_areas_nuseds$IndexId == iid & all_areas_nuseds$GFE_ID == gfeid
all_areas_nuseds <- all_areas_nuseds[!cond,]
```

In case i = `r i`: the focal series `r paste("CM_47907","5",sep = " - ")` is removed from **NUSEDS** because it only has one data point, it is conflictual with the alternative series and it is anterior to 2020.

```{r, include=FALSE}
# SX_45182
i <- i + 1 # 30
cond_i <- trackRecord_nuseds_gfeid$i == i
iid <- trackRecord_nuseds_gfeid$IndexId[cond_i] |> unique()
gfeid <- trackRecord_nuseds_gfeid$GFE_ID[cond_i] |> unique()
gfeid_a <- trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i] |> unique()

cond <- conservation_unit_system_sites$GFE_ID %in% c(gfeid,gfeid_a)
conservation_unit_system_sites[cond,c("SYSTEM_SITE","GFE_ID","Y_LAT","X_LONGT")] |> unique()


removed <- data.frame(IndexId = iid,
                      GFE_ID = gfeid)
removed$dataset <- "NUSEDS"
removed$comment <- c("Series not in CUSS, merged to alternative series SX_45182 - 7990630 because its one data point is compatible and locations are close")
removed_all <- rbind(removed_all,removed)

all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = iid,
                                                IndexId_alter = iid,
                                                GFE_ID_focal = gfeid,
                                                GFE_ID_alter = gfeid_a,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)
```

In case i = `r i`: the focal series `r paste(iid,gfeid,sep = " - ")` is merged to the alternative series `r paste(iid,gfeid_a,sep = " - ")` (top plot) because locations are very close and the one data point is compatible.

```{r, include=FALSE}
# 31:36
i <- i + 1 #
is <- i:(i + 5)

cond_i <- trackRecord_nuseds_gfeid$i %in% is
trackRecord_nuseds_gfeid[cond_i,]

cond <- conservation_unit_system_sites$GFE_ID %in% c(446068199,2618)
conservation_unit_system_sites[cond,c("SYSTEM_SITE","GFE_ID","Y_LAT","X_LONGT")] |> unique()

cond <- DFO_All_Streams_Segments$ID %in% c(446068199,2618)
DFO_All_Streams_Segments[cond,c("NME","ID","Y_LAT","X_LONGT")] |> unique()

cond <- DFO_hatchery$REL_GFE_ID %in% c(446068199,2618) | DFO_hatchery$STOCK_GFE_ID %in% c(446068199,2618)
DFO_hatchery[cond,c("RELEASE_SITE_NAME","REL_GFE_ID","REL_LATITUDE","REL_LONGITUDE","STOCK_GFE_ID","STOCK_LONGITUDE")] |> unique()

```

In the cases (i = `r paste0(is,collapse = ", ")`): there are two recurrent `GFE_ID`s of focal series that seem to be the same locations because they have the same `WATERBODY` in **NUSEDS**:

```{r, echo=FALSE}
cond <- all_areas_nuseds$GFE_ID %in% c(446068199,2618)
show <- all_areas_nuseds[cond,c("WATERBODY","GFE_ID")] |> unique()
rownames(show) <- NULL
show
```

These two `GFE_ID`s are not in **CUSS**, and only one is in the **DFO streams file**:

```{r, echo=FALSE}
cond <- DFO_All_Streams_Segments$ID %in% c(446068199,2618)
show <- DFO_All_Streams_Segments[cond,c("NME","ID","Y_LAT","X_LONGT")] |> unique()
rownames(show) <- NULL
show
```

In addition, the two focal series with these `GFE_ID`s are compatible in each cases, so we decide to merge them by changing the `GFE_ID` from 446068199 to 2618 in **NUSEDS**:

```{r, echo=FALSE}
cond <- trackRecord_nuseds_gfeid$i %in% is
gfeids <- trackRecord_nuseds_gfeid$GFE_ID[cond] |> as.numeric() |> unique()

for(i in is){
  # i <- is[1]
  cond_i <- trackRecord_nuseds_gfeid$i == i
  gfeid <- trackRecord_nuseds_gfeid$GFE_ID[cond_i] |> unique()
  
  if(sum(gfeid %in% c(446068199,2618)) == 2){
    
    print(paste0("In case i = ",i,", focal series ",iid," - ",446068199," merged to focal series ",iid," - ",2618))
    
    iid <- trackRecord_nuseds_gfeid$IndexId[cond_i] |> unique()
    
    removed <- data.frame(IndexId = iid,
                          GFE_ID = 446068199)
    removed$dataset <- "NUSEDS"
    removed$comment <- c("Series not in CUSS, merged to OTHER FOCAL series with same IndexId and GFE_ID = 2618")
    removed_all <- rbind(removed_all,removed)
    
    all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                    IndexId_focal = iid,
                                                    IndexId_alter = iid,
                                                    GFE_ID_focal = 446068199,
                                                    GFE_ID_alter = 2618,
                                                    all_areas_nuseds = all_areas_nuseds,
                                                    conservation_unit_system_sites = conservation_unit_system_sites)
    print("")
  }
}
```

The resulting merged focal series are not merged to the alternative series but are added to **CUSS** instead.

```{r,echo=FALSE}
for(i in is){
  # i <- is[1]
  cond_i <- trackRecord_nuseds_gfeid$i == i & trackRecord_nuseds_gfeid$GFE_ID != 446068199
  
  cuss_new <- CUSS_newRow_fun(IndexId = trackRecord_nuseds_gfeid$IndexId[cond_i],
                              GFE_ID = trackRecord_nuseds_gfeid$GFE_ID[cond_i],
                              conservation_unit_system_sites = conservation_unit_system_sites,
                              all_areas_nuseds = all_areas_nuseds)
  
  if(is.na(cuss_new$Y_LAT)){ # should only be needed one time
    cond <- DFO_All_Streams_Segments$ID == cuss_new$GFE_ID
    cuss_new$Y_LAT <- DFO_All_Streams_Segments$Y_LAT[cond] |> as.numeric()
    cuss_new$X_LONGT <- DFO_All_Streams_Segments$X_LONGT[cond] |> as.numeric()
    cuss_new$coordinates_changed <- F
  }
  
  conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                          cuss_new)

  toAdd <- data.frame(IndexId = trackRecord_nuseds_gfeid$IndexId[cond_i],
                      GFE_ID = trackRecord_nuseds_gfeid$GFE_ID[cond_i],
                      dataset = "CUSS",
                      CU_NAME = cuss_new$CU_NAME,
                      comment = paste0("Series not in CUSS and not merged with ",
                                       trackRecord_nuseds_gfeid$IndexId[cond_i]," - ",
                                       trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i],
                                       " because of different location"))
  
  added_all <- rbind(added_all,toAdd)
}
```

```{r, include=FALSE}
i <- i + 1 # 37 PKO_51094
cond_i <- trackRecord_nuseds_gfeid$i == i
iid <- trackRecord_nuseds_gfeid$IndexId[cond_i] |> unique()
gfeid <- trackRecord_nuseds_gfeid$GFE_ID[cond_i] |> unique()
gfeid_a <- trackRecord_nuseds_gfeid$alternative_GFE_ID[cond_i] |> unique()

cond <- conservation_unit_system_sites$GFE_ID %in% c(gfeid,gfeid_a)
conservation_unit_system_sites[cond,c("SYSTEM_SITE","GFE_ID","Y_LAT","X_LONGT")] |> unique()

cond <- DFO_All_Streams_Segments$ID %in% c(gfeid,gfeid_a)
DFO_All_Streams_Segments[cond,c("NME","ID","Y_LAT","X_LONGT")] |> unique()

cond <- DFO_hatchery$REL_GFE_ID %in% c(gfeid,gfeid_a) | DFO_hatchery$STOCK_GFE_ID %in% c(gfeid,gfeid_a)
DFO_hatchery[cond,c("RELEASE_SITE_NAME","REL_GFE_ID","REL_LATITUDE","REL_LONGITUDE","STOCK_GFE_ID","STOCK_WATERBODY_NAME","STOCK_LONGITUDE")] |> unique()

# merge the data point
removed <- data.frame(IndexId = iid,
                      GFE_ID = gfeid)
removed$dataset <- "NUSEDS"
removed$comment <- c("Series not in CUSS, merged to alternative series IndexId = CM_47928 & GFE_ID = 872")
removed_all <- rbind(removed_all,removed)

all_areas_nuseds <- fields_edit_NUSEDS_CUSS_fun(edit_NUSEDS = T, 
                                                IndexId_focal = iid,
                                                IndexId_alter = iid,
                                                GFE_ID_focal = gfeid,
                                                GFE_ID_alter = gfeid_a,
                                                all_areas_nuseds = all_areas_nuseds,
                                                conservation_unit_system_sites = conservation_unit_system_sites)
```

In case i = `r i`: the focal series `r paste(iid,gfeid,sep = " - ")`'s `GFE_ID = 489440637` is not in **CUSS**, nor in the other two DFO files. The Atltzi river is close to the Kingcome river and the one data point is compatible with the alternative series `r paste(iid,gfeid_a,sep = " - ")`, to which it is consequently merged to.  


### No alternative series

```{r, include=FALSE}
cond <- trackRecord_nuseds$alternative_GFE_ID == "none" &
  trackRecord_nuseds$alternative_IndexId == "none" 
  # !cond_3
trackRecord_nuseds_nocuss <- trackRecord_nuseds[cond,]
nb_rows <- nrow(trackRecord_nuseds_nocuss) # 166
nb_rows
rownames(trackRecord_nuseds_nocuss) <- NULL
```

There remain `r nb_rows` series in **NUSEDS** with no alternative series, i.e., both their `IndexId` (`POP_ID`) and `SPECIES & GFE_ID` are absent from **CUSS**. We rescue these time series by identifying the CU they belong to using the CUs' shape files of the PSE. Series with `X_LONGT` and `Y_LAT` values that intersects one unique CU layer of the same species are attributed the CU's `FULL_CU_IN` and `CU_NAME` and the reference is added to **CUSS**.

```{r,echo=FALSE}
trackRecord_nuseds_nocuss[,c("IndexId","GFE_ID","nb_dataPt","alternative_IndexId","alternative_GFE_ID")]
```

```{r,include=FALSE}
# Find the coordinates corresponding to the GFE_ID

trackRecord_nuseds_nocuss$X_LONGT <- NA
trackRecord_nuseds_nocuss$Y_LAT <- NA
trackRecord_nuseds_nocuss$SYSTEM_SITE <- NA
for(r in 1:nrow(trackRecord_nuseds_nocuss)){
  # r <- 22

  GFE_ID <- trackRecord_nuseds_nocuss$GFE_ID[r]
  Y_LAT <- NA
  X_LONGT <- NA
  SYSTEM_SITE <- NA
  
  if((is.na(X_LONGT) | is.na(Y_LAT)) & GFE_ID %in% conservation_unit_system_sites$GFE_ID){
    cond <- conservation_unit_system_sites$GFE_ID == GFE_ID
    X_LONGT <- conservation_unit_system_sites$X_LONGT[cond] |> as.numeric() |> unique()
    Y_LAT <- conservation_unit_system_sites$Y_LAT[cond] |> as.numeric() |> unique()
    SYSTEM_SITE <- conservation_unit_system_sites$SYSTEM_SITE[cond] |> unique()
  }
  
  if((is.na(X_LONGT) | is.na(Y_LAT)) & GFE_ID %in% conservation_unit_system_sites_all$GFE_ID){
    cond <- conservation_unit_system_sites_all$GFE_ID == GFE_ID
    X_LONGT <- conservation_unit_system_sites_all$X_LONGT[cond] |> as.numeric() |> unique()
    Y_LAT <- conservation_unit_system_sites_all$Y_LAT[cond] |> as.numeric() |> unique()
    SYSTEM_SITE <- conservation_unit_system_sites_all$SYSTEM_SITE[cond] |> unique()
  }
  
  # check if GFE_ID is in DFO_All_Streams_Segments and has coordinates associated
  if((is.na(X_LONGT) | is.na(Y_LAT)) & GFE_ID %in% DFO_All_Streams_Segments$ID){
    cond <- DFO_All_Streams_Segments$ID == GFE_ID
    X_LONGT <- DFO_All_Streams_Segments$X_LONGT[cond] |> as.numeric() |> unique()
    Y_LAT <- DFO_All_Streams_Segments$Y_LAT[cond] |> as.numeric() |> unique()
    SYSTEM_SITE <- DFO_All_Streams_Segments$NME[cond] |> unique()
  }
  
  if((is.na(X_LONGT) | is.na(Y_LAT)) & GFE_ID %in% DFO_hatchery$STOCK_GFE_ID){
    cond <- DFO_hatchery$STOCK_GFE_ID == GFE_ID & !is.na(DFO_hatchery$STOCK_GFE_ID)
    SYSTEM_SITE <- DFO_hatchery$STOCK_GFE_NAME[cond]  |> unique()
    X_LONGT <- DFO_hatchery$STOCK_LONGITUDE[cond] |> as.numeric() |> unique()
    Y_LAT <- DFO_hatchery$STOCK_LATITUDE[cond] |> as.numeric() |> unique()
    
    # DFO_hatchery[cond,c("STOCK_GFE_NAME","STOCK_GFE_ID","STOCK_LONGITUDE","STOCK_LATITUDE")] |> unique()
    
    if(SYSTEM_SITE == "CHILCOTIN RIVER (UPPER)"){
      # there are two different coordinates for this GFE_ID
      # We pick the 1st one, which points to the Chilcotin Lake, the second one
      # points to above the lake
      # 52.339295 -124.028396 
      # 52.362222 -124.009489
      X_LONGT <- X_LONGT[1]
      Y_LAT <- Y_LAT[1]
      SYSTEM_SITE <- "CHILCOTIN RIVER - UPPER" # as in DFO_All_Streams_Segments
    }
    # DFO_hatchery[cond,c("STOCK_WATERBODY_NAME","STOCK_LATITUDE","STOCK_LONGITUDE")] |> unique() |> as.data.frame()
  }
  
  if((is.na(X_LONGT) | is.na(Y_LAT)) & GFE_ID %in% DFO_hatchery$REL_GFE_ID){
    cond <- DFO_hatchery$REL_GFE_ID == GFE_ID & !is.na(DFO_hatchery$REL_GFE_ID)
    X_LONGT <- DFO_hatchery$REL_LONGITUDE[cond] |> as.numeric() |> unique()
    Y_LAT <- DFO_hatchery$REL_LATITUDE[cond] |> as.numeric() |> unique()
    SYSTEM_SITE <- DFO_hatchery$REL_WATERBODY_NAME[cond]  |> unique()
    # DFO_hatchery$RELEASE_SITE_NAME is the same but lower case with abbreviations 
  }
  
  trackRecord_nuseds_nocuss$X_LONGT[r] <- X_LONGT
  trackRecord_nuseds_nocuss$Y_LAT[r] <- Y_LAT
  trackRecord_nuseds_nocuss$SYSTEM_SITE[r] <- SYSTEM_SITE
}

# Find the POPOULATION
trackRecord_nuseds_nocuss$WATERBODY <- apply(trackRecord_nuseds_nocuss,1,function(r){
  cond1 <- all_areas_nuseds$IndexId == r["IndexId"]
  cond2 <- all_areas_nuseds$GFE_ID == r["GFE_ID"]
  return(unique(all_areas_nuseds$WATERBODY[cond1 & cond2]))
})

# does not provide more info than WATERBODY
# trackRecord_nuseds_nocuss$GAZETTED_NAME <- apply(trackRecord_nuseds_nocuss,1,function(r){
#   cond1 <- all_areas_nuseds$IndexId == r["IndexId"]
#   cond2 <- all_areas_nuseds$GFE_ID == r["GFE_ID"]
#   return(unique(all_areas_nuseds$GAZETTED_NAME[cond1 & cond2]))
# })

cond_NA <- is.na(trackRecord_nuseds_nocuss$X_LONGT)
GFE_ID_NA <- unique(trackRecord_nuseds_nocuss$GFE_ID[cond_NA])
```

The are `r length(GFE_ID_NA)` time series without coordinates provided for their `GFE_ID`. We use the `SYSTEM_SITE` (if available) and `WATERBODY` and Google Maps to define `X_LONGT` and `Y_LAT` manually when possible:

```{r, include=FALSE}
trackRecord_nuseds_nocuss$coordinates_changed <- F

i <- 1
cond <- trackRecord_nuseds_nocuss$GFE_ID[cond_NA] == GFE_ID_NA[i]
unique(trackRecord_nuseds_nocuss[cond_NA,c("GFE_ID","WATERBODY","X_LONGT","Y_LAT")][cond,])
# RETURN CHANNEL CREEKS ???

i <- i + 1
cond <- trackRecord_nuseds_nocuss$GFE_ID[cond_NA] == GFE_ID_NA[i]
unique(trackRecord_nuseds_nocuss[cond_NA,c("GFE_ID","WATERBODY","X_LONGT","Y_LAT")][cond,])
# KENNEDY LAKE BEACHES
trackRecord_nuseds_nocuss$X_LONGT[cond_NA][cond] <- -125.580441
trackRecord_nuseds_nocuss$Y_LAT[cond_NA][cond] <- 49.049133 
trackRecord_nuseds_nocuss$coordinates_changed[cond_NA][cond] <- T

i <- i + 1
cond <- trackRecord_nuseds_nocuss$GFE_ID[cond_NA] == GFE_ID_NA[i]
unique(trackRecord_nuseds_nocuss[cond_NA,c("GFE_ID","WATERBODY","X_LONGT","Y_LAT")][cond,])
# SILVERMERE LAKE
trackRecord_nuseds_nocuss$X_LONGT[cond_NA][cond] <- -122.408753
trackRecord_nuseds_nocuss$Y_LAT[cond_NA][cond] <- 49.174967
trackRecord_nuseds_nocuss$coordinates_changed[cond_NA][cond] <- T

i <- i + 1
cond <- trackRecord_nuseds_nocuss$GFE_ID[cond_NA] == GFE_ID_NA[i]
unique(trackRecord_nuseds_nocuss[cond_NA,c("GFE_ID","WATERBODY","X_LONGT","Y_LAT")][cond,])
# CAMILOS CREEK
# https://geonames.nrcan.gc.ca/search-place-names/unique?id=JASOL
trackRecord_nuseds_nocuss$X_LONGT[cond_NA][cond] <- -121.393056
trackRecord_nuseds_nocuss$Y_LAT[cond_NA][cond] <- 49.386667
trackRecord_nuseds_nocuss$coordinates_changed[cond_NA][cond] <- T

i <- i + 1 # 5
cond <- trackRecord_nuseds_nocuss$GFE_ID[cond_NA] == GFE_ID_NA[i]
unique(trackRecord_nuseds_nocuss[cond_NA,c("GFE_ID","WATERBODY","X_LONGT","Y_LAT")][cond,])
# HANSEN CREEK
# https://geonames.nrcan.gc.ca/search-place-names/unique?id=JALWQ
trackRecord_nuseds_nocuss$X_LONGT[cond_NA][cond] <- -128.346389
trackRecord_nuseds_nocuss$Y_LAT[cond_NA][cond] <- 50.778889
trackRecord_nuseds_nocuss$coordinates_changed[cond_NA][cond] <- T

i <- i + 1
cond <- trackRecord_nuseds_nocuss$GFE_ID[cond_NA] == GFE_ID_NA[i]
unique(trackRecord_nuseds_nocuss[cond_NA,c("GFE_ID","WATERBODY","X_LONGT","Y_LAT")][cond,])
# STAMP RIVER BELOW FALLS
cond <- grepl("STAMP",conservation_unit_system_sites$SYSTEM_SITE)
conservation_unit_system_sites[cond,c("SYSTEM_SITE","GFE_ID","Y_LAT","X_LONGT")] |> unique()
# point takien from Google Maps below the Falls
trackRecord_nuseds_nocuss$X_LONGT[cond_NA][cond] <- -124.911882
trackRecord_nuseds_nocuss$Y_LAT[cond_NA][cond] <- 49.327917
trackRecord_nuseds_nocuss$coordinates_changed[cond_NA][cond] <- T

i <- i + 1 # 7
cond <- trackRecord_nuseds_nocuss$GFE_ID[cond_NA] == GFE_ID_NA[i]
unique(trackRecord_nuseds_nocuss[cond_NA,c("GFE_ID","WATERBODY","X_LONGT","Y_LAT")][cond,])
# SEMMIHAULT CREEK
# https://geonames.nrcan.gc.ca/search-place-names/unique?id=JBHMC
trackRecord_nuseds_nocuss$X_LONGT[cond_NA][cond] <- -121.956111
trackRecord_nuseds_nocuss$Y_LAT[cond_NA][cond] <- 49.153056
trackRecord_nuseds_nocuss$coordinates_changed[cond_NA][cond] <- T
 
i <- i + 1 # 8
cond <- trackRecord_nuseds_nocuss$GFE_ID[cond_NA] == GFE_ID_NA[i]
unique(trackRecord_nuseds_nocuss[cond_NA,c("GFE_ID","WATERBODY","X_LONGT","Y_LAT")][cond,])
# MCLELLAN CREEK
# "McLellan creek is located 8 km east of townsite Bella Coola"
# in https://www.env.gov.bc.ca/cariboo/env_stewardship/wrp/reports/fhap/six_creeks-bellacoola/the6cr.html
cond_iid <- all_areas_nuseds$IndexId == unique(trackRecord_nuseds_nocuss$IndexId[cond_NA][cond])
unique(all_areas_nuseds$POPULATION[cond_iid]) # "Mclellan Creek (Bella Coola) Coho"
unique(all_areas_nuseds$WATERBODY[cond_iid])  # "MCLELLAN CREEK"
# not there:
# https://geonames.nrcan.gc.ca/search-place-names/search?id=&snrc=&q=MCLELLAN+CREEK&category=O
# --> matches with POPULATION
trackRecord_nuseds_nocuss$X_LONGT[cond_NA][cond] <- -126.619731
trackRecord_nuseds_nocuss$Y_LAT[cond_NA][cond] <- 52.387830
trackRecord_nuseds_nocuss$coordinates_changed[cond_NA][cond] <- T

i <- i + 1 # 9
cond <- trackRecord_nuseds_nocuss$GFE_ID[cond_NA] == GFE_ID_NA[i]
unique(trackRecord_nuseds_nocuss[cond_NA,c("GFE_ID","WATERBODY","X_LONGT","Y_LAT")][cond,])
# COTTONWOOD CREEK
cond_iid <- all_areas_nuseds$IndexId == unique(trackRecord_nuseds_nocuss$IndexId[cond_NA][cond])
unique(all_areas_nuseds$POPULATION[cond_iid]) # "Cottonwood Creek (Squamish) Coho Run 1"
unique(all_areas_nuseds$WATERBODY[cond_iid])  # "COTTONWOOD CREEK"
# not there
# https://geonames.nrcan.gc.ca/search-place-names/search?id=&snrc=&q=COTTONWOOD+CREEK&category=O
# selected the stream leading to Cottonwood Park in Squamish
trackRecord_nuseds_nocuss$X_LONGT[cond_NA][cond] <- -123.145631
trackRecord_nuseds_nocuss$Y_LAT[cond_NA][cond] <- 49.762523
trackRecord_nuseds_nocuss$coordinates_changed[cond_NA][cond] <- T

i <- i + 1 # 10
cond <- trackRecord_nuseds_nocuss$GFE_ID[cond_NA] == GFE_ID_NA[i]
unique(trackRecord_nuseds_nocuss[cond_NA,c("GFE_ID","WATERBODY","X_LONGT","Y_LAT")][cond,])
# FEE CREEK ???
cond_iid <- all_areas_nuseds$IndexId == unique(trackRecord_nuseds_nocuss$IndexId[cond_NA][cond])
unique(all_areas_nuseds$POPULATION[cond_iid]) # "Fee Creek (Squamish) Coho Run 1"
unique(all_areas_nuseds$WATERBODY[cond_iid])  # "FEE CREEK"
length(all_areas_nuseds$POPULATION[cond_iid]) # 2

i <- i + 1 # 11
cond <- trackRecord_nuseds_nocuss$GFE_ID[cond_NA] == GFE_ID_NA[i]
unique(trackRecord_nuseds_nocuss[cond_NA,c("GFE_ID","WATERBODY","X_LONGT","Y_LAT")][cond,])
# OLSEN CREEK ???
cond_iid <- all_areas_nuseds$IndexId == unique(trackRecord_nuseds_nocuss$IndexId[cond_NA][cond])
unique(all_areas_nuseds$POPULATION[cond_iid]) # "Olsen Creek (Coquitlam) Early Summer Sockeye Run 1"
unique(all_areas_nuseds$WATERBODY[cond_iid])  # "OLSEN CREEK"
length(all_areas_nuseds$POPULATION[cond_iid]) # 8
max(all_areas_nuseds$Year[cond_iid]) # 2023
# in https://publications.gc.ca/collections/collection_2017/mpo-dfo/Fs23-323-1-1997-eng.pdf
#  "Olsen Creek (which enters the Pitt River opposite Fish Hatchery Creek) on the Upper Pitt River"
trackRecord_nuseds_nocuss$X_LONGT[cond_NA][cond] <- -122.631537
trackRecord_nuseds_nocuss$Y_LAT[cond_NA][cond] <- 49.597168
trackRecord_nuseds_nocuss$coordinates_changed[cond_NA][cond] <- T

i <- i + 1 # 12
cond <- trackRecord_nuseds_nocuss$GFE_ID[cond_NA] == GFE_ID_NA[i]
unique(trackRecord_nuseds_nocuss[cond_NA,c("GFE_ID","WATERBODY","X_LONGT","Y_LAT")][cond,])
# CLAYOQUOT ARM BEACHES
trackRecord_nuseds_nocuss$X_LONGT[cond_NA][cond] <- -125.591878
trackRecord_nuseds_nocuss$Y_LAT[cond_NA][cond] <- 49.099033
trackRecord_nuseds_nocuss$coordinates_changed[cond_NA][cond] <- T
#

i <- i + 1 # 13
cond <- trackRecord_nuseds_nocuss$GFE_ID[cond_NA] == GFE_ID_NA[i]
unique(trackRecord_nuseds_nocuss[cond_NA,c("GFE_ID","WATERBODY","X_LONGT","Y_LAT")][cond,])
# MOORE LAKE
# from Google Maps
trackRecord_nuseds_nocuss$X_LONGT[cond_NA][cond] <- -129.501134
trackRecord_nuseds_nocuss$Y_LAT[cond_NA][cond] <- 53.409530 
trackRecord_nuseds_nocuss$coordinates_changed[cond_NA][cond] <- T
cond_iid <- all_areas_nuseds$IndexId == unique(trackRecord_nuseds_nocuss$IndexId[cond_NA][cond])
unique(all_areas_nuseds$POPULATION[cond_iid]) # "Moore Lake (Grenville Principe) Sockeye"
unique(all_areas_nuseds$WATERBODY[cond_iid])  # MOORE LAKE
length(all_areas_nuseds$POPULATION[cond_iid]) # 3
max(all_areas_nuseds$Year[cond_iid]) # 2023

i <- i + 1 # 14
cond <- trackRecord_nuseds_nocuss$GFE_ID[cond_NA] == GFE_ID_NA[i]
unique(trackRecord_nuseds_nocuss[cond_NA,c("GFE_ID","WATERBODY","X_LONGT","Y_LAT")][cond,])
# ATNARKO LAKES
trackRecord_nuseds_nocuss$X_LONGT[cond_NA][cond] <- -125.713941
trackRecord_nuseds_nocuss$Y_LAT[cond_NA][cond] <- 52.163834
trackRecord_nuseds_nocuss$coordinates_changed[cond_NA][cond] <- T
cond_iid <- all_areas_nuseds$IndexId == unique(trackRecord_nuseds_nocuss$IndexId[cond_NA][cond])
unique(all_areas_nuseds$POPULATION[cond_iid]) # 
unique(all_areas_nuseds$WATERBODY[cond_iid])  # 
length(all_areas_nuseds$POPULATION[cond_iid]) # 
max(all_areas_nuseds$Year[cond_iid]) # 
# 'https://www.ccira.ca/wp-content/uploads/2018/07/AtnarkoSockeyRecoveryPlan-FullSizeRender-45.pdf
#' the five lakes:
#' - Elbow
#' - Rainbow
#' - Tenas      --> 52.163834, -125.713941
#' - Lonesome
#' - Stillwater
```

```{r, echo=FALSE}
show <- unique(trackRecord_nuseds_nocuss[cond_NA,c("GFE_ID","WATERBODY","X_LONGT","Y_LAT","coordinates_changed")])
rownames(show) <- NULL
show
```

```{r, include=FALSE}

# FIX: there are values that are " " instead of being NA in CUs_gdb:
cond <- CUs_gdb$FULL_CU_IN == " " & !is.na(CUs_gdb$FULL_CU_IN)
sum(cond) # 89
d <- CUs_gdb[cond,c("region","species","cu_name_pse","CU_NAME","CUID","FULL_CU_IN")] |> as.data.frame()
d <- d[,colnames(d) != "Shape"]

cuids <- CUs_gdb$CUID[cond]
length(unique(cuids)) # 89
sum(is.na(cuids)) # 0

d$FULL_CU_IN_decoder <- sapply(cuids,function(cu){
  cond <- conservationunits_decoder$cuid == cu
  return(conservationunits_decoder$cu_index[cond])
})

d

for(r in 1:nrow(CUs_gdb[cond,])){
  cuid <- CUs_gdb$CUID[cond][r]
  FULL_CU_IN <- sapply(cuid,function(cu){
    cond <- conservationunits_decoder$cuid == cu
    return(conservationunits_decoder$cu_index[cond])
  })
  CUs_gdb$FULL_CU_IN[cond][r] <- FULL_CU_IN
}

CUs_gdb[cond,c("region","species","cu_name_pse","CU_NAME","CUID","FULL_CU_IN")]

sum(trackRecord_nuseds_nocuss$GFE_ID %in% conservation_unit_system_sites_all$GFE_ID) # 107 24
sum(trackRecord_nuseds_nocuss$GFE_ID %in% DFO_All_Streams_Segments$ID) # 146 34

sum(trackRecord_nuseds_nocuss$GFE_ID %in% conservation_unit_system_sites$GFE_ID | trackRecord_nuseds_nocuss$GFE_ID %in% DFO_All_Streams_Segments$ID) # 153 35

trackRecord_nuseds_nocuss$cuid <- NA
trackRecord_nuseds_nocuss$CU_NAME <- NA
trackRecord_nuseds_nocuss$cu_name_pse <- NA
trackRecord_nuseds_nocuss$FULL_CU_IN <- NA
trackRecord_nuseds_nocuss$comment <- NA

for(r in 1:nrow(trackRecord_nuseds_nocuss)){
  # r <- 22
  # r <- which(trackRecord_nuseds_nocuss$WATERBODY == "KENNEDY LAKE BEACHES" & trackRecord_nuseds_nocuss$IndexId == "SX_52080")
  # r <- which(trackRecord_nuseds_nocuss$GFE_ID == 64745 & trackRecord_nuseds_nocuss$IndexId == "SX_7818")
  
  print(paste0("*** r = ",r," ***"))
  
  GFE_ID <- trackRecord_nuseds_nocuss$GFE_ID[r]
  Y_LAT <- trackRecord_nuseds_nocuss$Y_LAT[r]
  X_LONGT <- trackRecord_nuseds_nocuss$X_LONGT[r]
  comment <- NA
  
  cond <- all_areas_nuseds$IndexId ==  trackRecord_nuseds_nocuss$IndexId[r] & 
     all_areas_nuseds$GFE_ID ==  trackRecord_nuseds_nocuss$GFE_ID[r]
  
  POPULATION <- unique(all_areas_nuseds$POPULATION[cond])
  WATERBODY <- trackRecord_nuseds_nocuss$WATERBODY[r]
  
  # plot_IndexId_GFE_ID_fun(IndexIds = trackRecord_nuseds_nocuss$IndexId[r],
  #                         GFE_IDs = trackRecord_nuseds_nocuss$GFE_ID[r],
  #                         all_areas_nuseds = all_areas_nuseds)
  # 
  # legend("bottomleft",paste0("i = ",r),bty = "n")
  
  
  if(is.na(X_LONGT) | is.na(Y_LAT)){
    comment <- paste(comment,"No coordinates available", sep = "; ")
    
  }else{
    
    # Find the region
    # https://stackoverflow.com/questions/75669453/r-check-to-see-if-coordinates-fall-inside-outside-of-a-shapefile-polygon
    point <- st_as_sf(trackRecord_nuseds_nocuss[r,], 
                      coords = c("X_LONGT","Y_LAT"), crs = 4269)
    
    layer_rg <- st_intersects(point, regions_shp)
    
    if(length(layer_rg[[1]]) == 0){ # no match, try to buffer
      layer_rg <- st_intersects(point, st_buffer(x = regions_shp, dist = .001))
    }
    
    if(length(layer_rg[[1]]) == 0){ # no match, try to buffer
      layer_rg <- st_intersects(point, st_buffer(x = regions_shp, dist = .002))
    }
    
    if(length(layer_rg[[1]]) == 0){ # no match, try to buffer
      print("Region layer not found - BREAK")
      break
    }
    
    # if(length(layer_rg[[1]]) == 0){ # no match, try to buffer
    #   layer_rg <- st_intersects(point, st_buffer(x = regions_shp, dist = .01))
    # }
    # if(length(layer_rg[[1]]) == 0){ # no match, try to buffer
    #   layer_rg <- st_intersects(point, st_buffer(x = regions_shp, dist = .05))
    # }
    # if(length(layer_rg[[1]]) == 0){ # no match, try to buffer
    #   layer_rg <- st_intersects(point, st_buffer(x = regions_shp, dist = .1))
    # }
    # if(length(layer_rg[[1]]) == 0){ # no match, try to buffer
    #   layer_rg <- st_intersects(point, st_buffer(x = regions_shp, dist = .2))
    # }
    # if(length(layer_rg[[1]]) == 0){ # no match, try to buffer
    #   layer_rg <- st_intersects(point, st_buffer(x = regions_shp, dist = .4))
    # }
    
    # CHECK
    # plot(st_geometry(regions_shp))
    # plot(st_geometry(regions_shp[layer_rg[[1]],]))
    # plot(st_geometry(point), add = T, col = "red", pch = 16, cex = 2)
    
    if(length(layer_rg[[1]]) > 1){
      print("More than one region - BREAK")
      break
      
    }else{
      layer_rg <- layer_rg[[1]]
      region <- regions_shp$regionname[layer_rg]
      
      species <- NA
      if(grepl("CM",trackRecord_nuseds_nocuss$IndexId[r])){
        species <- "Chum"
      }else if(grepl("CO",trackRecord_nuseds_nocuss$IndexId[r])){
        species <- "Coho"
      }else if(grepl("CN",trackRecord_nuseds_nocuss$IndexId[r])){
        species <- "Chinook"
      }else if(grepl("PKE",trackRecord_nuseds_nocuss$IndexId[r])){
        species <- "Pink even"
      }else if(grepl("PKO",trackRecord_nuseds_nocuss$IndexId[r])){
        species <- "Pink odd"
      }else if(grepl("SX",trackRecord_nuseds_nocuss$IndexId[r])){
        species <- c("River sockeye","Lake sockeye")
      }
      
      cond_rg_sp <- CUs_gdb$region == region & CUs_gdb$species %in% species
      
      if(!any(cond_rg_sp)){
        print("Issue with region - species combo in CUs_gdb - BREAK")
        break
        
      }else{
        
        #' some specific case where the CU belong to two regions but is associatd to 
        #' only one in CUs_gdb
        cond_exception_PKE_2236 <- any(species == "Pink even") & GFE_ID == 2236 # WATERBODY = DAK RIVER --> point is in Nass but CU "Nass-Skeena Estuary" only appears in Skeena
        
        if(cond_exception_PKE_2236){
          cond_rg_sp <- CUs_gdb$region == "Skeena" & CUs_gdb$species %in% species
        }
        
        layer_CU <- st_intersects(point,  CUs_gdb[cond_rg_sp,])
        
        if(length(layer_CU[[1]]) == 0){ # no match, try to buffer
          dist <- .05
          layer_CU <- st_intersects(point, st_buffer(x =  CUs_gdb[cond_rg_sp,], dist = dist))
        }
        
        if(length(layer_CU[[1]]) == 0){ # no match, try to buffer
          
          cond_buffer_.2 <- region == "Fraser" & species == "Chum"  # there is only one Chum Cu in the Fraser
          
          if(cond_buffer_.2){
            dist <- .2
            layer_CU <- st_intersects(point, st_buffer(x =  CUs_gdb[cond_rg_sp,], dist = dist))
          }
          
        }
        
        cond_exception_CO_2236 <- trackRecord_nuseds_nocuss$IndexId[r] == "CO_3027" & GFE_ID == 2655
        #' here POPULATION = "Wathlsto Creek (Kitimat-Butedale) Coho"
        #' CU choices = "Douglas Channel-Kitimat Arm" vs. "Northern Coastal Streams" --> the last one
        #' --> "Douglas Channel-Kitimat Arm" selected
        
        cond_exception_SEL_2792 <- trackRecord_nuseds_nocuss$IndexId[r] == "SX_7805" & GFE_ID == 2792
        #' here POPULATION = "Moore Lake (Grenville Principe) Sockeye"
        #' CU choices = "Northern Coastal Fjords" "Tsimtack/Lakes"
        #' --> "Tsimtack/Lakes" selected

        cond_exception_SEL_64745 <- trackRecord_nuseds_nocuss$IndexId[r] == "SX_7818" & GFE_ID == 64745
        #' here POPULATION = "Atnarko Lakes Sockeye"
        #' CU choices = "Northern Coastal Fjords" "South Atnarko Lakes"
        #' --> "South Atnarko Lakes" selected
        
        cond_exception_SEL_1303 <- trackRecord_nuseds_nocuss$IndexId[r] == "SX_52080" & GFE_ID == 1303
        #' here POPULATION = "Kennedy Lake Sockeye"
        #' CU choices =  "West Vancouver Island" "Kennedy"
        #' --> "Kennedy" selected
        
        cond_exception_SER_1307 <- trackRecord_nuseds_nocuss$IndexId[r] == "SX_52120" & GFE_ID == 1307
        #' here POPULATION = "Clayoquot Arm Beaches Sockeye"
        #' CU choices = "West Vancouver Island" "Kennedy" 
        #' --> "West Vancouver Island" selected
        
        cond_exception_CM_2252 <- trackRecord_nuseds_nocuss$IndexId[r] == "CM_7775" & GFE_ID == 2252
        #' here POPULATION =  "Noosgulch River (Bella Coola) Chum"
        #' CU choices = "Bella Coola-Dean Rivers" "Bella Coola River-Late" 
        #' --> "Bella Coola-Dean Rivers" selected

        cond_exception_SX_3077 <- trackRecord_nuseds_nocuss$IndexId[r] == "SX_3077" & GFE_ID == 2753
        #' here POPULATION =  "Butterfield Creek Early Stuart Sockeye"
        #' CU choices = "Takla/Trembleur/Stuart-Summer Timing" "Takla/Trembleur-Early Stuart Timing"
        #' --> "Takla/Trembleur-Early Stuart Timing" selected
        
        cond_exception_SX_3085 <- trackRecord_nuseds_nocuss$IndexId[r] == "SX_3085" & GFE_ID == 2761
        #' here POPULATION =  "Tarnezell Creek Early Stuart Sockeye"
        #' CU choices = "Takla/Trembleur/Stuart-Summer Timing" "Takla/Trembleur-Early Stuart Timing"
        #' --> "Takla/Trembleur-Early Stuart Timing" selected
        
        cond_exception_SX_7640 <- trackRecord_nuseds_nocuss$IndexId[r] == "SX_7640" & GFE_ID == 26773
        #' here POPULATION = "Hlina Creek (Salmon Arm) Late Sockeye"
        #' CU choices = "Shuswap Complex-Early Summer Timing" "Shuswap Complex-Late Timing"
        #' --> "Shuswap Complex-Late Timing" selected
        
        if(length(layer_CU[[1]]) > 1){
          
          comment <- paste(comment,"More than one CU layer: ",sep = "; ")
          CUs <- paste(CUs_gdb[cond_rg_sp,]$CU_NAME[layer_CU[[1]]],collapse = "; ")
          comment <- paste(comment,CUs,collapse = "")
          
          CU_NAME_selected <- NA
          
          if(cond_exception_CO_2236){
            CU_NAME_selected <- "Douglas Channel-Kitimat Arm" 
          }else if(cond_exception_SEL_2792){
            CU_NAME_selected <- "Tsimtack/Lakes"
          }else if(cond_exception_SEL_64745){
            CU_NAME_selected <- "South Atnarko Lakes"
          }else if(cond_exception_SEL_1303){
            CU_NAME_selected <- "Kennedy"
          }else if(cond_exception_SER_1307){
            CU_NAME_selected <- "West Vancouver Island"
          }else if(cond_exception_CM_2252){
            CU_NAME_selected <- "Bella Coola-Dean Rivers"
          }else if(cond_exception_SX_3077 | cond_exception_SX_3085){
            CU_NAME_selected <- "Takla/Trembleur-Early Stuart Timing"
          }else if(cond_exception_SX_7640){
            CU_NAME_selected <- "Shuswap Complex-Late Timing"
          }
          
          if(!is.na(CU_NAME_selected)){
            cond <- CUs_gdb[cond_rg_sp,][layer_CU[[1]],]$CU_NAME == CU_NAME_selected
            # CU_NAME_selected <- CUs_gdb[cond_rg_sp,][layer_CU[[1]],]$CU_NAME[cond]
            comment <- paste0(comment,"; CU selected: ",CU_NAME_selected)
            layer_CU[[1]] <- layer_CU[[1]][cond]
          }
        }

        # plot(st_geometry(regions_shp[layer_rg,]))
        # plot(st_geometry(point), add = T, col = "red", pch = 16, cex = 1)
        # plot(st_geometry(CUs_gdb[cond_rg_sp,][layer_CU[[1]],]), add = T, col = alpha("blue",.3))
        # plot( st_buffer(x =  CUs_gdb[cond_rg_sp,][layer_CU[[1]],], dist = dist),
        #       add = T, col = alpha("green",alpha = .3), pch = 16, cex = 1)
        
        if(length(layer_CU[[1]]) == 0){
          print("Still no match in CUs_GBD - BREAK")
          break
        }
        
        # if still more than one choice
        if(length(layer_CU[[1]]) > 1){
          print("Still more than one CU in CUs_GBD - BREAK")
          break
          
          comment <- paste(comment,"More than one CU layer and not sure which one to choose: ",sep = "; ")
          CUs <- paste(CUs_gdb[cond_rg_sp,]$CU_NAME[layer_CU[[1]]],collapse = "; ")
          comment <- paste(comment,CUs,collapse = "")
            
          # layer_CU
          # CUs_gdb[cond_rg_sp,]$CU_NAME[layer_CU[[1]]]
          # CUs_gdb[cond_rg_sp,]$cu_name_pse[layer_CU]
            
          # CUs_gdb[cond_rg_sp,][layer_CU,]
          # 
          # trackRecord_nuseds_nocuss$IndexId[r]
          # cond <- all_areas_nuseds$IndexId == trackRecord_nuseds_nocuss$IndexId[r]
          # all_areas_nuseds$POPULATION[cond] |> unique()
          
        }else{
          layer_CU <- layer_CU[[1]]
          trackRecord_nuseds_nocuss$CU_NAME[r] <-  CUs_gdb[cond_rg_sp,]$CU_NAME[layer_CU]
          trackRecord_nuseds_nocuss$cuid[r] <- CUs_gdb[cond_rg_sp,]$CUID[layer_CU]
          trackRecord_nuseds_nocuss$cu_name_pse[r] <-  CUs_gdb[cond_rg_sp,]$cu_name_pse[layer_CU]
          trackRecord_nuseds_nocuss$FULL_CU_IN[r] <-  CUs_gdb[cond_rg_sp,]$FULL_CU_IN[layer_CU]
          
          if(is.na(comment)){
             comment <- "CU found"
          }else{
            
          }
        }
      } # end of if any(cond_rg_sp)
    } # end of if region found
  } # end of if there are coordinates available
  trackRecord_nuseds_nocuss$comment[r] <- comment
}

trackRecord_nuseds_nocuss$comment <- gsub("NA; ","",trackRecord_nuseds_nocuss$comment)
```

Time series without coordinates or intersecting more that one CU boundary are removed from **NUSEDS**. Below we show a plot for each time series followed by the action made:

```{r, echo=FALSE, fig.width=14, fig.height=6}

# BRUNO IS HERE

# all_areas_nuseds_copy <- all_areas_nuseds
# conservation_unit_system_sites_copy <- conservation_unit_system_sites
#
# all_areas_nuseds <- all_areas_nuseds_copy
# conservation_unit_system_sites <- conservation_unit_system_sites_copy

# add species to trackRecord_nuseds_nocuss
trackRecord_nuseds_nocuss$species <- sapply(trackRecord_nuseds_nocuss$IndexId,function(iid){
  if(grepl("CN",iid)){
    out <- "Chinook"
  }else if(grepl("CO",iid)){
    out <- "Coho"
  }else if(grepl("PK",iid)){
    out <- "Pink"
  }else if(grepl("CM",iid)){
    out <- "Chum"
  }else if(grepl("SX",iid)){
    out <- "Sockeye"
  }
  return(out)
})

# combine species and GFE_ID
trackRecord_nuseds_nocuss$species_GFE_ID <- paste(trackRecord_nuseds_nocuss$species,
                                                  trackRecord_nuseds_nocuss$GFE_ID,sep = "_")

CUSS_species_GFE_ID <- paste(conservation_unit_system_sites$SPECIES,
                             conservation_unit_system_sites$GFE_ID,sep = "_")

par(mar=c(4,4,.5,.5))
for(r in 1:nrow(trackRecord_nuseds_nocuss)){
  # r <- 12
  # r <- which(trackRecord_nuseds_nocuss$WATERBODY == "CLAYOQUOT RIVER")
  
  print(paste0("*** r = ",r," ***"))
  
  # check if IndexId is in CUSS
  cond <- conservation_unit_system_sites$IndexId == trackRecord_nuseds_nocuss$IndexId[r]
  if(sum(cond) > 0){
    IndexId_inCuss <- T
  }else{
    IndexId_inCuss <- F
  }
  
  # check if GFE_ID is in CUSS for this species
  cond <- trackRecord_nuseds_nocuss$species_GFE_ID[r] %in% CUSS_species_GFE_ID
    
  if(sum(cond) > 0){
    species_GFE_ID_inCuss <- T
  }else{
    species_GFE_ID_inCuss <- F
  }
  
  plot_IndexId_GFE_ID_fun(IndexIds = trackRecord_nuseds_nocuss$IndexId[r],
                          GFE_IDs = trackRecord_nuseds_nocuss$GFE_ID[r],
                          all_areas_nuseds = all_areas_nuseds)
  legend("bottomleft",paste("i =",r),bty = "n")
  legend("top",c(paste("IndexId is in CUSS:",IndexId_inCuss),
                 paste("SPECIES & GFE_ID is in CUSS:",species_GFE_ID_inCuss)),bty = "n")
  
  cond_gfeid <- all_areas_nuseds$GFE_ID ==  trackRecord_nuseds_nocuss$GFE_ID[r]
  WATERBODY <- all_areas_nuseds$WATERBODY[cond_gfeid] |> unique()
    cond_Population <- all_areas_nuseds$IndexId == trackRecord_nuseds_nocuss$IndexId[r]
  POPULATION <- all_areas_nuseds$POPULATION[cond_Population] |> unique()
  
  legend("topright",c(paste("WATERBODY:",WATERBODY),paste("POPULATION:",POPULATION)),bty = "n")
  
  #
  FULL_CU_IN <- trackRecord_nuseds_nocuss$FULL_CU_IN[r]
  cuid <- trackRecord_nuseds_nocuss$cuid[r]
  
  if(is.na(FULL_CU_IN) & is.na(cuid)){
    comment <- trackRecord_nuseds_nocuss$comment[r]
    print(paste0("The series above is removed from NUSEDS because: ",comment))
    
    removed <- data.frame(IndexId = trackRecord_nuseds_nocuss$IndexId[r],
                          GFE_ID = trackRecord_nuseds_nocuss$GFE_ID[r])
    removed$dataset <- "NUSEDS"
    removed$comment <- "Series not in CUSS, neither IndexId nor GFE_ID are in CUSS"
    removed_all <- rbind(removed_all,removed)

    #
    all_areas_nuseds <- remove_rows_fields_fun(dataframe = all_areas_nuseds,
                                               toRemove = removed,
                                               silience = T,
                                               fields = c("IndexId","GFE_ID"))
  }else{ # add the reference to CUSS
    
      cuss_new <- CUSS_newRow_fun(IndexId = trackRecord_nuseds_nocuss$IndexId[r],
                                  GFE_ID = trackRecord_nuseds_nocuss$GFE_ID[r],
                                  conservation_unit_system_sites = conservation_unit_system_sites,
                                  all_areas_nuseds = all_areas_nuseds)
      
      if(is.na(cuss_new$Y_LAT)){
        cuss_new$Y_LAT <- trackRecord_nuseds_nocuss$Y_LAT[r]
        cuss_new$X_LONGT <- trackRecord_nuseds_nocuss$X_LONGT[r]
        cuss_new$coordinates_changed <- trackRecord_nuseds_nocuss$coordinates_changed[r]
      }
      
      cu_fields <- c("CU_NAME","CU_ACRO","CU_INDEX","FULL_CU_IN","CU_LAT","CU_LONGT",
                     "CU_TYPE","FAZ_ACRO","MAZ_ACRO","JAZ_ACRO")
      
      if(is.na(FULL_CU_IN) | is.na(cuss_new$FULL_CU_IN)){
        # few cases where cuid was found but no FULL_CU_IN was provided
        cond <- conservationunits_decoder$cuid == cuid
        cuss_new$CU_NAME <- conservationunits_decoder$cu_name_dfo[cond]
        
        SPECIES <- conservationunits_decoder$species_name[cond]
        if(SPECIES %in% c("Lake sockeye","River sockeye")){
          SPECIES <- "Sockeye"
        }else if(SPECIES %in% c("Pink (odd)","Pink (even)")){
          SPECIES <- "Pink"
        }
        cuss_new$SPECIES <- SPECIES
        cuss_new$SPECIES_QUALIFIED <- conservationunits_decoder$species_qualified[cond]
        cuss_new$CU_TYPE <- conservationunits_decoder$cu_type[cond]
        FULL_CU_IN <- conservationunits_decoder$cu_index[cond]
        if(is.na(FULL_CU_IN)){
          FULL_CU_IN <- paste0("No FULL_CU_in but cuid = ",cuid) # do not leave NA because this will screw the rest of the interations
        }
        cuss_new$FULL_CU_IN <- FULL_CU_IN
        
      }else{
        
        cond <- conservation_unit_system_sites$FULL_CU_IN == FULL_CU_IN
        cu_fields_info <- unique(conservation_unit_system_sites[cond,cu_fields])

        for(f in colnames(cu_fields_info)){
          val <- cu_fields_info[,f] |> unique()
          
          if(length(val) == 1){    # only if there is one possible value
            cuss_new[,f] <- val
          }
        }
      }
      
      cuss_new$coordinates_changed <- trackRecord_nuseds_nocuss$coordinates_changed[r]
      
      rownames(cuss_new) <- NULL
      
      conservation_unit_system_sites <- rbind(conservation_unit_system_sites,
                                              cuss_new)
    
      toAdd <- data.frame(IndexId = trackRecord_nuseds_nocuss$IndexId[r],
                          GFE_ID = trackRecord_nuseds_nocuss$GFE_ID[r],
                          dataset = "CUSS",
                          CU_NAME = cuss_new$CU_NAME,
                          comment = "No alternative series found but CU found using the PSE's CU shape files")
      
      added_all <- rbind(added_all,toAdd)
      
      print("The time series above is added to CUSS in association with the CU:")
      
      print(cuss_new[,c("IndexId","CU_NAME","FULL_CU_IN","CU_TYPE")])
      
      # print(paste0("IndexId = ",cuss_new$IndexId,"; CU_NAME = ",cuss_new$CU_NAME,"; FULL_CU_IN = ",cuss_new$FULL_CU_IN))

      print("")
  }
}
```

```{r, include=FALSE}
#' ** CHECKS **

# Check - normally all series in NUSEDS and in CUSS now:
series_nuseds <- paste(all_areas_nuseds$IndexId,
                       all_areas_nuseds$GFE_ID,sep = "&")
series_nuseds <- unique(series_nuseds)
length(series_nuseds) # 7094 6953 6952 6947 6917 6911

series_cuss <- paste(conservation_unit_system_sites$IndexId,
                     conservation_unit_system_sites$GFE_ID,sep = "&")
series_cuss <- unique(series_cuss)
length(series_cuss) # 7094 6952 6947 6917 6911

#' Now all the series in CUSS are in all_areas_nuseds.
series_cuss[! series_cuss %in% series_nuseds]

# Number of series in NUSEDS not in CUSS:
series_Nuseds_noCuss <- series_nuseds[! series_nuseds %in% series_cuss]
series_Nuseds_noCuss <- series_Nuseds_noCuss[order(series_Nuseds_noCuss)]
length(series_Nuseds_noCuss) # 0

# all the GFE_ID in CUSS should have coordinates:
cond <- is.na(conservation_unit_system_sites$Y_LAT) | is.na(conservation_unit_system_sites$X_LONGT)
sum(cond) # 0
```

## Fix: coordinates of certain locations in CUSS (optional)

There are multiple locations in **CUSS** that have different `SYSTEM_SITE` and `GFE_ID` but exactly the same geographic coordinates. This is because the coordinates are not defined as the survey location but the "`r fields_def$cu_system_sites$X_LONGT`". There can be large distances between the coordinates in **CUSS** and the real survey locations for large water bodies. We offer the option to update the coordinates of certain locations to avoid overlap.

Decision made:

```{r,echo=FALSE}
if(update_coordinates){
  print("Coordinates for certain locations are updated manually to avoid overlaps.")
  print("We do so using Google Maps and the field 'SYSTEM_SITE'")
}else{
  print("Coordinates for certain locations are not updated so there are overlaps.")
}
```

```{r, include=F}
#' There are multiple locations in conservation_unit_system_sites that have 
#' different names and GFE_ID but exactly the same geographic coordinates. 
#' This causes an issue in the next data processing process when trying to 
#' provide streamid for the PSE.
#' The goal is to estimate the coordinates of the locations by hand using 
#' - google map
#' - https://maps.gov.bc.ca/ess/hm/imap4m

#' TODO: export the file manually once and then import it in future (cf. Population
#' meeting Sep 11 2024)

#' Note: the coordinates do not correspond to the survey location but the mouth
#' or centroid of the water body. But that causes a problem for large rivers.
conservation_unit_system_sites$X_LONGT <- round(as.numeric(conservation_unit_system_sites$X_LONGT),6)
conservation_unit_system_sites$Y_LAT <- round(as.numeric(conservation_unit_system_sites$Y_LAT),6)

# Find the coordinates of all the GFE_IDs
locations <- unique(conservation_unit_system_sites[,c("GFE_ID","X_LONGT","Y_LAT")])
nrow(locations) # 2345 2333

# Get the duplicated coordinates and associated GFE_ID:
cond <- duplicated(locations[,c("X_LONGT","Y_LAT")])
coord_duplicated <- locations[,c("X_LONGT","Y_LAT")][cond,]
nrow(coord_duplicated) # 21

# Return these locations with SYSTEM_SITE
locations_duplicated <- NULL
for(r in 1:nrow(coord_duplicated)){
  cond <- conservation_unit_system_sites$X_LONGT == coord_duplicated[r,"X_LONGT"] &
    conservation_unit_system_sites$Y_LAT == coord_duplicated[r,"Y_LAT"]
  out <- unique(conservation_unit_system_sites[cond,c("SYSTEM_SITE","GFE_ID","Y_LAT","X_LONGT")])
  locations_duplicated <- rbind(locations_duplicated,out)
} 
locations_duplicated <- unique(locations_duplicated)
nrow(locations_duplicated) # 41

# Sort the dataset and group per coordinates (same letter for same coordinates)
locations_duplicated <- locations_duplicated_group_fun(locations_duplicated)
rownames(locations_duplicated) <- NULL
```

There are `r nrow(coord_duplicated)` unique coordinates with multiple `SYSTEM_SITE` and `GFE_ID` (n = `r nrow(locations_duplicated)`). We group locations with identical coordinates and for each of the group (identified with a letter in the table below):

```{r, echo=FALSE}
locations_duplicated[,c("SYSTEM_SITE","GFE_ID","Y_LAT","X_LONGT","group")]
```

```{r, echo = F}
if(update_coordinates){
  print(paste0("For group ",LETTERS[1],":"))
  # Fill the coordinate appropriately in each case:
  i <- 1
  letter <- unique(locations_duplicated$group)[i]
  cond <- locations_duplicated$group == letter
  i_toChange <- 2
  X_Y <- c(51.344756,-119.797289)
  locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
  locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
  show <- locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
  rownames(show) <- NULL
  show
}
# 2746	FENNELL CREEK AND SASKUM CREEK
# 261	FENNELL CREEK
```

```{r, echo=F}
i <- i + 1 # 2
if(update_coordinates){
  print(paste0("For group ",LETTERS[i],":"))
  letter <- unique(locations_duplicated$group)[i]
  cond <- locations_duplicated$group == letter
  i_toChange <- 2
  # not sure where the channel so I picked a location a little bit above the creek mouth
  X_Y <- c(49.090741,-121.531078)  
  locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
  locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
  show <- locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
  rownames(show) <- NULL
  show
}
# 82	CENTRE CREEK
# 2533	CENTRE CHANNEL
```

```{r, echo=F}
i <- i + 1 # 3
if(update_coordinates){
  print(paste0("For group ",LETTERS[i],":"))
  letter <- unique(locations_duplicated$group)[i]
  cond <- locations_duplicated$group == letter
  i_toChange <- 1
  X_Y <- c(49.107077, -121.636804)  #
  locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
  locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
  show <- locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
  rownames(show) <- NULL
  show
}
# 78	FOLEY CREEK
# 381	FOLEY CREEK SIDE CHANNEL
```

```{r, echo=F}
i <- i + 1 # 4
if(update_coordinates){
  print(paste0("For group ",LETTERS[i],":"))
  letter <- unique(locations_duplicated$group)[i]
  cond <- locations_duplicated$group == letter
  i_toChange <- 2
  # could not check if the creek is called Hawkins
  X_Y <- c(49.169178, -122.191740)  
  locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
  locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
  show <- locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
  rownames(show) <- NULL
  show
}
# 51	NORRISH CREEK
# 54	HAWKINS CREEK
```

```{r, echo=F}
i <- i + 1 # 5
if(update_coordinates){
  print(paste0("For group ",LETTERS[i],":"))
  letter <- unique(locations_duplicated$group)[i]
  cond <- locations_duplicated$group == letter
  i_toChange <- 2
  # could not found the beach so I picked a location just beside it
  X_Y <- c(52.720154, -120.867586)  
  locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
  locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
  i_toChange <- 3
  # could not found the beach so I picked a location just beside it
  X_Y <- c(52.746393, -120.837075) 
  locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
  locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
  show <- locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
  rownames(show) <- NULL
  show
}
# 11513	BAXTER BEACH
# 11514	BEAR BEACH - SHORE
# 11515	BETTY FRANK'S - SHORE
```

```{r, include=F}
cond <- conservation_unit_system_sites$SYSTEM_SITE == "BAXTER BEACH"
cond <- conservation_unit_system_sites$SYSTEM_SITE == "BEAR BEACH - SHORE"
cond <- conservation_unit_system_sites$SYSTEM_SITE == "BETTY FRANK'S - SHORE"
cond <- conservation_unit_system_sites$SYSTEM_SITE %in% c("BAXTER BEACH",
                                                          "BEAR BEACH - SHORE",
                                                          "BETTY FRANK'S - SHORE")
conservation_unit_system_sites[cond,]
```

```{r, echo=F}
i <- i + 1 # 6
if(update_coordinates){
  print(paste0("For group ",LETTERS[i],":"))
  letter <- unique(locations_duplicated$group)[i]
  cond <- locations_duplicated$group == letter
  i_toChange <- 2
  X_Y <- c(49.740213, -122.147390)  # 
  locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
  locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
  show <- locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
  rownames(show) <- NULL
  show
}
# 177	LILLOOET RIVER - LOWER
# 2475	LILLOOET RIVER
```

```{r, include=F}
cond <- conservation_unit_system_sites$SYSTEM_SITE == "LILLOOET RIVER"
conservation_unit_system_sites[cond,]
```

```{r, echo=F}
i <- i + 1 # 7
if(update_coordinates){
  print(paste0("For group ",LETTERS[i],":"))
  letter <- unique(locations_duplicated$group)[i]
  cond <- locations_duplicated$group == letter
  i_toChange <- 1
  # moved to CAYOOSH CREEK's mouth
  X_Y <- c(50.680016, -121.929476) 
  locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
  locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
  show <- locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
  rownames(show) <- NULL
  show
}
# 131	CAYOOSH CREEK
# 7990579	SETON AND CAYOOSH CREEKS
```

```{r, echo=F}
i <- i + 1 # 8
if(update_coordinates){
  print(paste0("For group ",LETTERS[i],":"))
  letter <- unique(locations_duplicated$group)[i]
  cond <- locations_duplicated$group == letter
  i_toChange <- 2
  # moved north a little bit
  X_Y <- c(49.626847, -122.671116) 
  locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
  locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
  show <- locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
  rownames(show) <- NULL
  show
}
# 24	BOISE CREEK
# 26776	BOISE CREEK - NORTH
```

```{r, echo=F}
i <- i + 1 # 9
if(update_coordinates){
  print(paste0("For group ",LETTERS[i],":"))
  letter <- unique(locations_duplicated$group)[i]
  cond <- locations_duplicated$group == letter
  i_toChange <- 2
  X_Y <- c(49.111242, -123.168505)  # just besid it 
  locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
  locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
  show <- locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
  rownames(show) <- NULL
  show
}
# 1	FRASER RIVER
# 7990634	FRASER RIVER AND TRIBUTARIES
```

```{r, echo=F}
i <- i + 1 # 10
if(update_coordinates){
  print(paste0("For group ",LETTERS[i],":"))
  letter <- unique(locations_duplicated$group)[i]
  cond <- locations_duplicated$group == letter
  i_toChange <- 2
  X_Y <- c(51.745035, -122.413504)  # just above it 
  locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
  locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
  show <- locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
  rownames(show) <- NULL
  show
}
# 2463	CHILCOTIN RIVER - LOWER
# 285	CHILCOTIN RIVER
```

```{r, echo=F}
i <- i + 1 # 11
if(update_coordinates){
  print(paste0("For group ",LETTERS[i],":"))
  letter <- unique(locations_duplicated$group)[i]
  cond <- locations_duplicated$group == letter
  i_toChange <- 2
  # moved to the cross between the two rivers
  X_Y <- c(49.294603, -124.879074)  
  locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
  locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
  show <- locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
  rownames(show) <- NULL
  show
}
# 1261	SOMASS RIVER
# 11485	SOMASS-SPROAT-GC SYSTEM
```

```{r, echo=F}
i <- i + 1 # 12
if(update_coordinates){
  print(paste0("For group ",LETTERS[i],":"))
  letter <- unique(locations_duplicated$group)[i]
  cond <- locations_duplicated$group == letter
  i_toChange <- 2
  X_Y <- c(49.201198, -125.512450)  # placed it above
  locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
  locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
  show <- locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
  rownames(show) <- NULL
  show
}
# 1310	CLAYOQUOT RIVER - LOWER
# 2487	CLAYOQUOT RIVER
```

```{r, echo=F}
i <- i + 1 # 13
if(update_coordinates){
  print(paste0("For group ",LETTERS[i],":"))
  letter <- unique(locations_duplicated$group)[i]
  cond <- locations_duplicated$group == letter
  i_toChange <- 1
  X_Y <- c(54.445124, -125.458809)  # moved above the weir
  locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
  locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
  show <- locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
  rownames(show) <- NULL
  show
}
# 501255	PINKUT CREEK
# 2115	PINKUT CREEK - BELOW WEIR
```

```{r, echo=F}
i <- i + 1 # 14
if(update_coordinates){
  print(paste0("For group ",LETTERS[i],":"))
  letter <- unique(locations_duplicated$group)[i]
  cond <- locations_duplicated$group == letter
  i_toChange <- 1
  X_Y <- c(52.378979, -126.581766)  # no idea where these two creeks are exactly
  locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
  locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
  show <- locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
  rownames(show) <- NULL
  show
}
# 2678	FORESTRY CREEK
# 2680	MARTY'S CREEK
```

```{r, include=F}
cond <- conservation_unit_system_sites$SYSTEM_SITE == "BETTY FRANK'S - SHORE"
cond <- conservation_unit_system_sites$SYSTEM_SITE %in% c("FORESTRY CREEK",
                                                          "MARTY'S CREEK")
conservation_unit_system_sites[cond,]
```

```{r, echo=F}
i <- i + 1 # 15
if(update_coordinates){
  print(paste0("For group ",LETTERS[i],":"))
  letter <- unique(locations_duplicated$group)[i]
  cond <- locations_duplicated$group == letter
  i_toChange <- 2
  X_Y <- c(50.342682, -127.437795)  # I don't know what is the difference between "creek" and "system"
  locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
  locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
  show <- locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
  rownames(show) <- NULL
  show
}
# 1450	CAYEGHLE CREEK
# 2302	CAYEGHLE SYSTEM
```

```{r, echo=F}
i <- i + 1 # 16
if(update_coordinates){
  print(paste0("For group ",LETTERS[i],":"))
  letter <- unique(locations_duplicated$group)[i]
  cond <- locations_duplicated$group == letter
  i_toChange <- 2
  X_Y <- c(55.081340, -125.560056)  # 
  locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
  locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
  show <- locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
  rownames(show) <- NULL
  show
}
# 2439	TAKLA LAKE
# 19719	TAKLA - SHORE
```

```{r, echo=F}
i <- i + 1 # 17
if(update_coordinates){
  print(paste0("For group ",LETTERS[i],":"))
  letter <- unique(locations_duplicated$group)[i]
  cond <- locations_duplicated$group == letter
  i_toChange <- 2
  X_Y <- c(54.816010, -126.163338)  # 
  locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
  locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
  show <- locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
  rownames(show) <- NULL
  show
}
# 501254	FULTON RIVER
# 2111	FULTON RIVER - BELOW WEIR
```

```{r, echo=F}
i <- i + 1 # 18
if(update_coordinates){
  print(paste0("For group ",LETTERS[i],":"))
  letter <- unique(locations_duplicated$group)[i]
  cond <- locations_duplicated$group == letter
  i_toChange <- 1
  X_Y <- c(52.225501, -127.598108)  # moved it just a little nord
  locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
  locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
  show <- locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
  rownames(show) <- NULL
  show
}
# 1798	JENNY BAY CREEKS
# 2693	JENNY BAY SOUTH CREEK
```

```{r, echo=F}
i <- i + 1 # 19
if(update_coordinates){
  print(paste0("For group ",LETTERS[i],":"))
  letter <- unique(locations_duplicated$group)[i]
  cond <- locations_duplicated$group == letter
  i_toChange <- 1
  X_Y <- c(52.044541, -128.068576)  # 
  locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
  locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
  show <- locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
  rownames(show) <- NULL
  show
}
# 2687	FANNIE COVE LEFT HAND CREEK
# 2708	FANNIE COVE RIGHT HAND CREEK
```

```{r, echo=F}
i <- i + 1 # 20
if(update_coordinates){
  print(paste0("For group ",LETTERS[i],":"))
  letter <- unique(locations_duplicated$group)[i]
  cond <- locations_duplicated$group == letter
  i_toChange <- 1
  X_Y <- c(52.877146, -132.000700)  # 
  locations_duplicated$Y_LAT_new[cond][i_toChange] <- X_Y[1]
  locations_duplicated$X_LONGT_new[cond][i_toChange] <- X_Y[2]
  show <- locations_duplicated[cond,c("GFE_ID","SYSTEM_SITE","Y_LAT","X_LONGT","Y_LAT_new","X_LONGT_new")]
  rownames(show) <- NULL
  show
}
# 1594	SEWELL INLET CREEK L.H. #2
# 1595	THORSEN CREEK
```

The fields `X_LONGT` and `Y_LAT` are updated in **CUSS**, and the new field `coordinates_changed` is added to indicate which locations are concerned.

```{r,echo=FALSE}
if(update_coordinates){
  print("The fields 'X_LONGT' and 'Y_LAT' are updated in CUSS, and the new field 'coordinates_changed' is added to indicate which locations are concerned.")
}
```

```{r, include=F}
# Replace these values in CUSS
# conservation_unit_system_sites$coordinates_changed <- F

for(l in unique(locations_duplicated$group)){
  # l <- unique(locations_duplicated$group)[1]
  cond_l <- locations_duplicated$group == l & !is.na(locations_duplicated$Y_LAT_new)
  GFE_ID <- locations_duplicated$GFE_ID[cond_l]
  SYSTEM_SITE <- locations_duplicated$SYSTEM_SITE[cond_l]
  Y_LAT_new <- locations_duplicated$Y_LAT_new[cond_l]
  X_LONGT_new <- locations_duplicated$X_LONGT_new[cond_l]
  
  for(i in 1:length(GFE_ID)){
    cond_cuss <- conservation_unit_system_sites$GFE_ID == GFE_ID[i] & 
      conservation_unit_system_sites$SYSTEM_SITE == SYSTEM_SITE[i]
    
    conservation_unit_system_sites$Y_LAT[cond_cuss] <- Y_LAT_new[i]
    conservation_unit_system_sites$X_LONGT[cond_cuss] <- X_LONGT_new[i]
    conservation_unit_system_sites$coordinates_changed[cond_cuss] <- T
  }
}

locations <- unique(conservation_unit_system_sites [,c("GFE_ID","X_LONGT","Y_LAT")])
nrow(locations) # 2361
```

```{r}
# check is there still are different GFE_IDs with same coordinates:
coord_duplicated <- locations[,c("X_LONGT","Y_LAT")][duplicated(locations[,c("X_LONGT","Y_LAT")]),]
nrow(coord_duplicated) # 0
```

# Merge NUSEDS and CUSS

At this stage **NUSEDS** and **CUSS** have the same `r length(series_cuss)` time series and can consequently be merged using the common fields `IndexId` (i.e., `POP_ID`) and `GFE_ID`.

```{r, include=FALSE}
# there is one duplicated row in conservation_unit_system_sites, not sure why

dupli <- duplicated(conservation_unit_system_sites)
conservation_unit_system_sites[dupli,]  # 
conservation_unit_system_sites <- conservation_unit_system_sites[!dupli,]
```


```{r}
col_common <- c("IndexId","POP_ID","GFE_ID")

col_nuseds <- c("SPECIES","POPULATION","WATERBODY","AREA","Year","MAX_ESTIMATE",
                "ENUMERATION_METHODS",            # 
                "ESTIMATE_CLASSIFICATION",
                "ESTIMATE_METHOD",
                "GAZETTED_NAME",
                "LOCAL_NAME_1",
                "LOCAL_NAME_2",
                "ADULT_PRESENCE",
                "JACK_PRESENCE")

col_cuss <- c("SPECIES_QUALIFIED","CU_NAME","CU_TYPE","FAZ_ACRO","JAZ_ACRO","MAZ_ACRO",
              "FULL_CU_IN","SYSTEM_SITE","Y_LAT","X_LONGT","IS_INDICATOR",
              "CU_LAT","CU_LONGT","coordinates_changed")

nuseds_final <- base::merge(x = all_areas_nuseds[,c(col_common,col_nuseds)], 
                            y = conservation_unit_system_sites[,c(col_common,col_cuss)], 
                            by = col_common, 
                            all.x = T)
```

```{r, include=FALSE}
nrow(nuseds_final)     # 312930 311957 310644 310644 310538 309727 307217
nrow(all_areas_nuseds) # 312930 311957 310644 310644 310538 309727 307217
nrow(conservation_unit_system_sites) # 7094 7036 6955
```

# Additional fixes

## Replace zeros by NAs (optional)

```{r, include=FALSE}
cond <- nuseds_final$MAX_ESTIMATE == 0 & !is.na(nuseds_final$MAX_ESTIMATE)
nb_cases <- sum(cond) # 3453
prop_cases <- sum(cond)/nrow(nuseds_final) * 100
```

So far we have not been able to determine which zeros are actual 0s and those which should be NAs. We consequently implemented the option to replace all 0s by NAs (`r paste0("n = ",nb_cases)`, or `r paste0(round(prop_cases,2),"%")` of the data points).

Decision made:

```{r, echo=FALSE}
if(replace_zeros_byNAs){
  nuseds_final$MAX_ESTIMATE[cond] <- NA
  print("Zeros are replaced by NAs.")
}else{
  print("Zeros are NOT replaced by NAs.")
}
```

## Multiple series of same CU in one location

There are many cases where a CU in a given location (i.e., a unique `GFE_ID`) is associated to multiple series (i.e. `IndexId`/`POP_ID`), which should not happen. Observing these cases reveals clear duplicated data points or single data point that are not worth keeping. To fix these issues we proceed as follow:

-   **Case 1**: one of the duplicated series has only one data point:

    -   if it is complementary: merge to the other (longer) series

    -   if it is in conflict or a duplicate: remove the focal series

-   **Case 2**: the shorter series is 100% duplicated: removed the focal series

-   **Case 3**: for the rest of the duplicated series,

    -   points that are conflictual or duplicated are summed up

    -   points that are complementary are merged

By summing data points in a few cases, we assume that the different runs (e.g., "Chinook Run 1" and "Chinook Run 2") can be considered a single population. For example, the Bridge River has Summer and Late run sockeye surveys, but these are both in the MIDDLE FRASER river-type sockeye CU and are summed to yield the Bridge River survey for that CU in the PSE.

The figures below show the time series before and after correction with the action made (i.e., "MERGED", "DELETED", "SUMMED") indicated.

There are a few instances where a special fix is done, as indicated below in the corresponding figures.

In the few instances where data points are summed, we define the `ESTIMATE_CLASSIFICATION` (e.g., "RELATIVE ABUNDANCE (TYPE-3)") as the value corresponding to the highest `MAX_ESTIMATE` value between the two data points. In these cases, a table follows the figure and show the data points that are summed with their corresponding `Year` and `ESTIMATE_CLASSIFICATION`.

```{r, echo=FALSE, fig.width=15, fig.height=15}

# removed_all_copy <- removed_all
# nuseds_final_copy <- nuseds_final

# removed_all <- removed_all_copy
# nuseds_final <- nuseds_final_copy

# Short cut for trouble shooting
# write.csv(all_areas_nuseds,paste0(wd_data,"/all_areas_nuseds_TEMP.csv"), row.names = F)
# write.csv(conservation_unit_system_sites,paste0(wd_data,"/conservation_unit_system_sites_TEMP.csv"), row.names = F)
# write.csv(removed_all,paste0(wd_data,"/removed_all_TEMP.csv"), row.names = F)
# write.csv(added_all,paste0(wd_data,"/added_all_TEMP.csv"), row.names = F)
# write.csv(nuseds_final,paste0(wd_data,"/nuseds_final_TEMP.csv"), row.names = F)

# all_areas_nuseds <- read.csv(paste0(wd_data,"/all_areas_nuseds_TEMP.csv"), header = T)
# conservation_unit_system_sites <- read.csv(paste0(wd_data,"/conservation_unit_system_sites_TEMP.csv"), header = T)
# removed_all <- read.csv(paste0(wd_data,"/removed_all_TEMP.csv"), header = T)
# added_all <- read.csv(paste0(wd_data,"/added_all_TEMP.csv"), header = T)
# nuseds_final <- read.csv(paste0(wd_data,"/nuseds_final_TEMP.csv"), header = T)

# create a new removed_all to ???
removed_all_new <- removed_all[NULL,]

#' obtain the list of fields in NuSEDS and CUSS that are related to (1) IndexID 
#' (POP_ID) and/or GFE_ID and those that are independent, 
#' This is used to ???
fields_l <- fields_IndexId_GFE_ID_fun(all_areas_nuseds = all_areas_nuseds,
                                      conservation_unit_system_sites = conservation_unit_system_sites)

# Return the fields in both NUSEDS and CUSS that are related to IndexId (= POP_ID)
fields_IndexId <- unique(c(fields_l$NUSEDS$IndexId,fields_l$CUSS$IndexId))
fields_IndexId <- fields_IndexId[fields_IndexId %in% colnames(nuseds_final)]

nuseds_CU_GFI_ID <- unique(nuseds_final[,c("SPECIES_QUALIFIED","CU_NAME","FULL_CU_IN","GFE_ID")])
cond_NA <- is.na(nuseds_CU_GFI_ID$CU_NAME)
nuseds_CU_GFI_ID <- nuseds_CU_GFI_ID[!cond_NA,]
# nrow(nuseds_CU_GFI_ID) # 6865 6848

#' The loop below shows the time series before and after the correction.
#' The procedure consists in looking in each cases where for a given CU (i.e. 
#' unique CU_NAME and SPECIES_QUALIFIED) and location (i.e GFE_ID) if there are 
#' multiple IndexId (= POP_ID).
count <- 1
layout(matrix(1:2,nrow = 2))
par(mar = c(4,4.5,3.5,.5))
for(r in 1:nrow(nuseds_CU_GFI_ID)){
  # r <- 1 # case one
  # r <- 1410 # case 2
  # r <- 966 # case 3
  # r <- 1124 # "correct_exception" with  IndexId_focal == "CM_50537" & GFE_ID_here == 816
  # r <- 1422 #  "Case 3 - CN_2483 & GFE_ID_here == 142": there are three time series 
  # r <-  # "delete_exception" with  IndexId_focal == "CN_50619" & GFE_ID_here == 824
  # r <- which(nuseds_CU_GFI_ID$GFE_ID == 800 & 
  #            nuseds_CU_GFI_ID$CU_NAME == "GEORGIA STRAIT" & 
  #            nuseds_CU_GFI_ID$SPECIES_QUALIFIED == "CM")
  # r <- 1432
  # r <- which(nuseds_CU_GFI_ID$GFE_ID == 142 &
  #            nuseds_CU_GFI_ID$CU_NAME == "MIDDLE FRASER RIVER_SP_1.3" &
  #            nuseds_CU_GFI_ID$SPECIES_QUALIFIED == "CK")

  CU_NAME_here <- nuseds_CU_GFI_ID$CU_NAME[r]
  GFE_ID_here <- nuseds_CU_GFI_ID$GFE_ID[r]
  SPECIES_QUALIFIED_here <- nuseds_CU_GFI_ID$SPECIES_QUALIFIED[r]
  
  cond_nuseds <- nuseds_final$CU_NAME == CU_NAME_here &
    !is.na( nuseds_final$CU_NAME) &
    nuseds_final$GFE_ID == GFE_ID_here &
    nuseds_final$SPECIES_QUALIFIED == SPECIES_QUALIFIED_here
  
  IndexId_here <- unique(nuseds_final$IndexId[cond_nuseds])
  POPULATION_here <- unique(nuseds_final$POPULATION[cond_nuseds])
  
  if(length(IndexId_here) > 1){
    
    plot_IndexId_GFE_ID_fun(IndexIds = IndexId_here,
                            GFE_IDs = rep(GFE_ID_here,length(IndexId_here)),
                            all_areas_nuseds = nuseds_final, 
                            main = "")
    # legend("top",legend = c("CU_NAME",CU_NAME_here),bty = 'n')
    legend("top",legend = POPULATION_here,bty = 'n')
    legend("bottomleft",legend = c(paste0("count = ",count),
                                 paste0("r = ",r)),bty = 'n')
    
    mtext(text = paste("CU_NAME:",CU_NAME_here), side = 3, line = 1,adj = 0)
    mtext(text ="BEFORE", side = 3, line = 1,adj = 1, cex = 1.2, font = 2)
    
    # select the two time series:
    cond_nuseds_1 <- cond_nuseds & nuseds_final$IndexId == IndexId_here[1]
    cond_nuseds_2 <- cond_nuseds & nuseds_final$IndexId == IndexId_here[2]
    series_1 <- nuseds_final$MAX_ESTIMATE[cond_nuseds_1]
    names(series_1) <- nuseds_final$Year[cond_nuseds_1]
    series_2 <- nuseds_final$MAX_ESTIMATE[cond_nuseds_2]
    names(series_2) <- nuseds_final$Year[cond_nuseds_2]
    
    # the focal series should be the shortest one
    if(length(series_1) > length(series_2)){  # suggestion: only count the non NA values?
      IndexId_focal <- IndexId_here[2]
      IndexId_compare <- IndexId_here[1]
      series_focal <- series_2
      series_compare <- series_1
      cond_focal <- cond_nuseds_2
      cond_compare <- cond_nuseds_1
    }else{
      IndexId_focal <- IndexId_here[1]
      IndexId_compare <- IndexId_here[2]
      series_focal <- series_1
      series_compare <- series_2
      cond_focal <- cond_nuseds_1
      cond_compare <- cond_nuseds_2
    }
    
    comparison <- compare_series_fun(series_focal = series_focal,
                                     series_compare = series_compare)
    
    # series_compare[order(as.numeric(names(series_compare)))]
    
    # some extra cases spotted by eye
    delete_exception1 <- IndexId_focal == "CN_50619" & GFE_ID_here == 824 # here one data point is a duplicate, the other one almost is
    delete_exception2 <- IndexId_focal == "CN_275" & GFE_ID_here == 220 # here one data point is a duplicate, the other one almost is
    correct_exception <- IndexId_focal == "CM_50537" & GFE_ID_here == 816
    
#' - Case 1: if one data point
#'    - if complementary --> merge to longer series
#'    - if conflict or duplicate --> remove
    if(comparison$nb_dataPt == 1){
      
      # merge the focal series to series_compare
      if(comparison$complementary == 1){
        
        removed <- data.frame(IndexId = IndexId_focal,
                              GFE_ID = GFE_ID_here)
        removed$dataset <- "nuseds_final"
        removed$comment <- paste0("The one data point was merged to series ",
                                  IndexId_compare," & GFE_ID = ",GFE_ID_here,
                                  " as it is the same CU: ",CU_NAME_here)
        removed_all_new <- rbind(removed_all_new,removed)
        
        # 1st edit IndexId related fields in nuseds_final
        # 2nd remove the row with only NA
        cond_focal_NA <- cond_focal & is.na(nuseds_final$MAX_ESTIMATE)
        cond_focal_NAno <-  cond_focal & !is.na(nuseds_final$MAX_ESTIMATE)
        for(f in fields_IndexId){
          # f <- fields_IndexId[1]
          nuseds_final[cond_focal_NAno,f] <- unique(nuseds_final[cond_compare,f])
        }
        nuseds_final <- nuseds_final[!cond_focal_NA,]
        
        plot_IndexId_GFE_ID_fun(IndexIds = IndexId_here,
                                GFE_IDs = rep(GFE_ID_here,length(IndexId_here)),
                                all_areas_nuseds = nuseds_final, 
                                main = "")
        
        legend("topright",legend = "MERGED",bty = 'n')
        legend("top",legend = POPULATION_here,bty = 'n')
        mtext(text ="AFTER", side = 3, line = 1,adj = 1, cex = 1.2, font = 2)
        mtext(text = paste("CU_NAME:",CU_NAME_here), side = 3, line = 1,adj = 0)
        

      }else{ # discard it
        
        nuseds_final <- nuseds_final[!cond_focal,]
        
        removed <- data.frame(IndexId = IndexId_focal,
                              GFE_ID = GFE_ID_here)
        removed$dataset <- "nuseds_final"
        removed$comment <- paste0("The series had only one point in confict or duplicating the series ",
                                  IndexId_compare," & GFE_ID = ",GFE_ID_here,
                                  " of the same CU: ",CU_NAME_here)
        removed_all_new <- rbind(removed_all_new,removed)
        
        plot_IndexId_GFE_ID_fun(IndexIds = IndexId_here,
                                GFE_IDs = rep(GFE_ID_here,length(IndexId_here)),
                                all_areas_nuseds = nuseds_final,main = "")
        mtext(text ="AFTER", side = 3, line = 1,adj = 1, cex = 1.2, font = 2)
        mtext(text = paste("CU_NAME:",CU_NAME_here), side = 3, line = 1,adj = 0)
        legend("topright",legend = "DELETED",bty = 'n')
        legend("top",legend = POPULATION_here,bty = 'n')
        
      }
      
#' - Case 2: the shorter series is 100% duplicated --> removed
    }else if(comparison$nb_dataPt == comparison$duplicate | delete_exception1 | delete_exception2){
      
      nuseds_final <- nuseds_final[!cond_focal,]
      
      removed <- data.frame(IndexId = IndexId_focal,
                            GFE_ID = GFE_ID_here)
      removed$dataset <- "nuseds_final"
      removed$comment <- paste0("The series was duplicating the series ",
                                IndexId_compare," & GFE_ID = ",GFE_ID_here,
                                " of the same CU: ",CU_NAME_here)
      removed_all_new <- rbind(removed_all_new,removed)
      
      
      plot_IndexId_GFE_ID_fun(IndexIds = IndexId_here,
                              GFE_IDs = rep(GFE_ID_here,length(IndexId_here)),
                              all_areas_nuseds = nuseds_final,main = "")
      mtext(text ="AFTER", side = 3, line = 1,adj = 1, cex = 1.2, font = 2)
      mtext(text = paste("CU_NAME:",CU_NAME_here), side = 3, line = 1,adj = 0)
      legend("topright",legend = "DELETED",bty = 'n')
      legend("top",legend = POPULATION_here,bty = 'n')

      
      if(delete_exception1){
        print("Special fix (above): the two blue points are deleted; one is a duplicate, there other one is very close to be one.")
        
      }else if(delete_exception2){
        
        print("Special fix (above): the two red points are deleted; one is a duplicate, there other one has 'UNKNOWN' ESTIMATE_CLASSIFICATION:")
        
        # show the difference in ESTIMATE_CLASSIFICATION when summing data points
        d_focal <- nuseds_final[cond_focal,c("IndexId","GFE_ID","Year","MAX_ESTIMATE","ESTIMATE_CLASSIFICATION")]
        d_compare <- nuseds_final[cond_compare,c("IndexId","GFE_ID","Year","MAX_ESTIMATE","ESTIMATE_CLASSIFICATION")]
          
        show <- base::merge(x = d_focal,y = d_compare, by = c("GFE_ID","Year"), all = T)
        show <- show[order(show$Year),]
        show <- show[!is.na(show$MAX_ESTIMATE.x),]
          
        cond <- grepl("\\.x",colnames(show))
        colnames(show)[cond] <- gsub("\\.x","_s1",colnames(show)[cond])
        cond <- grepl("\\.y",colnames(show))
        colnames(show)[cond] <- gsub("\\.y","_s2",colnames(show)[cond])
        rownames(show) <- NULL
          
        show <- show[!is.na(show$MAX_ESTIMATE_s1),]
        show <- show[!is.na(show$MAX_ESTIMATE_s2),]
        print(show)
      }
      
    }else if(correct_exception){
      
      # show the difference in ESTIMATE_CLASSIFICATION when summing data points
      d_focal <- nuseds_final[cond_focal,c("IndexId","GFE_ID","Year","MAX_ESTIMATE","ESTIMATE_CLASSIFICATION")]
      d_compare <- nuseds_final[cond_compare,c("IndexId","GFE_ID","Year","MAX_ESTIMATE","ESTIMATE_CLASSIFICATION")]
        
      show <- base::merge(x = d_focal,y = d_compare, by = c("GFE_ID","Year"), all = T)
      show <- show[order(show$Year),]
      show <- show[!is.na(show$MAX_ESTIMATE.x),]
        
      cond <- grepl("\\.x",colnames(show))
      colnames(show)[cond] <- gsub("\\.x","_s1",colnames(show)[cond])
      cond <- grepl("\\.y",colnames(show))
      colnames(show)[cond] <- gsub("\\.y","_s2",colnames(show)[cond])
      rownames(show) <- NULL
        
      show <- show[!is.na(show$MAX_ESTIMATE_s1),]
      show <- show[!is.na(show$MAX_ESTIMATE_s2),]
      
      # 1st find the 9 data points that are duplicated with series_compare
      # return the years with matching abundances
      years_toRemove <- c()
      for(i in 1:length(series_focal)){
        # i <- 1
        yr_here <- names(series_focal)[i]
        val_compare <- series_compare[as.character(yr_here)]
        if(!is.na(val_compare) & !is.na(series_focal[i])){
          if(series_focal[i] == val_compare){
            years_toRemove <- c(years_toRemove,yr_here)
          }
        }
      }
      years_toRemove <- as.numeric(years_toRemove)
      years_toRemove <- years_toRemove[years_toRemove < 1960] # there is one duplicated points for later years but it looks legit
      
      # edit show
      show <- show[!show$Year %in% years_toRemove,]
      
      cond_focal_YrtoRemove <- cond_focal & nuseds_final$Year %in% years_toRemove
      
      # 2nd merge the rest of the series by summing the data
      # change the field in the focal series
      for(f in fields_IndexId){
        # f <- fields_IndexId[1]
        nuseds_final[cond_focal,f] <- unique(nuseds_final[cond_compare,f])
      }
      # sum MAX_ESTIMATE in duplicated year
      cond_sum <- (cond_focal & !cond_focal_YrtoRemove) | cond_compare
      
      # to check the ESTIMATE_CLASSIFICATION
      # d_focal <- nuseds_final[cond_focal & !cond_focal_YrtoRemove,c("IndexId","GFE_ID","Year","MAX_ESTIMATE","ESTIMATE_CLASSIFICATION")]
      # d_compare <- nuseds_final[cond_compare,c("IndexId","GFE_ID","Year","MAX_ESTIMATE","ESTIMATE_CLASSIFICATION")]
      # 
      # show <- base::merge(x = d_focal,y = d_compare, by = c("GFE_ID","Year"), all = T)
      # show <- show[order(show$Year),]
      # show <- show[!is.na(show$MAX_ESTIMATE.x),]
      # View(show)
      
      yr_duplicated <- nuseds_final[cond_sum,]$Year[duplicated(nuseds_final[cond_sum,]$Year)]
      for(yr in yr_duplicated){
        # yr <- yr_duplicated[1]
        cond_here <- (cond_focal | cond_compare) & nuseds_final$Year == yr
        vals <- nuseds_final$MAX_ESTIMATE[cond_here]
        if(any(!is.na(vals))){
          val <- sum(vals,na.rm = T)
          nuseds_final$MAX_ESTIMATE[cond_here] <- val
          
          # if indeed counts were added up (i.e. not just one value)
          if(sum(!is.na(vals)) > 1){
              
            # SUMMED <- T not used in this unique case
            
            # define ESTIMATE_CLASSIFICATION: select the value corresponding to the higher MAX_ESTIMATE
            val <- ESTIMATE_CLASSIFICATIONs[vals == max(vals, na.rm = T)]
            nuseds_final$ESTIMATE_CLASSIFICATION[cond_here] <- val
          }
        }
      }
      
      # 3rd remove the row with duplicated data from 1st step and the rows with 
      # duplicated years in the focal from 2nd step
      cond_toDelete <- cond_focal_YrtoRemove | (cond_focal & nuseds_final$Year %in% yr_duplicated)
      nuseds_final <- nuseds_final[!cond_toDelete,]
      
      removed <- data.frame(IndexId = IndexId_focal,
                            GFE_ID = GFE_ID_here)
      removed$dataset <- "nuseds_final"
      removed$comment <- paste0("We removed the duplicated data points and merged by summing the rest of them to series ",
                                IndexId_compare," & GFE_ID = ",GFE_ID_here,
                                " of the same CU: ",CU_NAME_here)
      removed_all_new <- rbind(removed_all_new,removed)
      
      plot_IndexId_GFE_ID_fun(IndexIds = IndexId_here,
                              GFE_IDs = rep(GFE_ID_here,length(IndexId_here)),
                              all_areas_nuseds = nuseds_final,main = "")
      legend("topright",legend = "DELETED & SUMMED & MERGED",bty = 'n')
      mtext(text ="AFTER", side = 3, line = 1,adj = 1, cex = 1.2, font = 2)
      mtext(text = paste("CU_NAME:",CU_NAME_here), side = 3, line = 1,adj = 0)
      legend("top",legend = POPULATION_here,bty = 'n')

      
      if(correct_exception){
        print("Special fix (above): the blue points before 1950 are deleted, the other ones are summed to the red series.")
      }
      
      # pring show
      print("Below is MAX_ESTIMATE and ESTIMATE_CLASSIFICATION for the data points summed:")
      print(show)
      
#' - Case 3: on the rest of the series, 
#'    - points that are conflictual or duplicated are added
#'    - points that are complementary are merged
    }else{
      
      # show the difference in ESTIMATE_CLASSIFICATION when summing
      d_focal <- nuseds_final[cond_focal,c("IndexId","GFE_ID","Year","MAX_ESTIMATE","ESTIMATE_CLASSIFICATION")]
      d_compare <- nuseds_final[cond_compare,c("IndexId","GFE_ID","Year","MAX_ESTIMATE","ESTIMATE_CLASSIFICATION")]
        
      show <- base::merge(x = d_focal,y = d_compare, by = c("GFE_ID","Year"), all = T)
      show <- show[order(show$Year),]
      show <- show[!is.na(show$MAX_ESTIMATE.x),]
        
      cond <- grepl("\\.x",colnames(show))
      colnames(show)[cond] <- gsub("\\.x","_s1",colnames(show)[cond])
      cond <- grepl("\\.y",colnames(show))
      colnames(show)[cond] <- gsub("\\.y","_s2",colnames(show)[cond])
      rownames(show) <- NULL
      
      show <- show[!is.na(show$MAX_ESTIMATE_s1),]
      show <- show[!is.na(show$MAX_ESTIMATE_s2),]
        
      # 1st change the IndexId of focal series to the compared one
      for(f in fields_IndexId){
        # f <- fields_IndexId[1]
        nuseds_final[cond_focal,f] <- unique(nuseds_final[cond_compare,f])
      }
        
      # 2nd sum MAX_ESTIMATE values for duplicated years
      SUMMED <- F
      yr_duplicated <- nuseds_final[cond_focal | cond_compare,]$Year[duplicated(nuseds_final[cond_focal | cond_compare,]$Year)]
      for(yr in yr_duplicated){
        # yr <- yr_duplicated[1]
        cond_here <- (cond_focal | cond_compare) & nuseds_final$Year == yr
        vals <- nuseds_final$MAX_ESTIMATE[cond_here]
        ESTIMATE_CLASSIFICATIONs <- nuseds_final$ESTIMATE_CLASSIFICATION[cond_here]
          
        if(any(!is.na(vals))){
          val <- sum(vals,na.rm = T)
          nuseds_final$MAX_ESTIMATE[cond_here] <- val
            
          # if indeed counts were added up (i.e. not just one value)
          if(sum(!is.na(vals)) > 1){
              
            SUMMED <- T
          
            # define ESTIMATE_CLASSIFICATION: select the value corresponding to the higher MAX_ESTIMATE
            val <- ESTIMATE_CLASSIFICATIONs[vals == max(vals, na.rm = T)]
            nuseds_final$ESTIMATE_CLASSIFICATION[cond_here] <- val
          }
        }
      }
        
      # 3rd remove the rows with duplicated years in the focal
      cond_toDelete <- cond_focal & nuseds_final$Year %in% yr_duplicated
      nuseds_final <- nuseds_final[!cond_toDelete,]
        
      plot_IndexId_GFE_ID_fun(IndexIds = IndexId_here,
                              GFE_IDs = rep(GFE_ID_here,length(IndexId_here)),
                              all_areas_nuseds = nuseds_final, main = "")
      mtext(text = paste("CU_NAME:",CU_NAME_here), side = 3, line = 1,adj = 0)
      mtext(text = "AFTER", side = 3, line = 1,adj = 1, cex = 1.2, font = 2)
      legend("top",legend = POPULATION_here,bty = 'n')
        
      if(SUMMED){
        legend("topright",legend = "MERGED & SUMMED",bty = 'n')
      }else{
        legend("topright",legend = "MERGED",bty = 'n')
      }

      #
      if(SUMMED){
        print("Below is MAX_ESTIMATE and ESTIMATE_CLASSIFICATION for the data points summed:")
        print(show)
      }
      
      removed <- data.frame(IndexId = IndexId_focal,
                            GFE_ID = GFE_ID_here)
      removed$dataset <- "nuseds_final"
      removed$comment <- paste0("Series merged by summing to series ",IndexId_compare," & GFE_ID = ",GFE_ID_here," of the same CU: ",CU_NAME_here)
      removed_all_new <- rbind(removed_all_new,removed)

    }
    count <- count + 1
    print("***")
  }
}

removed_all <- rbind(removed_all,removed_all_new)
removed_all <- unique(removed_all)
```

# Export datasets

The following files are exported:

-   *1_NuSEDS_escapement_data_collated_DATE.csv*: the cleaned combined **NUSEDS** and **CUSS** datasets

-   *1_series_inNUSEDS_noInCUSS_DATE.csv*: information about the series in **NUSEDS** and not in **CUSS**

-   *1_series_removed_DATE.csv*: the series removed from either **NUSEDS** or **CUSS** and why

-   *1_series_added_DATE.csv*: the series added to either **NUSEDS** or **CUSS** and why


```{r, include=FALSE}
if(export_datasets){
  
  date <- as.character(Sys.Date())
  
  # Export the merged and cleaned NuSEDS data
  name_file <- paste0("1_NuSEDS_escapement_data_collated_",date)
  write.csv(nuseds_final,paste0(wd_output,"/archive/",name_file,".csv"),
            row.names = F)
  
  #' Export the series in NUSEDS with IndexIds and GFE_IDs not in CUSS with 
  #' info on the number of data points and POPULATION
  
  cond <- trackRecord_nuseds$alternative_GFE_ID == "none" &
    trackRecord_nuseds$alternative_IndexId == "none"
  
  trackRecord_toExport <- trackRecord_nuseds[cond,c("IndexId","GFE_ID","nb_dataPt")]
  
  trackRecord_toExport$POP_ID <- apply(X = trackRecord_toExport, 1, 
                                       FUN = function(r){
                                         iid <- r["IndexId"]
                                         popid <- strsplit(x = iid, split = "_")[[1]][2]
                                         return(popid)
                                       })
  
  trackRecord_toExport$POPULATION <- apply(X = trackRecord_toExport, 1, 
                                           FUN = function(r){
                                             iid <- r["IndexId"]
                                             gfeid <- r["GFE_ID"]
                                             cond <- all_areas_nuseds_all$IndexId == iid &
                                               all_areas_nuseds_all$GFE_ID == gfeid
                                             return(unique(all_areas_nuseds_all$POPULATION[cond]))
                                           })
  
  trackRecord_toExport$POP_ID <- sapply(X = trackRecord_toExport$IndexId, 
                                        FUN = function(iid){strsplit(x = iid,split = "_")[[1]][2]})
  
  trackRecord_toExport$species_acro <- sapply(X = trackRecord_toExport$IndexId, 
                                              FUN = function(iid){strsplit(x = iid,split = "_")[[1]][1]}) 
  
  trackRecord_toExport <- trackRecord_toExport[,c("IndexId","POP_ID","species_acro",
                                                  "GFE_ID","nb_dataPt","POPULATION")]
  
  write.csv(trackRecord_toExport,paste0(wd_output,"/archive/1_series_inNUSEDS_noInCUSS_",date,".csv"),
            row.names = F)
  
  
  #' Export the CUs removed and those added:
  removed_all$POP_ID <- sapply(X = removed_all$IndexId, 
                               FUN = function(iid){strsplit(x = iid,split = "_")[[1]][2]})
  
  removed_all$species_acro <- sapply(X = removed_all$IndexId, 
                                     FUN = function(iid){strsplit(x = iid,split = "_")[[1]][1]}) 
  
  removed_all <- removed_all[,c("IndexId","POP_ID","species_acro","GFE_ID","dataset","comment")]
  
  write.csv(removed_all,paste0(wd_output,"/archive/1_series_removed_",date,".csv"),row.names = F)
  
  #
  added_all$POP_ID <- sapply(X = added_all$IndexId, 
                             FUN = function(iid){strsplit(x = iid,split = "_")[[1]][2]})
  
  added_all$species_acro <- sapply(X = added_all$IndexId, 
                                   FUN = function(iid){strsplit(x = iid,split = "_")[[1]][1]}) 
  
  added_all <- added_all[,c("IndexId","POP_ID","species_acro","CU_NAME","GFE_ID","dataset","comment")]
  
  
  write.csv(added_all,paste0(wd_output,"/archive/1_series_added_",date,".csv"),row.names = F)
  
}
```
